(()=>{"use strict";function e(t,r){return e=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},e(t,r)}function t(t,r){t.prototype=Object.create(r.prototype),t.prototype.constructor=t,e(t,r)}let r=function(){function e(e={}){this.dropAreaSelector=e.dropAreaSelector||".j-media-upload-dnd",this.dropAreaSelectorClassName=this.dropAreaSelector.replace(".",""),this.dropArea=null,this.dropCss=e.dropCss||"hover-dnd",this.loadMediaFunc=e.loadMediaFunc||function(){},this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._onDragEnter.bind(this),this._onDragLeave=this._onDragLeave.bind(this),this._onDrop=this._onDrop.bind(this),this.checkCanAddMedia=e.canAddMedia,this.isAllowedAddDropClass=!0}var t=e.prototype;return t.init=function(e){this.container=e||document,this.dropArea=this.container.querySelector(this.dropAreaSelector),this._bindEvents()},t.destroy=function(){this._unbindEvents()},t._onDragOver=function(e){e.preventDefault(),e.stopPropagation(),this.canAddMedia&&this.isAllowedAddDropClass&&this.dropCss&&(this.dropCss&&e.currentTarget.classList.add(this.dropCss),$.observable(this).setProperty({isAllowedAddDropClass:!1}))},t._onDragEnter=function(e){e.preventDefault(),e.stopPropagation(),this.canAddMedia=this.checkCanAddMedia(),this.canAddMedia&&this.dropCss&&e.currentTarget.classList.add(this.dropCss)},t._onDragLeave=function(e){e.preventDefault(),e.stopPropagation(),!this.isAllowedAddDropClass&&this.dropCss&&(e.currentTarget.classList.remove(this.dropCss),$.observable(this).setProperty({isAllowedAddDropClass:!0}))},t._onDrop=function(e){if(e.preventDefault(),this.dropCss&&(this.dropCss&&e.currentTarget.classList.remove(this.dropCss),$.observable(this).setProperty({isAllowedAddDropClass:!0})),!this.canAddMedia)return;const t=e.dataTransfer.files;this.loadMediaFunc(t)},t._bindEvents=function(){this.dropArea&&(this.dropArea.addEventListener("dragover",this._onDragOver),this.dropArea.addEventListener("dragenter",this._onDragEnter),this.dropArea.addEventListener("dragleave",this._onDragLeave),this.dropArea.addEventListener("drop",this._onDrop))},t._unbindEvents=function(){this.dropArea&&(this.dropArea.removeEventListener("dragover",this._onDragOver),this.dropArea.removeEventListener("dragenter",this._onDragEnter),this.dropArea.removeEventListener("dragleave",this._onDragLeave),this.dropArea.removeEventListener("drop",this._onDrop))},e}(),o=function(e){function o(t){var r,o;return(r=e.call(this)||this).maxItemsCount=t.maxItemsCount,r.maxTotalSize=t.maxTotalSize,r.maxVideoDuration=t.maxVideoDuration,r.supportedExtensions=t.supportedExtensions,r.uploadLimit=t.uploadLimit,r.requalitySizeLimit=null!==(o=t.requalitySizeLimit)&&void 0!==o?o:0,r.minWidth=t.minWidth,r.minHeight=t.minHeight,r.messages=t.messages,r.dontObserve=t.dontObserve,r.useDnD=t.useDnD,r}t(o,e);var s=o.prototype;return s.removeItem=function(e){$.observable(this.items).remove(e)},s.init=function(e){var t;null===(t=this.moduleDnD)||void 0===t||t.init(e)},s.destroy=function(){var e;null===(e=this.moduleDnD)||void 0===e||e.destroy()},s.canAddMedia=function(){return this.items.length<this.maxItemsCount},s._createModuleDnD=function(e){if(this.useDnD){const t=`.j-upload-dnd-${e.postfixDnD||"media"}`;this.moduleDnD=new r({dropAreaSelector:t,loadMediaFunc:e.loadMediaFunc,canAddMedia:e.canAddMedia})}},s._getErrorMsg=function(e,t=[]){switch(e){case this.messages.filesLimitReached:const r=t[0]||"1";return String.format(e,r,this.maxItemsCount);case this.messages.wrongFileSize:const o=Math.round(this.uploadLimit/1024/1024);return String.format(e,o);case this.messages.wrongFileExtension:return String.format(e,this.supportedExtensions.join(", "));case this.messages.wrongImageResolution:return String.format(e,this.minWidth,this.minHeight);case this.messages.errorImageLoad:return String.format(e);case this.messages.severalErrors:const s=t[0]||"1";return String.format(e,s);case this.messages.wrongVideoResolution:return String.format(e,this.minWidth,this.minHeight);case this.messages.errorVideoLoad:return String.format(e);case this.messages.wrongVideoDuration:const i=Math.round(this.maxVideoDuration/60);return String.format(e,i);default:return String.format(e||"",...t)}},s._validateFile=function(e,t){let r,o=!0,s=null;const i=e.name.split(".").pop().toLowerCase();return this.items.length>=this.maxItemsCount&&(s=this.messages.filesLimitReached),this.uploadLimit>0&&e.size>this.uploadLimit&&(s=this.messages.wrongFileSize),this.supportedExtensions.some((e=>e==i))||(s=this.messages.wrongFileExtension),s&&(e.errorInfo={type:s},r=this._getErrorMsg(s),o=!1,t(r)),o},o}(WbSpaModel),s=function(e){function r(t,r){var o,s,i;t=Object.assign({maxItemsCount:0,useCropper:!0,minWidth:337,minHeight:450,uploadLimit:31457280,supportedExtensions:["jpg","jpeg","png","bmp","gif"],messages:{wrongFileSize:"Фото не загрузилось. Размер превышает {0}&nbsp;мб, загрузите файл меньше",wrongFileExtension:"Поддерживаются только следующие расширения файлов «{0}»",filesLimitReached:"Вы можете загрузить не более {0}&nbsp;изображений",wrongImageResolution:"Разрешение изображения должно быть не&nbsp;менее&nbsp;{0}&nbsp;px&nbsp;по&nbsp;ширине и&nbsp;{1}&nbsp;px&nbsp;по&nbsp;высоте",errorImageLoad:"Не удалось загрузить фото, попробуйте&nbsp;еще&nbsp;раз"}},t);const n={postfixDnD:"img",loadMediaFunc:(o=e.call(this,t)||this).loadImageDnDAsync.bind(o),canAddMedia:o.canAddMedia.bind(o)};return o._createModuleDnD(n),o.items=[],o.itemsIds=[],o.files=[],o.useCropper=null===(s=t.useCropper)||void 0===s||s,o.wbaStat=t.wbaStat,o.requestInfo=null==r?void 0:r.requestInfo,o.requestService=null==r?void 0:r.requestService,o.useRequestService=!!(null===(i=o.requestService)||void 0===i?void 0:i.saveImages),o.imagesError=null,o.photosAreUploading=!1,o.cropperModule=null,o.promisifiedFileReader=null,o._loadModules(),o.fetchPhoto=o.fetchPhoto.bind(o),o}t(r,e);var o=r.prototype;return o._loadModules=async function(){try{const[e,t]=await Promise.all([this.$moduleLoader.loadModuleAsync("promisifiedFileReader"),this.$moduleLoader.loadModuleAsync("cropper")]);this.promisifiedFileReader=new e,this.cropperModule=t}catch(e){console.error("Failed to load modules - 'Cropper' and 'PromisifiedFileReader':",e)}},o.removeItem=function(t){var r,o;e.prototype.removeItem.call(this,t),this.files.splice(t,1),this.useRequestService&&$.observable(this.itemsIds).remove(t),null===(o=null===(r=this.wbaStat)||void 0===r?void 0:r.onRemove)||void 0===o||o.call(r),0===this.items.length&&$.observable(this).setProperty({photosAreUploading:!1,imagesError:null}),this._blockSaveImgBtn(!1)},o.totalSize=function(e=0){return this.files.reduce(((e,t)=>(t.serverSize||t.size)+e),e)},o.loadImageDnDAsync=async function(e){return this._loadImagesAsync([...e])},o.loadImageAsync=async function(e,t=!1){const r=[...e.target.files];return e.target.value=null,this._loadImagesAsync(r,t)},o._getFilesLoaderProcesser=function(e){const t=e.length,r=this.maxItemsCount-this.items.length,o={errors:[],isTooManyFiles:e.length>r},s=()=>{o.isTooManyFiles=!0},i=(e,t)=>{o.errors.push({errorMessage:e,errorType:t||e})};let n=e.slice(0,10);this.processingImage=!0;const a=()=>!this.processingImage&&{canselUpload:!0};let l=!1;const d=()=>{var e;if(!(null===(e=o.errors)||void 0===e?void 0:e.length)&&!o.isTooManyFiles)return"";const r=t-n.length,s=(()=>{const e=o.errors[0].errorType;let t=!1,r=1;for(;r<o.errors.length&&!t;){t=e!==o.errors[r].errorType,r++}return t})();if(1==o.errors.length||!s){const e=o.errors[0];return e.errorMessage||this._getErrorMsg(e.errorType,[r])}return o.isTooManyFiles&&!s?this._getErrorMsg(this.messages.filesLimitReached,[r]):this._getErrorMsg(this.messages.severalErrors,[r])},h=(e,t,o)=>{if(!(null==e?void 0:e.data)){n=[];const o=this._getImagesErrorType(e),s=o===this.messages.errorImageLoad?t.slice(0,r):[];return t.forEach((e=>{i(null,o),e.uploading&&$.observable(e).setProperty({loadingError:!0,uploading:!1})})),{isAllSuccessed:!1,resultPhotos:s,errorMessage:d()}}let a=[];const l=[],h=[];if(e.data.forEach(((e,n)=>{const d=t[n];if(!d)return;const u=a.length<r;if(e.id&&u)a.push(d),$.observable(this.itemsIds).insert(e.id);else{const t=e.id?this.messages.filesLimitReached:this._getImagesErrorType(e);t==this.messages.filesLimitReached&&s(),$.observable(d).setProperty({loadingError:!0}),i(null,t),h.push(n),(e.serverError||o)&&l.push(d)}$.observable(d).setProperty({uploading:!1})})),h.length>0)for(let e=h.length-1;e>=0;e--)n.splice(h[e],1);if(l.length&&a.length<r){const e=r-a.length;a=a.concat(l.slice(0,e))}const u=d();return{errorMessage:u,isAllSuccessed:!(null==u?void 0:u.length),resultPhotos:a}};return{firstValidationStep:()=>{if(l=a(),l)return l;$.observable(this).setProperty({photosAreUploading:!0});const e=[];if(n.forEach(((t,r)=>{this._validateFile(t,(o=>{const n=t.errorInfo.type;n==this.messages.filesLimitReached&&s(),i(o,n),e.push(r)}))})),e.length>0)for(let t=e.length-1;t>=0;t--)n.splice(e[t],1);const t=!n.length;return l=a(),l||{isAllFailed:t,errorMessage:t?d():""}},secondValidationStep:async()=>{if(l=a(),l)return l;const e=[],t=async(t,r)=>{const o=await this.promisifiedFileReader.readAsDataURLIndependent(t),s=await this._validateImageSize(o);return s.isValid?(t.serverSize=s.value.length,this.maxTotalSize>0&&!this.useCropper&&this.totalSize(t.serverSize||t.size)>this.maxTotalSize?(i("Превышен максимально допустимый размер всех файлов"),e.push(r),!1):(this.files.push(t),s.index=this.files.length-1,t.validationState=s,!0)):(i(s.error,s.errorType),e.push(r),!1)},r=n.map(((e,r)=>t(e,r)));if(await Promise.all(r),e.length>0)for(let t=e.length-1;t>=0;t--)n.splice(e[t],1);const o=!n.length;return l=a(),l||{isAllFailed:o,errorMessage:o?d():""}},fetchPhotoMultiple:async(e={})=>{var t;if(l=a(),l)return l;e.isReload&&(n=e.filesData.map((e=>{const t={validationState:{value:e.url}};return e.photoObject&&(t.photoObject=e.photoObject),t})));const r=new AbortController,o=r.signal;this.abortControllerData={abortController:r,signal:o};const s=n.map((e=>{let t={};return e.photoObject?(t=e.photoObject,t.abortController&&t.abortController.abort(),t.abortController=r,t.signal=o,$.observable(t).setProperty({uploading:!0,loadingError:!1})):t={urlData:e.validationState.value,uploading:!0,loadingError:!1,abortController:r,signal:o},t})),i={userPhotos:n.map((e=>this._toBlob(e.validationState.value))),sellerId:this.requestInfo.sellerId,feedBacksProduct:this.requestInfo.feedBacksProduct},d=await this.requestService.saveImages(i,o),u=h(d,s,e.isReload);return o.aborted?{canselUpload:!0}:(this.abortControllerData=null,e.isReload||null===(t=u.resultPhotos)||void 0===t||t.forEach((e=>{$.observable(this.items).insert(e)})),{isAllFailed:u.isAllFailed,errorMessage:u.errorMessage,isAllSuccessed:!!u.isAllSuccessed})}}},o._getImagesErrorType=function(e){if(!e)return this.messages.errorImageLoad;if(e.serviceErrorCode){if("2"==e.serviceErrorCode)return this.messages.filesLimitReached;if("12"==e.serviceErrorCode)return this.messages.wrongFileExtension;if("13"==e.serviceErrorCode)return this.messages.wrongFileSize}return this.messages.errorImageLoad},o._toBlob=function(e){const[t,r,o]=/^data:(.*?);base64,(.*)$/.exec(e);return new Blob([new Uint8Array(atob(o).split("").map((e=>e.charCodeAt(0))))],{type:r})},o._loadImagesAsync=async function(e,t=!1){var r,o,s,i;if(e&&!Array.isArray(e)&&(e=[e]),!e||0==e.length)return!1;const n=this._getFilesLoaderProcesser(e),a=n.firstValidationStep(),l=e=>{t?this.$moduleLoader.execModule("bottomNotificationPanel","showNotification",[0,e,"action-notification--error"]):$.observable(this).setProperty({imagesError:e})};if(a.canselUpload)return!1;if(a.isAllFailed)return l(a.errorMessage),$.observable(this).setProperty({photosAreUploading:!1}),!1;try{const t=await n.secondValidationStep();if(t.canselUpload)return!1;if(t.isAllFailed)return l(t.errorMessage),$.observable(this).setProperty({photosAreUploading:!1}),!1;if(!this.useDnD){const t=e[0];return this.useCropper?this._showPopupAsync(t.validationState.value,t.type,this.cropperModule):($.observable(this.items).insert(t.validationState.value),null===(o=null===(r=this.wbaStat)||void 0===r?void 0:r.onUpload)||void 0===o||o.call(r)),t.validationState}const a=await n.fetchPhotoMultiple();if(a.canselUpload)return;a.isAllSuccessed?$.observable(this).setProperty({imagesError:null}):$.observable(this).setProperty({imagesError:a.errorMessage}),$.observable(this).setProperty({photosAreUploading:!1}),null===(i=null===(s=this.wbaStat)||void 0===s?void 0:s.onUpload)||void 0===i||i.call(s)}catch(e){console.log(e.message);const t=this._getErrorMsg(this.messages.errorImageLoad);$.observable(this).setProperty({imagesError:t}),wb.popup.renderModalError("Critical Error")}},o.rotate=function(e,t){t.preventDefault();const r=document.createElement("canvas"),o=r.getContext("2d"),s=this.cropper.element;r.width=s.height,r.height=s.width,o.translate(r.width/2,r.height/2),o.rotate(e*Math.PI/180),o.drawImage(s,-s.width/2,-s.height/2);const i=r.toDataURL("image/jpeg");this.cropper.replace(i)},o._blockSaveImgBtn=function(e){$.observable(this).setProperty({blockSaveImgBtn:e})},o.saveImageResult=async function(e){var t,r,o;if(e.preventDefault(),this.blockSaveImgBtn)return;this._blockSaveImgBtn(!0),this.popup.close();const s=this.cropper.getCroppedCanvas(),i=null!==(t=this.cropper.fileType)&&void 0!==t?t:"image/jpeg";let n=s.toDataURL(i);if(this.requalitySizeLimit>0){const e=Math.round(3*n.length/4-`data:${i};base64,`.length);e>this.requalitySizeLimit&&(n=s.toDataURL(i,Math.max(.3,this.requalitySizeLimit/e)));if(Math.round(3*n.length/4-`data:${i};base64,`.length)>this.requalitySizeLimit)return void $.observable(this).setProperty({imagesError:"Слишком большой размер файла, попробуйте уменьшить размер изображения"})}this.useRequestService?await this.fetchPhoto(n):$.observable(this.items).insert({urlData:n}),this._blockSaveImgBtn(!1),null===(o=null===(r=this.wbaStat)||void 0===r?void 0:r.onUpload)||void 0===o||o.call(r)},o.fetchPhoto=async function(e,t=null){var r,o,s,i;if(!e)return!1;const n=this._getFilesLoaderProcesser([e]),a=await n.fetchPhotoMultiple({isReload:!0,urlsOnly:!0,filesData:[{url:e,photoObject:t}]});a.isAllSuccessed?$.observable(this).setProperty({imagesError:null}):$.observable(this).setProperty({imagesError:null!==(r=a.errorMessage)&&void 0!==r?r:"Фото не загрузилось, попробуйте еще раз"}),this._blockSaveImgBtn(!1),null===(s=null===(o=this.wbaStat)||void 0===o?void 0:o.onUpload)||void 0===s||s.call(o),null===(i=this.popup)||void 0===i||i.close()},o.destroy=function(){var t;e.prototype.destroy.call(this),this.items.forEach((e=>{e.abortController&&(e.abortController.abort(),e.abortController=null,e.signal=null)})),this.files=[],this.items=[],null===(t=this.cropper)||void 0===t||t.destroy()},o._showPopupAsync=function(e,t,r){r&&(this.imgSrc=e,this.popup=wb.popup.showCustomPopup({useHtml:!0,popupClassesList:["popup-image-crop","shown"],contentClasses:["popup__content"],useCenteredFunction:!0,onShow:e=>{r.template.link(e.querySelector(".popup__content"),this),this.$helper.nextTick().then((()=>{this.cropper=new r(e.querySelector(".j-cropper-image"),{aspectRatio:"auto",viewMode:1,minCropBoxWidth:337,minCropBoxheight:450,zoomable:!1,modal:!1,guides:!1,background:!1,center:!1}),this.cropper.fileType=t}))}}))},o._validateImageSize=function(e){return new Promise((t=>{const r=new Image;r.onload=()=>{let o;if((r.width<this.minWidth||r.height<this.minHeight)&&t({isValid:!1,error:this._getErrorMsg(this.messages.wrongImageResolution),errorType:this.messages.wrongImageResolution}),this.requalitySizeLimit>0){const s="image/jpeg";if(o=this._getApproximateSize(e,s),o>this.requalitySizeLimit){const i=document.createElement("canvas"),n=i.getContext("2d");if(i.width=r.width,i.height=r.height,n.drawImage(r,0,0),e=i.toDataURL(s,Math.max(.3,this.requalitySizeLimit/o)),o=this._getApproximateSize(e,s),o>this.requalitySizeLimit){const e=this.useDnD?this._getErrorMsg(this.messages.wrongFileSize):"Слишком большой размер файла, попробуйте уменьшить размер изображения";t({isValid:!1,error:e,errorType:this.useDnD?this.messages.wrongImageResolution:""})}}}t({isValid:!0,value:e,imageSize:o})},r.src=e}))},o._getApproximateSize=function(e,t){return Math.round(3*e.length/4-`data:${t};base64,`.length)},r}(o),i=function(e){function r(t,r){var o,s;t=Object.assign({maxItemsCount:1,uploadLimit:524288e3,messages:{wrongFileSize:"Видео не загрузилось. Размер превышает {0}&nbsp;мб, загрузите файл&nbsp;меньше",wrongFileExtension:"Поддерживаются только следующие расширения файлов «{0}»",filesLimitReached:"Вы можете загрузить не&nbsp;более&nbsp;{0}&nbsp;видео",wrongVideoResolution:"Разрешение видео должно быть не&nbsp;менее&nbsp;{0}px&nbsp;по&nbsp;ширине и&nbsp;{1}px&nbsp;по&nbsp;высоте",errorVideoLoad:"Видео не загрузилось, попробуйте&nbsp;еще&nbsp;раз"}},t);const i={postfixDnD:"video",loadMediaFunc:(o=e.call(this,t)||this).loadVideoDnDAsync.bind(o),canAddMedia:o.canAddMedia.bind(o)};return o._createModuleDnD(i),o.items=[],o.videoDuration=null,o.videoPosterSrc=null,o.videoIsUploading=!1,o.videoError=null,o.videoId=null,o.abortController=null,o.signal=null,o.requestInfo=null==r?void 0:r.requestInfo,o.requestService=null==r?void 0:r.requestService,o.useRequestService=null===(s=o.requestService)||void 0===s?void 0:s.saveVideo,o.fetchVideo=o.fetchVideo.bind(o),o}t(r,e);var o=r.prototype;return o._roundTheNumber=function(e){const t=Math.floor(e);return e-t>=.5?t+1:t},o.clearController=function(){this.abortController&&(this.abortController.abort(),this.signal=null,this.abortController=null)},o.clearFile=function(){this.files=[],this.items=[]},o.removeItem=function(){e.prototype.removeItem.call(this,0),this.abortController&&this.clearController(),$.observable(this).setProperty({videoId:null})},o.destroy=function(){e.prototype.destroy.call(this),this.clearFile(),this.abortController&&this.clearController()},o.loadVideoDnDAsync=async function(e){return this._loadVideoAsync(e)},o.loadVideoAsync=async function(e){const t=[...e.target.files];return e.target.value=null,this._loadVideoAsync(t)},o._getFilesLoaderProcesser=function(e){const t=(e=[...e]).length,r=this.maxItemsCount-this.items.length,o={errors:[],isTooManyFiles:e.length>r},s=(e,t)=>{o.errors.push({errorMessage:e,errorType:t||e})};let i=e.slice(0,10);this.processingVideo=!0;const n=()=>!this.processingVideo&&{canselUpload:!0};let a=!1;const l=()=>{var e;if(!(null===(e=o.errors)||void 0===e?void 0:e.length)&&!o.isTooManyFiles)return"";const r=t-i.length;if((()=>{if(0===o.errors.length)return!1;if(o.isTooManyFiles)return!0;const e=o.errors[0].errorType;let t=!1,r=1;for(;r<o.errors.length&&!t;){t=e!==o.errors[r].errorType,r++}return t})())return this._getErrorMsg(this.messages.severalErrors,[r]);if(o.isTooManyFiles)return this._getErrorMsg(this.messages.filesLimitReached,[r]);if(1==o.errors.length){const e=o.errors[0];return e.errorMessage||this._getErrorMsg(e.errorType,[r])}},d=e=>{var t,r,o,i,n,a;if(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.id)return{errorMessage:l(),videoId:e.data.id};const d={errorType:this.messages.errorVideoLoad,errorMessage:null,loadingError:!0};return this.useRequestService&&((null===(r=null==e?void 0:e.data)||void 0===r?void 0:r.serverError)||(null==e?void 0:e.serverError))||("15"==(null===(o=null==e?void 0:e.data)||void 0===o?void 0:o.serviceErrorCode)?(d.errorType=this.messages.wrongFileExtension,d.loadingError=!1):result.errorMessage=(null===(i=null==e?void 0:e.data)||void 0===i?void 0:i.error.message)||(null===(n=null==e?void 0:e.data)||void 0===n?void 0:n.errorText)||(null===(a=null==e?void 0:e.data)||void 0===a?void 0:a.error)||(null==e?void 0:e.errorText)||""),s(d.errorMessage,d.errorType),{errorMessage:l(),loadingError:d.loadingError}};return{firstValidationStep:()=>{if(a=n(),a)return a;$.observable(this).setProperty({videoIsUploading:!0,videoError:null});const e=[];if(i.forEach(((t,r)=>{this._validateFile(t,(i=>{const n=t.errorInfo.type;n==this.messages.filesLimitReached&&(o.isTooManyFiles=!0),s(i,n),e.push(r)}))})),e.length>0)for(let t=e.length-1;t>=0;t--)i.splice(e[t],1);const t=!i.length;return a=n(),a||{isAllFailed:t,errorMessage:t?l():""}},secondValidationStep:async()=>{if(a=n(),a)return a;const e=[];let t=null;const r=async(r,o)=>{const i=document.createElement("video"),n=document.createElement("canvas");i.src=URL.createObjectURL(r),i.muted=!0;const a=await new Promise((e=>{i.addEventListener("loadedmetadata",(()=>{this.videoDuration=this._roundTheNumber(i.duration),i.currentTime=i.duration/3})),i.addEventListener("error",(t=>{const r=this.messages.errorVideoLoad?this._getErrorMsg(this.messages.errorVideoLoad):"Видео не загрузилось, попробуйте еще раз";e({error:r,loadingError:!0})}));const t=()=>{if(i.currentTime>=i.duration/3-.1&&i.currentTime<=i.duration/3+.1)if(this.videoDuration>120){$.observable(this.videoUploader).setProperty({items:[],videoDuration:null,videoId:null});const t=this.messages.wrongVideoDuration&&this.maxVideoDuration?this._getErrorMsg(this.messages.wrongVideoDuration):"Видео не загрузилось: продолжительность больше&nbsp;2&nbsp;минут";e({error:t,loadingError:!1})}else n.width=i.videoWidth||64,n.height=i.videoHeight||86,r();else setTimeout(t,100)},r=()=>{setTimeout((()=>{n.getContext("2d").drawImage(i,0,0,i.videoWidth||64,i.videoHeight||86),n.toBlob((t=>{const r=new FileReader;r.onloadend=()=>{const t=r.result;$.observable(this).setProperty({videoPosterSrc:t}),e({})},r.onerror=e=>{reject(new Error("Error reading canvas blob"))},r.readAsDataURL(t)}),"image/png")}),1500)};i.load(),t()}));return!(null==a?void 0:a.error)||(a.loadingError?s(a.error,this.messages.errorVideoLoad):s(a.error),e.push(o),!t&&a.loadingError&&(t=r),!1)},o=i.map(((e,t)=>r(e,t)));if(await Promise.all(o),e.length>0){e.sort();for(let t=e.length-1;t>=0;t--)i.splice(e[t],1)}const d=!i.length;return a=n(),a||{isAllFailed:d,errorMessage:d?l():"",resultFile:t}},fetchPhotoMultiple:async(e={})=>{if(a=n(),a)return a;e.isReload&&$.observable(this).setProperty({loadingError:!1}),this.clearController(),this.abortController=new AbortController,this.signal=this.abortController.signal,i=i.slice(0,1);const t=i[0],r={userVideos:[t],sellerId:this.requestInfo.sellerId,feedBacksProduct:this.requestInfo.feedBacksProduct};if(!this.processingVideo)return;$.observable(this).setProperty({videoError:null,videoIsUploading:!0});const o=await this.requestService.saveVideo(r,this.signal),s=d(o);return this.signal.aborted?{canselUpload:!0}:(this.abortControllerData=null,s.loadingError&&($.observable(this.items).insert(t),$.observable(this).setProperty({loadingError:!0})),{videoId:s.videoId,errorMessage:s.errorMessage,resultFile:t})}}},o._loadVideoAsync=async function(e){if(!e)return!1;$.observable(this).setProperty({videoIsUploading:!0,loadingError:!1});const t=this._getFilesLoaderProcesser(e),r=t.firstValidationStep(),o=e=>{$.observable(this).setProperty({videoError:e})};if(r.canselUpload)return!1;if(r.isAllFailed)return $.observable(this).setProperty({videoError:r.errorMessage,videoIsUploading:!1}),!1;this.useRequestService||$.observable(this.items).insert(e[0]);const s=await t.secondValidationStep();if(s.canselUpload)return!1;if(s.isAllFailed)return o(s.errorMessage),$.observable(this).setProperty({videoIsUploading:!1}),s.resultFile&&($.observable(this.items).insert(secondValidationStep.resultFile),$.observable(this).setProperty({loadingError:!0})),!1;if(!this.useRequestService)return void $.observable(this).setProperty({videoIsUploading:!1});const i=await t.fetchPhotoMultiple();i.canselUpload||(i.videoId?($.observable(this.items).insert(i.resultFile),$.observable(this).setProperty({videoId:i.videoId,videoError:null}),i.errorMessage&&$.observable(this).setProperty({videoError:i.errorMessage})):$.observable(this).setProperty({videoError:i.errorMessage}),$.observable(this).setProperty({videoIsUploading:!1}))},o.loadVideoAsyncDesktop=async function(e,t){const r=e.target.files[0];if(e.target.value=null,null==r||!this._validateVideoFile(r))return;$.observable(this.items).insert(r),$.observable(this).setProperty({videoIsUploading:!0});const o=document.createElement("video"),s=document.createElement("canvas"),i=s.getContext("2d");o.src=URL.createObjectURL(r),o.muted=!0;const n=await new Promise((e=>{o.addEventListener("loadedmetadata",(()=>{this.videoDuration=this._roundTheNumber(o.duration),o.currentTime=o.duration/3})),o.addEventListener("error",(t=>{$.observable(this).setProperty({items:[]}),e({error:this._getErrorMsg(this.messages.errorVideoLoad)})})),o.addEventListener("seeked",(()=>{setTimeout((()=>{if(this.videoDuration>120){this.items=[],this.videoDuration=null,this.videoId=null;const t=this.messages.wrongVideoDuration&&this.maxVideoDuration?this._getErrorMsg(this.messages.wrongVideoDuration):"Видео не загрузилось: продолжительность больше 2 минут";$.observable(this).setProperty({videoError:t}),e({error:t})}else $.observable(this).setProperty({videoError:null}),e({});s.width=o.videoWidth||64,s.height=o.videoHeight||86,i.drawImage(o,0,0,o.videoWidth||64,o.videoHeight||86),$.observable(this).setProperty({videoPosterSrc:s.toDataURL()})}),500)}))}));(null==n?void 0:n.error)?($.observable(this).setProperty({videoError:n.error}),$.observable(this).setProperty({videoId:null}),$.observable(this).setProperty({videoIsUploading:!1})):this.useRequestService&&await this.fetchVideo(r,{filesLimitErrorMessage:t})},o._validateVideoFile=function(e){return this._validateFile(e,(e=>{$.observable(this).setProperty({videoError:e})}))},o.fetchVideo=async function(e){$.observable(this).setProperty({loadingError:!1});const t=this._getFilesLoaderProcesser([e]),r=await t.fetchPhotoMultiple();r.canselUpload||(r.videoId?($.observable(this.items).insert(r.resultFile),$.observable(this).setProperty({videoId:r.videoId,videoError:null})):$.observable(this).setProperty({videoError:r.errorMessage}),$.observable(this).setProperty({videoIsUploading:!1}))},o._getVideoErrorType=function(e){return"15"==(null==e?void 0:e.serviceErrorCode)?this.messages.wrongFileExtension:this.messages.errorVideoLoad},o.loadVideoWithThumbAsync=function(e){return"phone"===wb.settings.displayType?this.loadVideoWithThumbAsyncMobile(e):this.loadVideoWithThumbAsyncDesktop(e)},o.loadVideoWithThumbAsyncMobile=function(e){return new Promise(((t,r)=>{const o=e.target.files[0];e.target.value=null,null!=o&&this._validateFile(o,(e=>this.$moduleLoader.execModule("bottomNotificationPanel","showNotification",[0,e,"action-notification--error"])))||r(new KnownServerError("wrong file"));const s=document.createElement("video"),i=document.createElement("canvas");s.onloadedmetadata=()=>{s.width=s.videoWidth,s.height=s.videoHeight,i.width=s.videoWidth,i.height=s.videoHeight,s.currentTime=s.duration/3},s.onerror=()=>{const e=this.messages.errorVideoLoad?this._getErrorMsg(this.messages.errorVideoLoad):"Видео не загрузилось, попробуйте еще раз";this.$moduleLoader.execModule("bottomNotificationPanel","showNotification",[0,e,"action-notification--error"]),r()};const n=()=>{s.currentTime>=s.duration/3-.1&&s.currentTime<=s.duration/3+.1?a():setTimeout(n,100)},a=()=>{setTimeout((()=>{i.getContext("2d").drawImage(s,0,0,s.videoWidth,s.videoHeight),i.toBlob((e=>{const s=new FileReader;s.onloadend=()=>{const e=s.result;t({file:o,thumbnail:e})},s.onerror=e=>{r(new Error("Error reading canvas blob"))},s.readAsDataURL(e)}),"image/png")}),1500)};s.src=URL.createObjectURL(o),s.load(),n()}))},o.loadVideoWithThumbAsyncDesktop=function(e){return new Promise((async(t,r)=>{const o=e.target.files[0];e.target.value=null,null!=o&&this._validateFile(o,(e=>this.$moduleLoader.execModule("bottomNotificationPanel","showNotification",[0,e,"action-notification--error"])))||r(new KnownServerError("wrong file"));const s=document.createElement("video"),i=document.createElement("canvas");try{await new Promise(((e,t)=>{s.addEventListener("loadedmetadata",(()=>{s.width=s.videoWidth,s.height=s.videoHeight,i.width=s.videoWidth,i.height=s.videoHeight,s.currentTime=s.duration/3})),s.addEventListener("error",(()=>{const e=this.messages.errorVideoLoad?this._getErrorMsg(this.messages.errorVideoLoad):"Видео не загрузилось, попробуйте еще раз";this.$moduleLoader.execModule("bottomNotificationPanel","showNotification",[0,e,"action-notification--error"]),t()})),s.addEventListener("seeked",(()=>{setTimeout(e,500)})),s.src=URL.createObjectURL(o)})),i.getContext("2d").drawImage(s,0,0,s.videoWidth,s.videoHeight),t({file:o,thumbnail:i.toDataURL("image/png")})}catch(e){r()}}))},r}(o);window.__spaModuleManager__.register("imageUploader",{ImageUploader:s,VideoUploader:i})})();
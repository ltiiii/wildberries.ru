/*! For license information please see onlineChatPopup.f2c42b2093524d6959e0.js.LICENSE.txt */
(()=>{"use strict";var t={85322:()=>{$.fn.draggable=function(t,e){var s=this,i=$(t),n=0,r=0;function o(t){t.preventDefault(),n=t.clientX,r=t.clientY,$(document).on("mousemove",a).on("mouseup",h)}function a(t){t.preventDefault();var e=s[0].offsetTop-r+t.clientY,i=s[0].offsetLeft-n+t.clientX,o=function(t,e){var i=s[0].getBoundingClientRect(),o=document.documentElement.clientWidth||document.body.clientWidth||window.innerWidth,a=(document.documentElement.clientHeight||document.body.clientHeight||window.innerHeight,!0),h=!0;return i.top<0&&e<=r&&(a=!1),(i.left<0&&t<=n||i.right>o&&t>=n)&&(h=!1),{modifyTop:a,modifyLeft:h}}(t.clientX,t.clientY);o.modifyTop&&(s[0].style.top=e+"px"),o.modifyLeft&&(s[0].style.left=i+"px"),n=t.clientX,r=t.clientY}function h(t){t.preventDefault(),$(document).off("mousemove",a).off("mouseup",h),$.isFunction(e)&&e(s[0].style.left,s[0].style.top)}return i.on("mousedown",o),this}}},e={};function s(t){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},s(t)}function i(t){var e=function(t,e){if("object"!=s(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=s(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==s(e)?e:e+""}function n(t,e){for(var s=0;s<e.length;s++){var n=e[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,i(n.key),n)}}(function s(i){var n=e[i];if(void 0!==n)return n.exports;var r=e[i]={exports:{}};return t[i](r,r.exports,s),r.exports})(85322);const r=/^((https:\/\/chat-basket-0\d.)wb(.ru\/.*))$/;const o=function(){function t({ctx:t,message:e,attachment:s,messageIndex:i,attachmentIndex:n,imgCounter:o}){this.parentIndex=i,this.index=n;const{url:a,name:h,size:c}=s;this.url=null==a?void 0:a.replace(r,"$2wbbasket$3"),this.name=h,this.size=c,(null==e?void 0:e.dt)&&(this.dt=e.dt),this.ctx=t,this.imgCounter=o}var e=t.prototype;return e.goToMessage=function(t,e){if(t.preventDefault(),t.stopPropagation(),Number.isInteger(this.parentIndex)){$.observable(this.ctx).setProperty({isTabsOpen:!1}),this.ctx.closeSlider();const t=this.ctx.chat.querySelector(`.chat__message:nth-last-of-type(${this.parentIndex})`);t&&t.scrollIntoView()}},e.download=function(t,e){if(t.preventDefault(),!this.url)return;window.navigator&&window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveOrOpenBlob(blob,data.fileName);const s=(t,e)=>{const s=document.createElement("a");s.href=t,s.download=this.name||wb.helpers.path.fileName(this.url),s.onclick=t=>t.stopPropagation(),s.target="_blank",document.body.appendChild(s),s.click(),setTimeout((()=>{document.body.removeChild(s),e&&URL.revokeObjectURL(t)}),200)};return fetch(this.url).then((async t=>{const e=await t.blob();if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,data.fileName);else{const t=URL.createObjectURL(e);s(t,!0)}})).catch((()=>s(this.url,!1))),!1},t}(),a=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,h=$.templates("Возврат одобрен. Принесите товар в пункт выдачи, в котором его получали. {{if refundPrice > 0}}<b>{{priceWithCurrencyV2:refundPrice iso=currency}}</b>{{else}}Денежные средства{{/if}} вернутся после того, как товар поступит на склад. О возврате денег проинформируем уведомлением в личном кабинете."),c=$.templates("Ваша заявка на возврат {{if refundPrice > 0}}<b>{{priceWithCurrencyV2:refundPrice iso=currency}}</b>{{else}}денежных средств{{/if}} одобрена{{if currency == 'RUB'}}, деньги поступят на баланс{{/if}}"),l={message:new Set(["create"]),refund:new Map([["sellerRejectRefund",()=>"Возврат товара отклонен"],["sellerRequestRefund",()=>'Чтобы вернуть товар, найдите его в Покупках, нажмите <span class="message__dots"></span> и выберите Вернуть товар по&nbsp;браку'],["sellerAcceptFullRefund",t=>c.render(t)],["sellerAcceptRefundInOffice",t=>h.render(t)]])},d=[{id:1,name:"Слишком долго"},{id:2,name:"Мне не помогли"},{id:3,name:"Не нравится решение"},{id:4,name:"Невежливо"},{id:5,name:"Смена оператора"},{id:6,name:"Пришлось повторять"}],u=[{id:7,name:"Медленно"},{id:8,name:"Мало информации"},{id:3,name:"Не нравится решение"},{id:4,name:"Невежливо"},{id:5,name:"Смена оператора"},{id:6,name:"Пришлось повторять"}],v=[{id:9,name:"Всё быстро"},{id:10,name:"Мне помогли"},{id:11,name:"Дружелюбно"}],p=[{id:"operator-rating-negative",text:"Плохо",value:1,class:"rate-operator__item--negative"},{id:"operator-rating-neutral",text:"Нормально",value:2,class:"rate-operator__item--neutral"},{id:"operator-rating-positive",text:"Хорошо",value:3,class:"rate-operator__item--positive"}];const g=function(){function t({id:t,chatId:e,text:s="",dt:i=new Date,inbox:n=!1,attachments:r,type:o="message",action:a,body:h,rating:c,translated:d,locale:u,uniqueId:v,isNew:p,to_operator:g,employee_id:m}){t&&(this.id=t),e&&(this.chatId=e),this.text=s,this.translated=d,this.locale=u,this.dt=new Date(i),this.inbox=n,this.toOperator=g,this.employeeId=m,r&&(this.attachments=r),this.type=o,this.action=a,this.ogLanguageExpanded=!1,"refund"==o&&h&&l[o].has(a)&&(this.custom=!0,this.text=l[o].get(a)({refundPrice:h.price/100,currency:h.priceCurrency})),c&&(this.rating=c)}var e=t.prototype;return e.setUniqueId=function({id:t,create:e}){return e?this.uniqueId=wb.helpers.generateGuid():t&&(this.uniqueId=t),this},e.hasFile=function(){var t,e;return(null===(e=null===(t=this.attachments)||void 0===t?void 0:t.files)||void 0===e?void 0:e.length)>0},e.hasImage=function(){var t,e;return(null===(e=null===(t=this.attachments)||void 0===t?void 0:t.images)||void 0===e?void 0:e.length)>0},e.hasUrl=function(){var t,e;return(null===(e=null===(t=this.attachments)||void 0===t?void 0:t.urls)||void 0===e?void 0:e.length)>0},e.files=function(){var t;return null===(t=this.attachments)||void 0===t?void 0:t.files.map((t=>new o({attachment:t})))},e.urls=function(){var t;return null===(t=this.attachments)||void 0===t?void 0:t.urls.map((t=>new o({attachment:t})))},e.setId=function(t){return this.id=t,this},e.setDt=function(t){return this.dt=t?new Date(t):new Date,this},e.setSender=function({id:t,name:e,bot:s}){return t||e?(this.sender={id:t,name:e,bot:s},this):this},e.addImage=function({url:t,name:e,size:s,type:i,date:n}){return t?(this.attachments||(this.attachments={}),this.attachments.images||(this.attachments.images=[]),this.attachments.images.push({url:t,name:e,size:s,type:i,date:n}),this):this},e.addFile=function({url:t,name:e,size:s,type:i,date:n}){return t?(this.attachments||(this.attachments={}),this.attachments.images||(this.attachments.files=[]),this.attachments.files.push({url:t,name:e,size:s,type:i,date:n}),this):this},e.tryLinkify=function(t){if(!this.text)return this;const e=new Set;if(t){const t=(new DOMParser).parseFromString(this.text,"text/html"),s=t.body.getElementsByTagName("a");s.length>0&&(s.forEach((t=>{t.target="_blank",e.add(t.href),t.href=encodeURI(t.href)})),t.body.querySelectorAll(":not(a)").forEach((t=>t.outerHTML=t.innerText)),this.text=t.body.innerHTML,this.custom=!0)}return this.text=this.text.replace(a,(t=>e.has(t)?t:(this.attachments||(this.attachments={}),this.attachments.urls||(this.attachments.urls=[]),this.attachments.urls.push({url:t}),""))),this},e.addPayload=function(t){var e;return this.payload=null===(e=null==t?void 0:t.interface_command)||void 0===e?void 0:e.reduce(((t,e)=>{var s,i,n,r,o;switch(e.type){case"TEXT":this.text=(null===(s=e.values[0])||void 0===s?void 0:s.text)||"";break;case"SHOW_PRODUCTS_LIST":t.showProducts=null!==(n=null===(i=e.values[0])||void 0===i?void 0:i.show)&&void 0!==n&&n;break;case"MENU":t.buttons=(null===(r=e.values)||void 0===r?void 0:r.map((t=>Object.assign(Object.assign({},t),{name:t.name.replace(/[<>]/g,"").trim()}))))||[];break;case"NAVIGATIONS":t.navigation=(null===(o=e.values)||void 0===o?void 0:o.map((t=>Object.assign(Object.assign({},t),{name:t.name.replace(/[<>]/g,"").trim()}))))||[]}return t}),{}),this},e.addSentActions=function(t){return this.inbox||((null==t?void 0:t.choose_product)?(this.text="Вопрос о товаре",t.choose_product.nmId>0&&(this.sentProduct=t.choose_product)):(null==t?void 0:t.choose_button)&&(this.text=t.choose_button.text)),this},e.addRateMessage=function(t,e){return t?(this.inbox=!this.rating,this.rateChat=!0,this.chatRated=this.rating>0,this.ratingButtonsSelected=[]):e&&(this.inbox=!this.rating,this.rateOperator=!0,this.operatorRating=this.rating,this.operatorRated=this.rating>0),this},e.getBy=function(t){return t?t<3?d:t>3?v:u:[]},e.getOperatorRatingButtons=function(){return p},e.expandOgLanguage=function(){$.observable(this).setProperty({ogLanguageExpanded:!this.ogLanguageExpanded})},t.createFromWbChat=function({message_id:t,msg_text:e,image_url:s,file_url:i,dt:n,is_inside:r,employee_id:o,employee_first_name:a,rate:h,to_operator:c,bot_payload:l,actions:d,rate_chat:u,rate_employee:v,idempotency_key:p}={}){return new this({id:t,text:e,dt:n,inbox:r,rating:h,rateChatAnswer:u,rateEmployee:v,to_operator:c}).setUniqueId({id:p}).addFile({url:i}).addImage({url:s}).setSender({id:o,name:a,bot:!!l||null}).tryLinkify(!0).addPayload(l).addSentActions(d).addRateMessage(u,v)},t.createFromEvent=function(t){var e,s,i;const n=t[t.eventType];if(!l[t.eventType]||!(null===(e=l[t.eventType])||void 0===e?void 0:e.has(null==n?void 0:n.actionType)))return null;const r=new this({chatId:t.chatID,type:t.eventType,action:n.actionType,body:n,text:null==n?void 0:n.text,translated:null==n?void 0:n.translated,locale:null==n?void 0:n.locale,attachments:Object.assign({},null==n?void 0:n.attachments),dt:new Date(t.addTime||t.clientCreatedAt),inbox:"seller"==(null===(s=t.sender)||void 0===s?void 0:s.type)||"wb"==(null===(i=t.sender)||void 0===i?void 0:i.type)}).tryLinkify();return"message"!=t.eventType&&r.setSender({name:"Бот Wildberries",bot:!0}),r},t.createBotMessage=function({chatID:t,dt:e}){const s=new this({chatId:t,text:"Ожидайте ответа продавца",dt:e,inbox:!0});return s.setSender({name:"Бот Wildberries",bot:!0}),s},t}();const m=function(){function t(){Object.setPrototypeOf(t.prototype,WbSpaModel.prototype),this.baseUrl="https://chat.wildberries.ru/api/sellers-chat-1/v1/"}var e=t.prototype;return e.getChats=function(){return this._signedFetch("client/chats",null,{method:"GET"})},e.getEvents=function({lastTime:t,delay:e}={},{signal:s}={}){const i={lastTime:t,lp:!1};return this._signedFetch("client/events",i,{signal:s})},e.sendEvent=function({chatId:t,sellerId:e,sellerName:s,text:i,attachments:n,sign:r,sender:o}){const a={eventType:"message",clientCreatedAt:Date.now(),sign:r,message:{actionType:"create",text:i},recipients:[{id:e.toString(),name:s,type:"seller"}],sender:o};return n&&(a.message.attachments=n),t?a.chatID=t:a.isNewChat=!0,this._signedFetch("client/send",a).then((t=>(t.event=a,t)))},e.sendFile=function(t){const e=new FormData;e.append("file",t);const s=new Headers;return WbSpaModel.prototype.$auth.jwt&&s.set("Authorization",`Bearer ${WbSpaModel.prototype.$auth.jwt}`),WbSpaModel.prototype.$httpClient.fetch(this.baseUrl+"client/upload",{method:"POST",processData:!1,body:e,headers:s,credentials:"omit",cache:"no-cache"}).then((t=>{if(t.ok)return t.json();throw new Error("Ошибка при отправке файла")}))},e._signedFetch=async function(t,e,s={}){const i=e?JSON.stringify(e):null,n=new Headers;WbSpaModel.prototype.$auth.jwt&&n.set("Authorization",`Bearer ${WbSpaModel.prototype.$auth.jwt}`);const r=await WbSpaModel.prototype.$httpClient.fetch(this.baseUrl+t,Object.assign({method:"POST",body:i,headers:n,credentials:"omit"},s));if(!r.ok){const t=await r.text();if(t.indexOf("ChatID is empty or not exist")>0)return{tryAsNew:!0};if(t.indexOf("Invalid signature")>0)return{invalidSignature:!0};throw new Error("Ошибка запроса")}return r.json()},e._signSha512=async function(t){const e=await crypto.subtle.digest("SHA-512",new TextEncoder("utf-8").encode(t));return new Uint8Array(e).reduce(((t,e)=>t+e.toString(16).padStart(2,"0")),"")},t}(),b="by"==wb.settings.currentLocale?"Поставщик":"Продавец";const f=function(){function t(t){this.chatService=new m,this.storageService=t.$services.storageService.chats,this._longPoll=this._longPoll.bind(this),this.lastTime=0,this.chats=t.chats,this.ctx=t}var e=t.prototype;return e.start=async function(){try{const t=await this._initChats();t>=0&&this.restart(t)}catch(t){console.error(t)}},e.restart=function(t){this.stop(),this.lastTime=t,this.pollId=setTimeout(this._longPoll,100)},e.stop=function(t=!1){var e;if(null===(e=this.currentPoll)||void 0===e||e.abort(),clearTimeout(this.pollId),this.currentPoll=null,t){const t=this.chats.find((t=>t.wb));t&&($.observable(this.chats).refresh([t]),$.observable(this.ctx).setProperty({activeChat:t}))}},e.showChat=async function({chatId:t,text:e,sellerId:s,title:i,goodCard:n,afterSubmit:r}={}){let o=this.chats.find((e=>{var s;return null===(s=e.name)||void 0===s?void 0:s.startsWith(t)}));const a=Date.now();if(i||(i=b),o){o.afterSubmit=r;!!(null==n?void 0:n.rid)&&o.history.some((t=>{var e,s,i,r,o,a;return(null===(s=null===(e=t.attachments)||void 0===e?void 0:e.goodCard)||void 0===s?void 0:s.rid)==n.rid&&(!n.claimId||(null===(r=null===(i=t.attachments)||void 0===i?void 0:i.goodCard)||void 0===r?void 0:r.claimId)==n.claimId)&&n.needRefund==(null===(a=null===(o=t.attachments)||void 0===o?void 0:o.goodCard)||void 0===a?void 0:a.needRefund)}))||($.observable(o).setProperty({text:e}),o.goodCard=n),(!o.title||o.title!=i&&o.title==b)&&($.observable(o).setProperty({title:i}),i!=b&&(o.sellerName=i,o.dirty=!0)),$.observable(o).setProperty({onTop:a})}else{const t=i;o=await this._createNewSellerChat({sellerId:s,sellerName:t}),o.text=e,o.goodCard=n,o.onTop=a,o.afterSubmit=r,$.observable(this.chats).insert(o)}i===b&&this.getSellerName(s).then((t=>{t&&$.observable(o).setProperty({title:t})})),this._updateSellerLogos([o])},e.getSellerName=async function(t){var e,s;const i=await WbSpaModel.prototype.$httpClient.fetchBasicJSON(`https://static-basket-01.wbbasket.ru/vol0/data/supplier-by-id/${t}.json`,{},{nullOnError:!0});return null!==(s=null!==(e=null==i?void 0:i.trademark)&&void 0!==e?e:null==i?void 0:i.supplierName)&&void 0!==s?s:null==i?void 0:i.supplierFullName},e._initChats=async function(){var t;let e=-1;const{serverChats:s,broken:i}=await this.chatService.getChats().then((t=>({serverChats:t}))).catch((()=>({broken:!0,serverChats:[]})))||{serverChats:[]},n=new Set,{chats:r,histories:o,maxSeen:a}=await this.storageService.getChats();if(a.has("wb")){const t=this.chats.find((t=>t.wb));t&&(t.maxSeen=a.get(t.name))}const h=[...s.concat(r).reduce(((t,e)=>(t.has(e.chatID)||t.set(e.chatID,e),t)),new Map).values()];if(h.length>0){e=0;const s=[],r=[],c=new Set;let l,d=this.ctx.chat.isVisible();for(const u of h){const{chatID:h,seller:v,sign:p,local:m}=u;if(c.has(h))continue;c.add(h),m||r.push(u);const b=await this._createNewSellerChat({chatId:m&&!i?null:h,sellerId:v.id,sellerName:v.name,sign:p});b.maxSeen=a.get(b.chatId)||0;const f=null===(t=o.get(h))||void 0===t?void 0:t.reduce(((t,e)=>{var s,i,r;!b.sellerName&&"seller"==(null===(s=null==e?void 0:e.sender)||void 0===s?void 0:s.type)&&e.sender.name&&(b.sellerName=b.title=e.sender.name);const o=g.createFromEvent(e);if(o){t.push(o);const s=null===(r=null===(i=e[e.eventType])||void 0===i?void 0:i.attachments)||void 0===r?void 0:r.goodCard;if(null==s?void 0:s.needRefund){n.add(s.rid);const i=g.createBotMessage({chatID:e.chatID,dt:new Date((e.addTime||e.clientCreatedAt)+10)});t.push(i)}}return t}),[]);if((null==f?void 0:f.length)>0){for(const t of f)b.history.push(t),t.inbox&&b.maxSeen>0&&+t.dt>b.maxSeen&&(b.unreadCount=(b.unreadCount||0)+1);e=Math.max(+f[f.length-1].dt,e),d||b.unreadCount>0&&(this.ctx.$eventBus.dispatchEvent(new CustomEvent("OnlineChatShowUnread")),d=!0)}this.ctx.lastActiveChatName==b.name&&(l=b),s.push(b)}s.length>0&&($.observable(this.chats).insert(s),l&&$.observable(this.ctx).setProperty({activeChat:l}),r.length>0&&this.storageService.saveChats(r),this._updateSellerLogos(s))}return this.ctx.startedRefunds.resolve(n),e},e._longPoll=async function(){this.currentPoll=new AbortController;try{const t=await this.chatService.getEvents({lastTime:this.lastTime,delay:50},{signal:this.currentPoll.signal});if(t){this._refreshHistory(t);for(const e of t)this.lastTime=Math.max(this.lastTime,e.addTime);this.lastTime>0&&(this.pollId=setTimeout(this._longPoll.bind(this),6e4))}}catch(t){"AbortError"!==t.name&&(clearTimeout(this.pollId),this.pollId=setTimeout(this._longPoll.bind(this),6e4))}},e._refreshHistory=async function(t){if(0==t.length)return;const e=[],s=t.reduce(((t,s)=>{const i=s.chatID;let n=t.get(i);n||(n=[],n.senderId=s.sender.id,n.senderName=s.sender.name||$.localize("Продавец"),n.chatId=s.chatID,n.sign=s.sign,t.set(i,n));const r=g.createFromEvent(s);return r&&(e.push(s),n.push(r)),t}),new Map);if(s.size>0){let t=[];this.storageService.saveEvents(e);for(const[e,i]of s){const s=this.chats.find((t=>t.chatId===e));if(s)i.length>0&&$.observable(s.history).insert(i),s.initializing&&$.observable(s,!0).removeProperty("initializing"),s.title||($.observable(s).setProperty({title:i.senderName}),s.sellerName=i.senderName,s.dirty=!0);else{const s=await this._createNewSellerChat({chatId:i.chatId,sign:i.sign});s.name=e,s.title=i.senderName,s.history=i,s.sellerId=i.senderId,s.sellerName=i.senderName,t.push(s)}}t&&$.observable(this.chats).insert(t),e.length>0&&!this.ctx.chat.isVisible()&&this.ctx.$eventBus.dispatchEvent(new CustomEvent("OnlineChatShowUnread"))}for(const t of this.chats.filter((t=>t.initializing)))$.observable(t,!0).removeProperty("initializing")},e._updateSellerLogos=async function(t){await this.ctx.$moduleLoader.loadServiceAsync("suppliersService");const e=t.reduce(((t,e)=>(e.sellerId>0&&t.set(+e.sellerId,e),t)),new Map);e.size>0&&this.ctx.$services.suppliersService.getSuppliersExtInfo([...e.keys()]).then((t=>{for(const s of t)s&&s.hasLogo&&e.has(s.id)&&$.observable(e.get(s.id)).setProperty({hasLogo:s.hasLogo})}))},e._createNewSellerChat=async function({chatId:t,sellerId:e,sellerName:s,sign:i}){this.SellerOnlineChat||(this.SellerOnlineChat=await this.ctx.$moduleLoader.loadModuleAsync("sellerOnlineChat"));const n=new this.SellerOnlineChat({chatService:this.chatService,storageService:this.storageService,chatId:t,sellerId:e,sellerName:s,sign:i,ctx:this.ctx});return n.init(this.ctx.chatWrapper,this.ctx.chat),n},t}(),y=JSON.parse('{"Sv":{"prop":"suppliers","url":"https://chat-basket-01.wbbasket.ru/vol0/api/suppliers.json","key":"chat-suppliers-static","ttl":3600000,"maxSize":10000,"version":1},"Ep":{"url":"https://chat-basket-01.wbbasket.ru/vol0/api/shards/shard.json","key":"chat-shards-static","ttl":43200000,"version":1}}');var w=function(t,e){var s={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(s[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(t);n<i.length;n++)e.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(t,i[n])&&(s[i[n]]=t[i[n]])}return s};async function S({url:t,key:e,ttl:s,version:i,prop:n,maxSize:r}){var o;try{let a=function({key:t,version:e}){var s;const i=localStorage.getObject(t);return!i||Date.now()>(null!==(s=i.t)&&void 0!==s?s:0)||i.v!=e?null:i}({key:e,version:i});if(null==a){const h=await function(t){return fetch(t).then((t=>t.ok?t.json():{broken:!0})).catch((t=>({broken:!0})))}(t),{broken:c}=h,l=w(h,["broken"]);r>0&&n&&(null===(o=l[n])||void 0===o?void 0:o.length)>r&&(console.warn("[CHAT STATIC WARNING]:","too much data to save, taking only",r,n),l[n]=l[n].slice(0,r)),function(t,{key:e,ttl:s,version:i}){const n=Object.assign({t:Date.now()+s,v:i},t);localStorage.putObject(e,n)}(l,{key:e,version:i,ttl:c?y.ttlBroken:s}),a=l}return a}catch(t){return console.error("[CHAT STATIC ERROR]:",t),null}}const _=function(){function t(){}return t.suppliers=async function(){const{suppliers:t}=await S(y.Sv)||{suppliers:[]};return t||[]},t.shards=async function(){const{shards:t}=await S(y.Ep)||{shards:[]};return t||[]},t}(),C="wb_chat_settings",P=Object.freeze({name:"wb",title:"Поддержка Wildberries"}),x=Object.freeze({inited:"inited",destroyed:"destroyed"});let O=function(){function t({auth:t,uid:e,startedRefunds:s}){var i;this.loadArchive=async()=>{var t,e,s,i;this.archiveLoaded&&!this.archiveFilters.offset&&$.observable(this).setProperty({archiveLoaded:!1,archiveCount:0});const n={limit:20,offset:this.archiveFilters.offset||0};(null===(t=this.archiveFilters.query)||void 0===t?void 0:t.length)>2&&(n.offset=0,this.archiveFilters.offset=0,n.query=this.archiveFilters.query);const r=await this.$getService("archiveOrdersService").then((t=>t.getItems(n)));if((!(null===(e=null==r?void 0:r.archive)||void 0===e?void 0:e.length)||r.archive.length<20)&&$.observable(this).setProperty("archiveLoaded",!0),this.archiveFilters.offset>0)$.observable(this.totalProducts).insert(r.archive),$.observable(this).setProperty({archiveCount:this.archiveCount+r.archive.length});else{let t=await this.$userEnv.activePositionsTask;(null===(s=this.archiveFilters.query)||void 0===s?void 0:s.length)>2&&(t=t.filter((t=>{var e,s;return isFinite(this.archiveFilters.query)&&t.code1S==this.archiveFilters.query||(null===(e=t.brand)||void 0===e?void 0:e.toLowerCase().includes(this.archiveFilters.query.toLowerCase()))||(null===(s=t.name)||void 0===s?void 0:s.toLowerCase().includes(this.archiveFilters.query.toLowerCase()))}))),$.observable(this.totalProducts).refresh(t.concat(null!==(i=r.archive)&&void 0!==i?i:[])),$.observable(this).setProperty({archiveCount:r.archive.length})}},this.loadMoreArchive=()=>{const t=this.archiveCount+20;$.observable(this.archiveFilters).setProperty({offset:t})},this.status=x.destroyed,this.uid=e,this.isAuth=t,this.chatWrapper=document.querySelector(".j-chat-wrap"),this._lazyCheckBounds=this.$helper.debounce(this._checkBounds.bind(this),200),this.bodyOverflowClass="body--overflow",this.widthScrollbar=Math.abs(window.innerWidth-document.documentElement.clientWidth),this.chatOverlay=this._getChatOverlay(),this.isPremium=!!this.$auth.isAuth&&(null===(i=this.$user.getUserGradeFromCache())||void 0===i?void 0:i.isPremium),this._updateSettingsFromEvent=this._updateSettingsFromEvent.bind(this),this.onType=this.onType.bind(this),this._onAuthLogin=this._onAuthLogin.bind(this),this._onUnAuthLogin=this._onUnAuthLogin.bind(this),this._onToggleSellersSwitcher=this._onToggleSellersSwitcher.bind(this),this.chats=[],this.isTabsOpen=!1,this.isMessageSearchOpen=!1,this.isProductSearchOpen=!1,this.currentTab="m",this.isSliderPopupOpened=!1,this.beginFilter=this.$helper.debounce(this.beginFilter.bind(this),500),this.filterChat=this.filterChat.bind(this),this.sortChats=this.sortChats.bind(this),this.onBreakpoint=this.onBreakpoint.bind(this),this.resetSearch=this.resetSearch.bind(this),this.sortChats.depends=["chats^[]^history^length","chats^[]^onTop"],this.openSlider=this.openSlider.bind(this),this.filterChat.depends="chatPattern",this.staticData=_,$.templates("contextMenu",{markup:"<a class=\"context-menu__content j-context-content\" data-link=\"{on 'click' goToMessage}{on ~sendAnalytics 'Purchases_Chat_Attachment_Message_T'}\">Перейти к сообщению</a>",helpers:{sendAnalytics:this.sendAnalytics.bind(this)}},this.template);const n=this;$.views.tags({chatAnalytics:{baseTag:"on",init:function(t){const[e,...s]=t.args;this.eventName=e,this.props=t.props;let i="click",n=!1;t.props.customEvent&&(n=!0,i=t.props.customEvent,delete t.props.customEvent),t.args=[i,...s,this.sendAnalytics.bind(this,e,t.props),n],this.baseApply(arguments)},sendAnalytics:function(t,e,s,i,r){const o={};if(s)for(const t in i.originalEvent.detail)o[t]=i.originalEvent.detail[t];else if(e)for(const t in e)if("eventData"==t){const s=e[t],{data:n}=$.view(i.currentTarget);o[s]=n[s]}else o[t]=e[t];n.sendAnalytics(t,o)}}},this.template),$.observe(this,"chats^[]^unreadCount",((t,e)=>{0==this.chats.reduce(((t,e)=>t+(e.unreadCount||0)),0)?this._removeUnread():this._showUnread()})),this.startedRefunds=s,this.start=this.$helper.debounceLead(this.start),this.totalProducts=[],this.archiveFilters={},this.archiveCount=0,this.loadArchiveDebounced=this.$helper.debounce(this.loadArchive,500)}var e,s,i,r=t.prototype;return r.currentChat=function(){var t;return null!==(t=this.activeChat)&&void 0!==t?t:this.chats[0]},r.changeInputHeight=function(t){if(t||(t=document.querySelector(".j-chat-textarea")),!t)return;t.style.height="auto";const e=t.scrollHeight;t.style.height=e+"px";const s=t.value.length;t.setSelectionRange(s,s),t.focus(),t.scrollTop=t.scrollHeight-t.clientHeight},r.init=function(){return document.addEventListener("click",this.$helper.delegator(".j-btn-chat-open",((t,e)=>{this._toggleChat(),e.dataset.chatDefault&&this.switchChat("wb"),this.$analitic.sendEvent(e.hasAttribute("data-header")?"Support_Chat_Header_T":"Support_Chat_T"),this.sendAnalytics("Purchases_Chat_S")}))),this},r.start=function(t){return this.status==x.inited?this._refreshChatAsync():this._startChatAsync(t)},r.restart=function({auth:t,uid:e}){this.destroy(),this.isAuth=t,this.uid=e,wb.displayModeSettings.removeObserver(this.onBreakpoint),wb.displayModeSettings.addObserver(this.onBreakpoint,!0)},r.destroy=function(){var t;if(this.status!=x.destroyed){this._removeUnread(),this.status=x.destroyed,this._unbindEvents(),this.chatOverlay.hide(),document.querySelectorAll(".j-btn-chat-open").forEach((t=>{t.classList.add("hide")})),document.body.classList.remove("body--chat-overflow"),$(this.chatWrapper).unlink();for(const t of this.chats)t.stopChat();null===(t=this.chatWorker)||void 0===t||t.stop(),this.chatWorker=null,$.observable(this.chats).refresh([])}},r.minimize=function(){this.activeChat.wb&&$.observable(this.activeChat).setProperty({screen:"home"}),this._updateSetting("show",!1),this.chatOverlay.hide(),document.removeEventListener("click",this)},r.sendAnalytics=function(t,e){const s=this.currentChat();s&&!s.wb&&this.$analitic.sendEvent(t,Object.assign({supplier_id:s.sellerId,supplier:s.sellerName},e))},r.onType=function(t){var e;const{currentType:s,isInit:i}=t.detail,n=null===(e=this.$router.currentRoute)||void 0===e?void 0:e.path;if("m"==wb.settings.displayMode)return"home"!=s&&"subscription"!=s&&"claims"!=s&&"archive"!=s&&"orders"!=s&&"profile"!=s&&"communications"!=s&&"lk/myrefunds"!=n&&"lk"!=n?(this.destroy(),void this.$eventBus.addEventListener("onUserAuth",this._onAuthLogin,{single:!0})):this.status==x.destroyed?this.start({ignoreShow:!i}):void 0},r.onBreakpoint=function(t){"m"===t?this._addMobileMenuHandler():(this._removeMobileMenuHandler(),this.start())},r.switchChat=function(t){const e=this.chats.find((e=>{var s;return null===(s=e.name)||void 0===s?void 0:s.startsWith(t)}));e&&(this.$observable.setProperty({activeChat:e,isTabsOpen:!1,isMessageSearchOpen:!1,isProductSearchOpen:!1,currentTab:"m",open:!0}),this.changeInputHeight(),e.scrollToBottom(),this.resetSearch("home"),e.lastMessage()&&e.visit({dt:e.lastMessage().dt,observe:!0}))},r.backToChats=function(){this.$observable.setProperty({open:!1})},r.closeMediaGallery=function(){this.$observable.setProperty({isTabsOpen:!1,isSliderPopupOpened:!1})},r.toggleTabsVisible=function(t){t.preventDefault(),t.stopPropagation(),this.$observable.setProperty({isTabsOpen:!this.isTabsOpen})},r.toggleSearchVisible=function(t){if(t.preventDefault(),t.stopPropagation(),this.$observable.setProperty({isMessageSearchOpen:!this.isMessageSearchOpen}),this.isMessageSearchOpen){document.querySelector(".j-search-message").focus()}else this.resetSearch("home")},r.toggleSearchProductVisible=function(t){if(t.preventDefault(),t.stopPropagation(),this.$observable.setProperty({isProductSearchOpen:!this.isProductSearchOpen}),this.isProductSearchOpen){document.querySelector(".j-search-product").focus()}else this.resetSearch("products")},r._resetMessageSearch=function(){const t=this.currentChat();$.observable(this).removeProperty("searchText"),$.observable(t.foundPatterns).refresh([]),$.observable(t).setProperty("searchIndex",0),$.observable(t).setProperty("searchingComplete",!1),$.observable(t).setProperty("searchText","");for(const e of t.history)$.observable(e).removeProperty("foundText")},r._resetProductsSearch=function(){$.observable(this.archiveFilters).setProperty("query","")},r.resetSearch=function(t="home"){return"home"===t?this._resetMessageSearch():"products"===t?this._resetProductsSearch():void 0},r.switchTab=function(t,e){e.preventDefault(),this.$observable.setProperty({currentTab:t})},r.openSlider=function(t,e){this.$observable.setProperty({isSliderPopupOpened:!0});const s=document.querySelector(".j-chat-thumbs");this.swiperThumbs=new Swiper(s.querySelector(".swiper-container"),{slidesPerView:8,spaceBetween:8,centerInsufficientSlides:!0,updateOnWindowResize:!0,watchOverflow:!0,watchSlidesVisibility:!0,navigation:{nextEl:s.querySelector(".swiper-button-next"),prevEl:s.querySelector(".swiper-button-prev"),lockClass:"hide"},breakpoints:{1200:{slidesPerView:10},1400:{slidesPerView:12},1600:{slidesPerView:15}}});const i=document.querySelector(".j-chat-slider"),{data:n}=$.view(t.target);let{imgCounter:r,index:o}=n;r&&(o=r.counter-1-o),this.swiper=new Swiper(i.querySelector(".swiper-container"),{slidesPerView:1,spaceBetween:16,updateOnWindowResize:!0,watchOverflow:!0,navigation:{nextEl:i.querySelector(".swiper-button-next"),prevEl:i.querySelector(".swiper-button-prev")},thumbs:{swiper:this.swiperThumbs},pagination:{el:document.querySelector(".j-chat-slide-counter"),type:"fraction",renderFraction:(t,e)=>`<span class="${t}"></span> / <span class="${e}"></span>`},initialSlide:o,keyboard:{enabled:!0,onlyInViewport:!0}});const a=$.view(this.swiper.slides[o]);null==a||a.ctxPrm("currentMessage",a.data),this.swiper.on("activeIndexChange",(()=>{const t=$.view(this.swiper.slides[this.swiper.activeIndex]);t.ctxPrm("currentMessage",t.data)}))},r.closeSlider=function(t){var e,s;null==t||t.stopPropagation(),null===(e=this.swiper)||void 0===e||e.destroy(),null===(s=this.swiperThumbs)||void 0===s||s.destroy(),this.$observable.setProperty({isSliderPopupOpened:!1})},r.handleEvent=function(t){("click"==t.type||this.chat.isVisible())&&(t.target.closest(".j-seller-chat")||t.target.closest(".popup-alert")||t.target.closest(".j-prevent-chat-close")||this.chatWrapper.contains(t.target)||this.minimize())},r.onGoToUrl=function(t){return wb.global.userSettings.closed.push("chat-popup"),wb.global.saveUserSettings(),!0},r._addMobileMenuHandler=function(){this.$eventBus.addEventListener("MobileMenuTypeChange",this.onType,{single:!0})},r._removeMobileMenuHandler=function(){this.$eventBus.removeEventListener("MobileMenuTypeChange",this.onType)},r._startChatAsync=async function({ignoreShow:t}={}){var e,s,i;const n=await this.$moduleLoader.loadModuleAsync("onlineChat");await this.$moduleLoader.loadServiceAsync("storageService");const r=new n(this.isAuth,this.uid,{ctx:this,storageService:this.$services.storageService.chats});$.observable(this.chats).insert(r),this.activeChat=r,await r.initAsync(),this.status=x.inited,this.lastActiveChatName=null===(e=this.chatWrapper.querySelector(".chat"))||void 0===e?void 0:e.getAttribute("data-last-chat"),this.template.link(this.chatWrapper,this),this._bindEvents(),this.chat=document.querySelector(".chat");for(let t of this.chats)t.init(this.chatWrapper,this.chat);if(this.isAuth&&(null===(i=null===(s=wb.global.settings)||void 0===s?void 0:s.switches)||void 0===i?void 0:i.enableSellersChat))this.chatWorker=new f(this),this.chatWorker.start();else if(r.history.length>0){const{maxSeen:t}=await this.$services.storageService.chats.getChats({localOnly:!0}),e=t.get("wb");e>0&&$.observable(r).setProperty("maxSeen",e)}let o=this._getSettings();if(o){let e;if(t||!o.show||(e=wb.global.userSettings.closed.includes("chat-popup"))||(this.chatOverlay.show(),document.addEventListener("click",this)),o.show&&(this._lazyCheckBounds(),this.currentChat().scrollToBottom()),e){const t=wb.global.userSettings.closed.indexOf("chat-popup");t>=0&&(wb.global.userSettings.closed.splice(t,1),wb.global.saveUserSettings())}}this.$eventBus.dispatchEvent(new CustomEvent("OnlineChatStarted"))},r._getStorageService=function(){return this.$moduleLoader.loadServiceAsync("storageService")},r._refreshChatAsync=function(){var t,e;this.chats.find((t=>t.name===P.name)).refreshAsync(),this.isAuth&&(null===(e=null===(t=wb.global.settings)||void 0===t?void 0:t.switches)||void 0===e?void 0:e.enableSellersChat)&&!this.chatWorker&&this._getStorageService().then((()=>{this.chatWorker=new f(this),this.chatWorker.start()}))},r._getSettings=function(){var t,e;return null!==(e=null!==(t=this._tryGetSettingsFromLocalStorage())&&void 0!==t?t:this._tryGetSettingsFromCookie())&&void 0!==e?e:{}},r._tryGetSettingsFromLocalStorage=function(){return localStorage.getObject(C)},r._tryGetSettingsFromCookie=function(){const t=wb.cookieHelper.getCookie("_wbchat");if(!(t&&t.length>0))return null;try{const e=JSON.parse(t);return this._saveSettings(e),e}catch(t){return null}},r._saveSettings=function(t){localStorage.putObject(C,t)},r._updateSetting=function(t,e){const s=this._getSettings();s[t]=e,this._saveSettings(s)},r._updateSettingsFromEvent=function(t){const e=t.detail;if(!Array.isArray(e))return;const s=this._getSettings();e.forEach((([t,e])=>s[t]=e)),this._saveSettings(s)},r._onToggleSellersSwitcher=function(t){const e=t.detail;e&&!this.chatWorker?this.isAuth&&this._getStorageService().then((()=>{this.chatWorker=new f(this),this.chatWorker.start()})):!e&&this.chatWorker&&(this.chatWorker.stop(!0),this.chatWorker=null)},r._bindEvents=function(){document.querySelectorAll(".j-btn-chat-open").forEach((t=>{var e;t.classList.remove("hide");const s=document.documentElement.clientWidth;s>1023&&s<1281&&"SpaProductCardEntrypoint"==(null===(e=this.$router.currentRoute)||void 0===e?void 0:e.name)&&t.classList.add("invisible")})),window.addEventListener("resize",this._lazyCheckBounds),window.addEventListener("scroll",this._lazyCheckBounds),this.$eventBus.addEventListener("UpdateOnlineChatSettings",this._updateSettingsFromEvent),this.$eventBus.addEventListener("OnlineChatShowUnread",this._showUnread),this.$eventBus.addEventListener("onUserAuth",this._onAuthLogin,{single:!0}),this.$eventBus.addEventListener("onUserUnAuth",this._onUnAuthLogin),this.$eventBus.addEventListener("SellersChatSwitched",this._onToggleSellersSwitcher),$.observe(this.archiveFilters,"offset",this.loadArchive),$.observe(this.archiveFilters,"query",this.loadArchiveDebounced)},r._unbindEvents=function(){window.removeEventListener("resize",this._lazyCheckBounds),window.removeEventListener("scroll",this._lazyCheckBounds),this.$eventBus.removeEventListener("UpdateOnlineChatSettings",this._updateSettingsFromEvent),this.$eventBus.removeEventListener("OnlineChatShowUnread",this._showUnread),this.$eventBus.removeEventListener("onUserAuth",this._onAuthLogin),this.$eventBus.removeEventListener("onUserUnAuth",this._onUnAuthLogin),this.$eventBus.removeEventListener("SellersChatSwitched",this._onToggleSellersSwitcher),document.removeEventListener("click",this),$.unobserve(this),$.unobserve(this.archiveFilters)},r._onAuthLogin=function(){this.restart({auth:!0})},r._onUnAuthLogin=function(){this.restart({auth:!1,uid:this.$services.sessionService.getBasketUid()})},r._checkBounds=function(){this._checkScrollEnd();let t=this.chat.getBoundingClientRect(),e=document.documentElement.clientWidth||document.body.clientWidth||window.innerWidth,s=document.documentElement.clientHeight||document.body.clientHeight||window.innerHeight;(t.top<0&&0==window.scrollY||t.top+t.height/2>s)&&(this.chat.style.top="",this._updateSetting("y",void 0)),(t.left<-10||t.right>e+10)&&(this.chat.style.left="",this._updateSetting("x",void 0))},r._checkScrollEnd=function(){const t=window.scrollY||document.documentElement.scrollTop,e=document.documentElement.clientHeight||window.innerHeight,s=document.documentElement.scrollHeight||document.body.scrollHeight,i=document.querySelector(".j-fixed-block");i&&(t+e>=s?i.classList.add("scrolled-to-end"):i.classList.remove("scrolled-to-end"))},r.showChat=async function(t){var e;await this.chatWorker.showChat(t),this._toggleChat(),this.switchChat(t.chatId,{disableStats:!0}),this.sendAnalytics("Purchases_Chat_Seller_T",{id:null===(e=null==t?void 0:t.goodCard)||void 0===e?void 0:e.nmID})},r.setSearching=function(t,e){e.view.ctxPrm("searching",!0)},r.beginFilter=function(t,e){var s;const i=null===(s=t.target.value)||void 0===s?void 0:s.trim().replace(/[/\-\\^$*+?.()|[\]{}]/g,"\\$&");if(i&&/[\wА-Яа-я]/.test(i)){const t=new RegExp(i,"i");$.observable(this).setProperty("chatPattern",t),this.sendAnalytics("Purchases_Chat_SearchRequest_Send",{text:i})}else $.observable(this).removeProperty("chatPattern");e.view.ctxPrm("searching",!1)},r.filterChat=function(t,e,s){return!this.chatPattern||this.chatPattern.test(t.title)},r.sortChats=function(t,e){if(t.wb)return-1;if(e.wb)return 1;function s(t){return t.onTop>0?t.onTop:t.lastMessage()?+t.lastMessage().dt:0}return s(e)-s(t)},r.clearSearchChat=function(t){t.target.closest(".j-search-chat").querySelector("input").value="",$.observable(this).removeProperty("chatPattern")},r.loadMessageProducts=async function(){var t;if(this.messageProductsLoaded)return;this.messageProductsLoaded=!0;const e=(await this.$userEnv.activePositionsTask).slice(0,5),{archive:s}=null!==(t=await this.$getService("archiveOrdersService").then((t=>t.getItems({limit:6-e.length}))))&&void 0!==t?t:{archive:[]},i=e.length+s.length>5;$.observable(this).setProperty({messageProducts:e.concat(s.slice(0,5-e.length)),messageProductsShowMore:i})},r.searchItem=function(t,e,s){var i,n;const r=this.ctxPrm("search");return!r||(isNaN(r)?(null===(i=t.brand)||void 0===i?void 0:i.toLowerCase().includes(r.toLowerCase()))||(null===(n=t.name)||void 0===n?void 0:n.toLowerCase().includes(r.toLowerCase())):t.nmId==r)},r._toggleChat=function(){if(this.status==x.destroyed)return;this._toggleElem(this.chatWrapper);const t=this.chat.isVisible();return this._updateSetting("show",t),t&&(this._lazyCheckBounds(),1==this.chats.length&&this.chats[0].lastMessage()&&this.chats[0].visit({dt:this.chats[0].lastMessage().dt,observe:!0}),document.addEventListener("click",this),("d"==wb.settings.displayMode||this.open)&&this.changeInputHeight()),this.currentChat().scrollToBottom(),!1},r._toggleElem=function(t){t.isVisible()?this.chatOverlay.hide():this.chatOverlay.show()},r._showUnread=function(){document.querySelector(".j-fixed-block .btn-chat").classList.add("btn-chat--message")},r._removeUnread=function(){this._updateSetting("unread",!1),document.querySelector(".j-fixed-block .btn-chat").classList.remove("btn-chat--message")},r._getChatOverlay=function(){const t=document.body;let e;return{show:()=>{e||(t.insertAdjacentHTML("afterBegin",'<div class="overlay overlay--chat j-overlay-chat"></div>'),e=t.querySelector(".j-overlay-chat"),this.chatWrapper.classList.remove("hide"),document.body.classList.add(this.bodyOverflowClass),document.body.style.paddingRight=`${this.widthScrollbar}px`)},hide:()=>{e&&e.remove(),e=null,this.chatWrapper.classList.add("hide"),document.body.classList.remove(this.bodyOverflowClass),document.body.style.paddingRight=""}}},r.returnToHomeScreen=function(t){t.stopPropagation(),this.resetSearch("products"),this.activeChat.wb&&$.observable(this.activeChat).setProperty({screen:"home"}),this.$observable.setProperty({isProductSearchOpen:!1}),this.activeChat.scrollToBottom()},r.scrollIntoView=function(t,e=!1){if(t||this.currentChat().scrollToBottom(),e&&"d"!==wb.settings.displayMode)return;const s=t.target.closest(".j-chat-body"),i=t.target.closest(".message"),n=s.getBoundingClientRect(),r=i.getBoundingClientRect();(r.top<n.top||r.bottom>n.bottom)&&s.scrollTo({top:s.scrollTop+r.top-n.top-s.offsetHeight/2+r.height/2,behavior:"smooth"})},e=t,(s=[{key:"template",get:function(){return t.template}}])&&n(e.prototype,s),i&&n(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}();window.__spaModuleManager__.register("onlineChatPopup",O)})();
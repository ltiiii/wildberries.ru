(()=>{"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(t){var i=function(t,i){if("object"!=e(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var s=r.call(t,i||"default");if("object"!=e(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===i?String:Number)(t)}(t,"string");return"symbol"==e(i)?i:i+""}function i(e,i){for(var r=0;r<i.length;r++){var s=i[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,t(s.key),s)}}function r(e,t,r){return t&&i(e.prototype,t),r&&i(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}const s=Object.freeze({Accepted:0,Assembling:1,Rejected:2,Processing:3,Completed:5,ValidateFail:6,Validated:7,Error:8}),a=Object.freeze({Unknown:-1,NotPaid:1,PaySent:2,PayFail:3,Paid:4,Refunded:5}),n=(Object.freeze({Accepted:0,New:1,Failed:2,Processing:4,Completed:5}),a.NotPaid,a.PaySent,a.PayFail,s.Accepted,s.Assembling,s.Processing,s.Validated,s.Rejected,s.Completed,new Set(["SRC","SRD","SRF","SRG","SRK","SRM","SRN","SRO","SRP","SRR","SRT","SRV"])),o=new Set(["CIF","CRE","IWB","WIF","WIS","XYZ","PDL","CWB","BPL"]),d=Object.freeze({5:"Курьерская",6:"Пункт выдачи",17:"Грузовая доставка",30:"Пункт выдачи",63:"СЦ / Склад",83:"Курьерская",86:"Постамат"});let l=function(){function e(e,t,i){t!=e&&(e>0||e)?(this.type="shard",this.value=e>0?e:1):(this.type="user_id",this.value=t>0?t:i>0?i:1)}return e.prototype.toString=function(){return`${this.type}=${this.value}`},e}();const c=function(){function e(e,t,i){Object.assign(this,e),this.isCanceling&&(this.canPrepay=!1),this._ctx=t,this.options=null!=i?i:{},wb.xnm.expandSaleConditions(this,null,1),this.isPrepaid&&delete this.isVerificationReturn,this.setIsOnShelf(),this.isPdlPostPayment="CSH"===this.paymentType&&"PDL"===this.paymentSystem}e.fromNNSZ=function(e,t,i){var r;return null!==(r=null==e?void 0:e.rids.map(((r,n)=>{var o;const d=null===(o=e.services)||void 0===o?void 0:o.find((e=>{var t;return(null!==(t=e.rid_ref)&&void 0!==t?t:0)==n&&4==e.type})),l=new this({_debug:e,address:e.full_address,brand:r.brand,canCancel:r.can_reject_delayed,canCancelDelayed:r.can_reject_delayed,characteristicId:r.chrt_id,code1S:r.nm_id,color:r.color,currency:e.currency,dateTime:new Date(1e3*r.delivery_time),deliveryPrice:((null==d?void 0:d.price)||0)/100,latitude:e.latitude,longitude:e.longitude,name:r.name,officeId:e.dst_office_id,orderDate:new Date(1e3*e.order_dt),orderId:e.id,paymentSaleAmount:(r.discount||0)/100,paymentSaleType:r.wctype_id,payError:r.error,payLink:r.link_3_ds,payState:r.pay_state,pid:6===r.delivery_type?e.dst_office_id:null,price:r.total_price/100,prepaidDelivery:((null==d?void 0:d.pay_state)===a.Paid?d.price:0)/100,rId:r.uid,returnCost:(r.return_fee||0)/100,logisticsCost:(e.logistic_with&&r.logistic_cost||0)/100,saleConditions:r.sale_conditions,size:r.size,smId:r.delivery_type,source:"nnsz",state:r.state,sticker:e.sticker,subjectId:r.subject_id,timestamp:1e3*e.order_dt,trackerShardKey:t.$auth.jwtData.shard_key,type:"active",wh:r.store_id,sellerId:r.seller_id},t,i);return l.payFailed&&0==(e=>{var t,i,r,s;const a=null!==(s=null===(r=null===(i=null===(t=wb.global)||void 0===t?void 0:t.settings)||void 0===i?void 0:i.variables)||void 0===r?void 0:r.failedPaymentsDisplayMinutes)&&void 0!==s?s:0;return Math.floor(Math.max(0,new Date(e).addMinutes(a)-new Date)/1e3)})(l.orderDate)&&(l.type="archive"),l.paymentSaleType>0&&(l.price-=l.paymentSaleAmount),l.payState===a.NotPaid||l.payState==a.PaySent?l.archive||(l.isPrepaid=!1,l.canPrepay=!0,l.selectedForPay=!0,l.prepaid=0):l.payState===a.PayFail?(l.canPrepay=!0,l.selectedForPay=!0,l.prepaid=0,[s.Validated,s.Error].includes(this.state)||(l.isPrepaid=!1)):l.payState===a.Paid?(l.isPrepaid=!0,l.archive||(l.prepaid=l.price,l.prepaidDelivery=l.deliveryPrice)):l.payState!==a.Refunded&&l.state!==s.Completed||(l.archive=!0,l.payState===a.Refunded&&(l.refunded=!0),l.trackingStatus="Заказ завершен",l.noTracking=!0,delete l.trackingStatusId,delete l.trackingStatusReady),l})))&&void 0!==r?r:[]};var t=e.prototype;return t.openProductPopup=function(e,t){if(!e.target.classList.contains("j-non-refundable")&&!e.target.classList.contains("rate-star__item")){var i=t.view.data;this._ctx.$productCardPopup.show(i.code1S,i.characteristicId)}},t.setDeliveryConfirmation=function(){!wb.global.settings.switches.enableCargoDeliveryUpdate||wb.global.settings.switches.enableCargoDeliveryUpdateV2||17!==this.smId||2!==(new Date).daysBetween(new Date(this.dateTime))||wb.global.userSettings.confirmed.includes(this.rId)||(this.needsDeliveryConfirmation=!0)},t.setIsOnShelf=function(e){if(6===this.smId&&(this.trackingStatusId?this.trackingStatusReady:this.readyToReceiveToday)&&("ordo"==this.source&&$.observable(this,e).setProperty({isOnShelf:!0}),!this.expirationTimestamp&&this.lastDate&&$.observable(this,e).setProperty({expirationTimestamp:new Date(this.lastDate).addDays(14)}),this.expirationTimestamp)){(new Date).daysBetween(new Date(this.expirationTimestamp))<=4&&$.observable(this,e).setProperty({unclaimedCost:100})}wb.global.settings.switches.enableCargoDeliveryUpdateV2&&"ordo"==this.source&&300==this.trackingStatusId&&17===this.smId&&new Date(this.orderDate).daysBetween(new Date)<10&&!wb.global.userSettings.confirmed.includes(this.rId)&&($.observable(this,e).setProperty({needsDeliveryUpdate:!0}),3===(new Date).daysBetween(new Date(this.dateTime))&&(this.needsDeliveryUpdateTimeOut=!0))},t.setCancel=function(e){var t,i,r,s,a,d,l;if(this.canCancel||this.cancelProcessed||this.paymentType&&(n.has(this.paymentType.toUpperCase())||o.has(this.paymentType.toUpperCase())||o.has((null===(t=this.paymentSystem)||void 0===t?void 0:t.toUpperCase())||"")))return this;const c=this._ctx.$services.storeService.storesMap;if(this.wh>0&&(c.isForeign(this.wh)||!c.needVerification(this.wh,this.country))){let t=0;if(c.isMp(this.wh)||c.isCargoStore(this.wh)||c.isDbs(this.wh)?(null===(s=null===(r=null===(i=wb.global)||void 0===i?void 0:i.settings)||void 0===r?void 0:r.variables)||void 0===s?void 0:s.minutesForMPOrderCancel)>0&&(t=wb.global.settings.variables.minutesForMPOrderCancel):(null===(l=null===(d=null===(a=wb.global)||void 0===a?void 0:a.settings)||void 0===d?void 0:d.variables)||void 0===l?void 0:l.minutesForWBOrderCancel)>0&&(t=wb.global.settings.variables.minutesForWBOrderCancel),t>0&&300==this.trackingStatusId&&new Date(this.orderDate).addMinutes(t)>=new Date)return $.observable(this,e).setProperty({canCancel:!0}),this}return this},t.setChangeOffice=function(e){return 300==this.trackingStatusId&&6==this.smId&&"ordo"==this.source&&new Date(this.orderDate).addMinutes(30)>=wb.helpers.date.serverDate&&$.observable(this,e).setProperty({canChangeOffice:!0}),this},t.showStatusPopup=function(e,t){if(this.loading)return!1;this.loading=!0;var i=t.view.ctxPrm("delivery"),r=null==i?void 0:i.deliveryWay,s=i.products.findIndex((e=>e.rId===this.rId));return this._ctx.$moduleLoader.loadModuleAsync("trackingPopup").then((e=>{(new e).showStatusPopup({rid:this.rId,smId:this.smId,receiveDate:this.receiveDate,isCourier:this.readyToReceiveToday&&"Courier"==r,delayed:this.delayed,name:this.name,brand:this.brand,expirationTimestamp:this.expirationTimestamp,customTrackerStatus:this.customTrackerStatus,trackerKey:this.trackerKey,products:i.products,activeSlide:s}),this.loading=!1})).catch((e=>{console.log(e),this.loading=!1})),!1},t.cancelItem=async function(e,t){await wb.popup.confirm($.views.templates.cancelConfirmPopup.render(this),{yes:"Отменить",no:"Оставить",showCross:!0,noBtnClassList:["popup__btn-base","btn-minor"],classList:["shown","popup-cancel-confirm"],modal:!0})&&this._cancelItem(e,t)},t._cancelItem=function(e,t){if(this.isCanceling||this.cancelProcessed)return!1;$.observable(this).setProperty({isCanceling:!0});return("nnsz"==this.source?this._ctx.$getService("wbxOrderService").then((e=>e.cancelByRid({orderId:this.orderId,rid:this.rId,byDelay:this.canCancelDelayed}))).then((({success:e,error:t}={})=>{t?($.observable(this).setProperty({isCanceling:!1}),wb.popup.renderModalError(t)):!1===e&&($.observable(this).setProperty({isCanceling:!1,canCancel:!1,cancelProcessed:!0}),wb.popup.renderModalError("Товар нельзя отменить"))})):this._ctx.$getService("orderService").then((e=>e.cancelByRids([this.rId]))).then((e=>{var i;if(null==e?void 0:e.error)return $.observable(this).setProperty({isCanceling:!1}),void wb.popup.renderModalError("Не удалось отменить доставку");if(null==e?void 0:e.notExists){const e=null!==(i=t.view.ctx.parentView)&&void 0!==i?i:t.view;let r=e.get("array");if((null==r?void 0:r.data)&&($.observable(r.data).remove(e.getIndex()),0==r.data.length)){let e=r.parent;const t=null==e?void 0:e.get("array");(null==t?void 0:t.data)&&$.observable(t.data).remove(e.getIndex())}}}))).then((()=>{this.isCanceling?this._ctx.updateItems([this.rId],{isCanceling:!0}):this.cancelProcessed&&this._ctx.updateItems([this.rId],{cancelProcessed:!0}),this._ctx.$moduleLoader.execModule("bottomNotificationPanel","showNotification",[0,"Через несколько секунд товар пропадёт из доставок"])})).catch((e=>{e.isCustomError||console.log(e),$.observable(this).setProperty({isCanceling:!1}),wb.popup.renderModalError(e.isCustomError?e.message:"Ошибка при отмене доставки")})),!1},t.onShowAllStatus=function(e){const t=e.target.closest("li");null==t||t.classList.add("hide");const i=document.querySelector(".j-status-list"),r=null==i?void 0:i.querySelectorAll(".j-status");null==r||r.forEach((e=>e.classList.remove("hide")))},t.startSellerChat=function(e){const{rId:t,name:i,brand:r,color:s,size:a,code1S:n,orderDate:o,sellerId:d,sellerName:l,price:c,currency:u,shkId:h,country:p}=this;if(!d)return;const y=`seller_${d}`,m=[i];r&&m.push(`бренд ${r}`),a&&"0"!=a&&m.push(`размер ${a}`),n>0&&m.push(`артикул ${n}`),o&&m.push(`товар оформлен ${new Date(o).format("dd.MM.yyyy")}`);const v=`Здравствуйте! У меня вопрос по товару "${m.join(", ")}"`;wb.spa.getMainLayout().header.onlineChat.showChat({chatId:y,sellerId:d,text:v,title:l,goodCard:{rid:t,nmID:n,brand:r,name:i,color:s,shkID:h,size:a,price:Math.round(100*c),priceCurrency:u,date:o,site:null==p?void 0:p.toUpperCase(),statusID:(()=>this.trackingStatusId>=300&&this.trackingStatusId<=399?1:this.trackingStatusId>=10&&this.trackingStatusId<=99?2:210==this.trackingStatusId?4:260==this.trackingStatusId?5:this.trackingStatusId>=100&&this.trackingStatusId<=199||this.trackingStatusId>=500&&this.trackingStatusId<=599?3:0)()}})},t.setLocation=function(e){let t=this.address&&isNaN(this.address)?this.address:"Доставка";switch(this.pid||6!=this.smId||(this.pid=this.officeId),!0){case 6==this.smId||30==this.smId:this.locationId=`${this.smId}_${this.officeId}`;break;case 86==this.smId&&this.pid>0:this.locationId=`${this.smId}_${this.pid}`;break;default:this.locationId=`${this.smId}_${wb.helpers.getHashCode(t)}`}e[this.locationId]||(e[this.locationId]={address:t},this.latitude>0&&this.longitude>0&&(e[this.locationId].mapLocation={coordinates:`${this.latitude},${this.longitude}`,hasBalloon:!1,iconContent:t,latitude:this.latitude,longitude:this.longitude,useDefaultIcon:!0}),e[this.locationId].deliveryType=d[this.smId])},e.sortPositions=function(e,t){if(e.archive)return 1;if(t.archive)return-1;function i(e){switch(e){case 16:return 260;case 8:return 210;case 4:return 100;case 2:return 1;case 1:return 300}}const r=e.trackingStatusId||i(e.status),s=t.trackingStatusId||i(t.status),a=s-r;if(0!=a){if(260==r||555==r||210==r&&260!=s&&555!=s)return-1;if(260==s||555==s||210==s&&260!=r&&555!=r)return 1}if(!e.dateTime&&t.dateTime)return-1;if(e.dateTime&&!t.dateTime)return 1;if(e.dateTime&&t.dateTime){const i=e.dateTime-t.dateTime;if(0!=i)return i}return 300<=r&&r<=399?1:300<=s&&s<=399?-1:500<=r&&r<=599?1:500<=s&&s<=599?-1:a},t.getStatusReceiveDate=function(){const{dateTime:e,timeFrom:t,timeTo:i}=this,r=new Date,s=(new Date).daysBetween(e),a=new Date(`${$.views.converters.formatDate(e,"yyyy/MM/dd")} ${t}`),n=new Date(`${$.views.converters.formatDate(e,"yyyy/MM/dd")} ${i}`),o=$.views.converters.formatTimeStr(t);return 1===s?`Завтра с ${o} до ${i}`:2===s?`Послезавтра с ${o} до ${i}`:r>n?"Скоро будет":0===s&&r<a?`Сегодня с ${o} до ${i}`:0===s?`Сегодня до ${i}`:$.views.converters.formatDate(e,`d MMMM, ${t}&#8209;${i}`)},t.setCustomTrackingStatus=function(e){e==s.Accepted?this.trackingStatus="Оформлено":e==s.ValidateFail||e==s.Rejected?this.trackingStatus="Отмена":e==s.Assembling?this.trackingStatus="На сборке":e!=s.Processing&&e!=s.Validated||(this.trackingStatus="В обработке")},r(e,[{key:"trackerKey",get:function(){return new l(this.trackerShardKey,this.user)}},{key:"payFailed",get:function(){return this.payState===a.PayFail&&("nnsz"!=this.source||[s.Validated,s.Error].includes(this.state))}},{key:"verificationRequired",get:function(){return!!(1&~this.options.verificationLevel)&&this._ctx.$services.storeService.storesMap.needVerification(this.wh,this.country)}},{key:"isHumanitarianAid",get:function(){return!(8&~this.orderOptionsFlags)}}])}(),u=e=>new Promise((t=>setTimeout(t,e)));let h=function(){function e(){}var t=e.prototype;return t.setProps=function(e,t){var i,r;this.chrt_id=e.characteristicId,this.nm_id=e.cod1S,this.subject_id=e.subjectId,this.price=null!==(i=e.priceBasic)&&void 0!==i?i:100*e.price,this.total_price=100*e.priceWithCouponAndDiscount,this.sale=e.sale,this.brand=e.brandName,this.name=e.goodsName,this.size=e.sizeName,this.positions=[];const s=(null===(r=e.deliveryInfos[0])||void 0===r?void 0:r.closestDeliveryDate)||t.deliveryDate;[...Array(e.quantity).keys()].forEach((i=>{this.positions.push({delivery_time:s/1e3,delivery_type:"self"===t.deliveryType?6:5,rid:wb.helpers.generateGuid(),wh:e.storeId,return_fee:100*e.returnCost})})),this.targetUrl=e.targetUrl,this.colorName=e.colorName,this.quantity=e.quantity,this.subjectParentId=e.subjectParentId,this.storeId=e.storeId,this.timestamp=e.timestamp,this.saleConditions=e.saleConditions,this.catalogReturnCost=e.catalogReturnCost,this.logisticsCost=e.logisticsCost,this.whDtype=e.whDtype,this.payloadV2=e.payloadV2,this.reviewRating=e.reviewRating,this.feedbacks=e.feedbacks||e.commentsCount,this.customsFeeAmount=e.customCharges,this.supplierId=e.supplierId,this.supplierName=e.supplierName},t.toStorageItem=function(){var e,t,i;return{id:this.nm_id,name:null!==(e=this.name)&&void 0!==e?e:"",subjectId:this.subject_id,subjectParentId:this.subjectParentId,reviewRating:this.reviewRating,feedbacks:this.feedbacks,brand:null!==(t=this.brand)&&void 0!==t?t:"",price:this.price,salePrice:this.total_price,option:{id:this.chrt_id,name:null!==(i=this.sizeName)&&void 0!==i?i:""},quantity:this.positions.length,return_fee:this.positions[0].return_fee,rids:this.positions.map((e=>e.rid)),sale:this.sale,supplierId:this.supplierId,supplierName:this.supplierName}},e}(),p=function(){function e(){}var t=e.prototype;return t.setGlobals=function(e="",t="",i="",r=0,s=!1){this.lang=t,this.locale=i,this.order_uid=e,this.app_type=r,this.order_dt=Date.now(),this.with_logistic=s},t.setFormData=function(e){this.fd=[];for(const[t,i]of e)this.fd.push({key:t,value:i})},t.asFormData=function(){let e=new FormData;for(const t of this.fd)e.append(t.key,t.value);e.append("orderDetails.ClientOrderId",this.order_uid);for(let t=0;t<this.items.length;t++)e.append(`orderDetails.UserBasketItems[${t}].OrderedItemGuidsStr`,this.items[t].positions.map((e=>e.rid)).join(","));return e},t.setType=function(e){this.order_type=e},t.setItems=function(e,t,i){this.items=[],e.forEach((e=>{let t=new h;t.setProps(e,i),this.items.push(t)})),this.basket_params=t},t.setPayment=function(e,t,i=0){this.paymentCode=e.paymentType.code,this.pay_type=1,this.pay_mode=e.postPay?20:10,this.payment={amount:100*(t+i),goods_total:100*t,delivery_cost:100*i,currency:e.currency,merchant:e.merchantId,paymentType:e.paymentType},this.wbpay={return_url:`${e.returnUrl}?orderId=${this.order_uid}&ext=1`,token:{card_id:e.bankCardId}}},t.setDelivery=function(e={},t={}){var i;let r=new Date(e.deliveryDate);this.delivery={delivery_type:"self"===e.deliveryType?6:5,dst_office_id:e.dstOfficeId,delivery_time:Date.UTC(r.getFullYear(),r.getMonth(),r.getDate())/1e3,latitude:Number(e.lat),longitude:Number(e.lon),full_address:e.address,email:t.email,phone:null===(i=t.phone)||void 0===i?void 0:i.toString(),name:t.fullName,tin:`${t.inn}`}},t.updateState=function(e){this.state_dt=Date.now(),console.log(`[ORDER_SYNC]: order ${this.order_uid} state changed from ${this.state} to ${e}`),this.state=e},t.toStorageItem=function(){var e;return{app_type:this.app_type,lang:this.lang,locale:this.locale,pay_mode:this.pay_mode,sticker:this.sticker,timestamp:Math.round(this.order_dt/1e3),tracking:"",uid:this.order_uid,delivery:{address:null!==(e=this.delivery.full_address)&&void 0!==e?e:"",delivery_type:this.items[0].delivery_type,delivery_time:this.delivery.delivery_time,service:5==this.delivery.delivery_type?"wb_courier":"wb_pvz",dst_office_id:this.delivery.dst_office_id,latitude:this.delivery.latitude,longitude:this.delivery.longitude,city:"",country:"",email:"",first_name:"",phone:"",region:"",surname:"",zip:""},items:this.items.map((e=>e.toStorageItem())),payment:{amount:this.payment.amount,currency:this.payment.currency,delivery_cost:this.payment.delivery_cost,goods_total:this.payment.goods_total,merchant:this.payment.merchant}}},t.toPositionsModel=function({ctx:e,processing:t,options:i,withLogistic:r}={}){var s,a,n;const o={},d=[];for(const l of this.items)for(const u of l.positions){const h={brand:l.brand,characteristicId:l.chrt_id,code1S:l.nm_id,currency:null===(s=this.payment)||void 0===s?void 0:s.currency,deliveryPrice:((null===(a=this.payment)||void 0===a?void 0:a.delivery_cost)||0)/100,name:l.name,officeId:this.delivery.dst_office_id,orderDate:(new Date).toISOString(),paymentType:null===(n=this.payment)||void 0===n?void 0:n.type,price:(r?l.total_price+l.logisticsCost:l.total_price)/100,receiveDate:wb.helpers.date.formatEstimated(1e3*u.delivery_time),returnCost:(u.return_fee||0)/100,rId:u.rid,size:l.size,smId:u.delivery_type,source:"ordo_local",supplierId:l.supplierId,supplierName:l.supplierName,timestamp:Math.round(this.order_dt/1e3),version:6,logisticsCost:(this.with_logistic&&l.logisticsCost||0)/100};t&&(h.noTracking=!0,h.trackingStatus="В обработке",h.status="New");const p=new c(h,e,i);d.push(p),p.setLocation(o)}return{positions:d,locations:o}},e}(),y=function(){function e(){this._userId=this.$user.getUid(),this._isUserAuth?this._initInnerStorage():console.log(`[ORDER_SYNC]: user id is ${this._userId} - initializing empty inner storage`)}var t=e.prototype;return t.startSync=function(e){this._submitOrderUrl=e+"/lk/basket/spa/submitorder",this.submitOrderUrl={kursk:e+"/lk/kursk/submitorder"},this._notifyOrderSaveFailedUrl="/webapi/lk/newsfeed/notify/failedorder",this._userId=this.$user.getUid(),this._isUserAuth&&(this._initInnerStorage(),this._startSyncJob())},t._initInnerStorage=function(){try{let e=localStorage.getObject(this._storageKey);this._innerStorage=e?new Map(Object.entries(e).map((e=>{let t=e[1],i=Object.assign(new p,t);return i.items=t.items.map((e=>Object.assign(new h,e))),e[1]=i,e}))):new Map}catch(e){console.error(e),wb.spa.logError(e,"[ORDER_SYNC]: failed to read from localstorage",!0),this._innerStorage=new Map}},t._startSyncJob=async function(e=1e4){for(var t,i,r,s,a,n;;){let o=this.getOrders();if(0===o.size){await u(e);continue}let d=o.toArray();for(let o=0;o<d.length;o++){let l=d[o],c=l.order_uid;if("success"===l.state&&Date.now()-l.state_dt>6e4)this._removeOrder(c),await u(e);else if("accepted_locally"!==l.state)if(Date.now()-l.order_dt>(null!==(s=null===(r=null===(i=null===(t=wb.global)||void 0===t?void 0:t.settings)||void 0===i?void 0:i.variables)||void 0===r?void 0:r.localOrderTtl)&&void 0!==s?s:864e5))wb.spa.orderMetrics("lq_expired"),wb.spa.logError(new Error("[ORDER_SYNC]: order expired"),l),this._handleOrderSaveError(l),this._removeOrder(c);else if("need_resave"===l.state){let t=await this._saveOrder(l);if(t.needReSave){wb.spa.orderMetrics(l.state);continue}if(t.err){wb.spa.orderMetrics("fail"),wb.spa.logError(new Error(`[ORDER_SYNC]: order save failed with server error=${JSON.stringify(t.err)}`),l),this._handleOrderSaveError(l),this._removeOrder(c);continue}if(t.success){wb.spa.orderMetrics("success"),wb.spa.logError(new Error(`[ORDER_SYNC]: order save succeeded data=${JSON.stringify(t.data)}`),l);let i=null===(n=null===(a=t.data)||void 0===a?void 0:a.data)||void 0===n?void 0:n.paymentFailErrMsg;i&&this._handleOrderSaveError(l,i),this._removeOrder(c),await u(e)}else wb.spa.orderMetrics("success2"),wb.spa.logError(new Error(`[ORDER_SYNC]: order save failed redirect required data=${JSON.stringify(t.data)}`),l),this._handleOrderSaveError(l),this._removeOrder(c)}}await u(e)}},t._handleOrderSaveError=function(e,t=""){let i=e.items.map((e=>({characteristicId:e.chrt_id,quantity:e.quantity,cod1S:e.nm_id,targetUrl:e.targetUrl,subjectId:e.subject_id,subjectParentId:e.subjectParentId,reviewRating:e.reviewRating,feedbacks:e.feedbacks||e.commentsCount})));this._sendOrderSaveFailedNotification(t),this.$services.cartService.addManyItems(i)},t._sendOrderSaveFailedNotification=function(e=""){this.$httpClient.fetchJSON(`${this._notifyOrderSaveFailedUrl}?paymentFailErrMsg=${e}`,{method:"POST"})},t._storeOrder=function(e,t=!0){this._innerStorage.set(e.order_uid,e);try{t&&localStorage.putObject(this._storageKey,this._innerStorage.reduce(((e,t)=>(e[t.order_uid]=t,e)),{}))}catch(e){wb.spa.logError(e,"[ORDER_SYNC]: localstorage save failed",!0)}},t._removeOrder=function(e,t=!0){this._innerStorage.delete(e);try{t&&localStorage.putObject(this._storageKey,this._innerStorage.reduce(((e,t)=>(e[t.order_uid]=t,e)),{}))}catch(e){wb.spa.logError(e,"[ORDER_SYNC]: localstorage save failed",!0)}},t._saveOrder=async function(e){var t,i;try{const r={"X-Spa-Version":WbSpaModel.appVersion,Authorization:`Bearer ${this.$auth.jwt}`},s=this.submitOrderUrl[e.order_type]||this._submitOrderUrl;let a=await this.$httpClient.fetchJSON(s,{method:"POST",credentials:"include",body:e.asFormData(),headers:r},{noProcessResponse:!0});return-1===a.resultState?{err:new Error((null===(t=a.value)||void 0===t?void 0:t.message)||a.value),paymentFailErrMsg:a.value.paymentFailWithSign,payload:null===(i=a.value)||void 0===i?void 0:i.payload}:0===a.resultState?{success:!0,data:a.value}:3===a.resultState?{success:!0,redirect:!0,data:a.value}:{data:a.value}}catch(t){return wb.spa.logError(t,`[ORDER_SYNC]: initial order save failed order=${JSON.stringify(e)}`),e.payment.paymentType.isCreditCard||e.payment.paymentType.isStockExchange||e.payment.paymentType.isBalance?{needReSave:!0,err:t}:{needReSave:!1,err:t}}},t.saveLastOrderDetails=function(e){const t=`${this.$services.cartService.publicBasketApiUrl}/lk/basket/spa/order/savelastdetails`;return this.$httpClient.fetchJSON(t,{method:"POST",body:this.$helper.objectSerializer(e)})},t.getOrders=function(){return this._innerStorage},t.getOrderById=function(e){return this._innerStorage.get(e)},t.submitOrder=async function(e,t,i,r,s,a,n,o){let d=new p;d.setFormData(a),d.setType(o),d.setGlobals(e,"ru",wb.settings.currentLocale,"d"===wb.settings.displayMode?1:2,n),d.setPayment(i,s,r.deliveryPrice),d.setDelivery(r),d.setItems(t,null,r),d.updateState("accepted_locally"),this._isUserAuth&&this._storeOrder(d);let l=await this._saveOrder(d);return l.needReSave&&this._isUserAuth?(d.updateState("need_resave"),wb.spa.orderMetrics(d.state),this._storeOrder(d),{order:d}):(d.updateState("success"),this._isUserAuth&&this._storeOrder(d),l.order=d,l)},t.payForRids=async function({paymentAmount:e,rids:t=[],selectedCardId:i,returnUrl:r=""}){try{const s={paymentAmount:e,rids:t,returnUrl:r};return s["wlt"==i?"paymentCode":"selectedCardId"]=i,await this.$httpClient.fetchJSON("/webapi/lk/myorders/delivery/paytherest_v2",{method:"POST",body:this.$helper.objectSerializer(s)}),{success:!0}}catch(e){return{msg:e.message,success:!1}}},t.checkRidsPaymentStatus=async function(e=[]){try{const t=await this.$httpClient.fetchJSON("/webapi/lk/myorders/delivery/paymentstatus",{method:"POST",body:this.$helper.objectSerializer({rids:e})});return{status:0===t.status?3:t.status,reason:t.reason,params:t.params}}catch(e){return{status:3}}},t.getActive=async function({localRids:e,uid:t,options:i,ctx:r}={}){var s,a;try{const n=(null==e?void 0:e.length)>0?new URLSearchParams(e.map((e=>["rids",e]))):null,o=await this.$httpClient.fetchJSON("/webapi/v2/lk/myorders/delivery/active",{method:"POST",body:n,headers:{"X-Client-Time":this.$helper.getClientDt(),"X-Client-Id":t}},{timeout:6e3});return o.positions=null!==(a=null===(s=o.positions)||void 0===s?void 0:s.map((e=>(e.source="ordo",e.type="active",e.dateTime=new Date(e.dateTime),e.user=o.trackerKey,e.isoCurrency&&(e.currency=e.isoCurrency),new c(e,r,i)))))&&void 0!==a?a:[],o}catch(e){return{}}},t.cancelByRids=function(e){return this.$httpClient.fetchJSON("/webapi/lk/myorders/delivery/cancel",{method:"POST",body:new URLSearchParams(e.map((e=>["rids",e])))})},t.changeOffice=function(e,t){const i=this.$user.getUserGradeFromCache();return this.$httpClient.fetchJSON("/webapi/lk/myorders/delivery/changeoffice",{method:"POST",body:this.$helper.objectSerializer({rids:e,officeId:t,userGradeSigned:i})})},t.getOrrCourierPrice=function(e,t,i){return this.$httpClient.fetchJSON("/webapi/lk/myorders/delivery/courier/price",{method:"POST",body:this.$helper.objectSerializer({latitude:e,longitude:t,orderPrice:i})},{timeout:500}).catch((()=>({})))},t.setCourier=function({addressId:e,rids:t,cardId:i,deliveryPrice:r}){return this.$httpClient.fetchJSON("/webapi/lk/myorders/delivery/setcourier",{method:"POST",body:this.$helper.objectSerializer({addressId:e,rids:t,cardId:i,deliveryPrice:r}),headers:{"X-Client-Time":this.$helper.getClientDt()}})},r(e,[{key:"_isUserAuth",get:function(){return"0"!=this._userId}},{key:"_storageKey",get:function(){return`user-active-orders-${this._userId}`}}])}();window.__spaServiceManager__.register("orderService",y)})();
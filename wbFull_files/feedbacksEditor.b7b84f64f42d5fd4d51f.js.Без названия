(()=>{"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(t){var o=function(t,o){if("object"!=e(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,o||"default");if("object"!=e(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===o?String:Number)(t)}(t,"string");return"symbol"==e(o)?o:o+""}function o(e,o){for(var i=0;i<o.length;i++){var s=o[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,t(s.key),s)}}const i=Object.freeze({ok:WbSpaModel.prototype.$localziation.sizeMatchOkShort,smaller:WbSpaModel.prototype.$localziation.sizeMatchSmall,bigger:WbSpaModel.prototype.$localziation.sizeMatchBig}),s=Object.entries(i).map((([e,t])=>({name:t,value:e})));let n=function(){function e(e,t,o,i,n,r={}){var a;this.togglePreventBlur=(e,t)=>{this.$observable.setProperty({preventBlur:e}),e&&t.preventDefault()},this.imtId=e,this._feedbackSubmited=!1,this.nmId=t.nmId,this.goodName=t.goodName,this.brandName=t.brandName,this.backArrow=t.backArrow||!1,this.isDelivery=t.isDelivery||!1,this.sellerId=t.sellerId,this.feedbacksPaymentInfo=t.feedbacksPaymentInfo,this.feedbackGoods=o.feedbackGoods,this.getFeedBacksProduct=o.getFeedBacksProduct,this.isUnauthorize=o.isUnauthorize,this.unathorizeMsg=o.unathorizeMsg,this.isBanned=o.isBanned,this.colors=o.colors,this.namelessColor=o.namelessColor,this.sizes=o.sizes,this.sizeless=o.sizeless,this.visibilities=null===(a=o.visibilities)||void 0===a?void 0:a.slice(0,2).reverse(),this.selectedCod1S=o.selectedCod1S,this.selectedSizeName=o.selectedSizeName,this.selectedVisibility=o.selectedVisibility,this.selectedRating=o.selectedRating||0,this.onSubmit=o.onSubmit,this.hoverRating=0,this.sizeMatches=s,this.selectedBubbles=[],this.text="",this.pros="",this.cons="",this.textTrim="",this.prosTrim="",this.consTrim="",this.hideSizes=this._needHideSizes(),this.imageUploader=i,this.videoUploader=n,this.commentsPhotoEnabled=!t.adult,this.commentsVideoEnabled=!t.adult,this.statParams=r,this.flagCommentFocus=!1,this.preventBlur=!1,this.backBlock=this.backBlock.bind(this),this.submitComment=this.submitComment.bind(this),this.feedbackPointsState.depends=["text","imageUploader.itemsIds^length","imageUploader.items^length","videoUploader.videoId"]}var t,i,n,r=e.prototype;return r._startTooltipTimer=function(e){0!=this.tooltipData.timer&&(this.timerInterval=setInterval((()=>{$.observable(this.tooltipData).setProperty("timer",this._getTooltipTimer(e)),0==this.tooltipData.timer&&clearInterval(this.timerInterval)}),1e3))},r._stopTooltipTimer=function(){this.timerInterval&&clearInterval(this.timerInterval)},r._getTooltipTimer=function(e){var t,o,i,s;const n="Purchased"==e.status?e.lastDate:null,r=null!==(s=null===(i=null===(o=null===(t=wb.global)||void 0===t?void 0:t.settings)||void 0===o?void 0:o.variables)||void 0===i?void 0:i.feedbacksForPointsPeriodDays)&&void 0!==s?s:5;return $.views.converters.differenceDatesInSeconds(n,r)},r.setCommentFocus=function(e,t){if(!e&&e&&this.preventBlur||this.$observable.setProperty({flagCommentFocus:e}),e){const e={prosTextarea:"Что понравилось больше всего?",consTextarea:"Опишите недостатки товара",commentTextarea:"Поделитесь впечатлениями"};t.currentTarget.placeholder=e[t.currentTarget.id]}else t.currentTarget.placeholder=" "},r.toggleBubbleSelected=function(e){const{data:t}=$.view(e.currentTarget),o=this.selectedBubbles.indexOf(t.text);-1!==o?($.observable(t).setProperty({isActive:!1}),$.observable(this.selectedBubbles).remove(o)):($.observable(t).setProperty({isActive:!0}),$.observable(this.selectedBubbles).insert(t.text))},r._needHideSizes=function(){var e;if(this.sizeless)return!0;const t=e=>!!(null==e?void 0:e.value)&&"unknown"!==e.value;return!t(this.selectedSizeName)&&(!(null===(e=this.sizes)||void 0===e?void 0:e.length)||1==this.sizes.length&&!t(this.sizes[0]))},e.showFeedbacksPopup=async function(t,o,i,s,n,r={},a,l){var d;const c=new e(t,o,i,s,n,r);c.step=1,c.product=null===(d=c.getFeedBacksProduct)||void 0===d?void 0:d.call(c,c.feedbackGoods,c.selectedCod1S.value,c.selectedSizeName.value),c.staticProduct=l,c.badReasonBubbles=await WbSpaModel.prototype.$services.feedbacksService.loadBadReasonBubbles(l),c.feedbacksPaymentInfo&&(c.tooltipData={timer:c._getTooltipTimer(c.product)},c._startTooltipTimer(c.product)),c.setPopup(wb.popup.showCustomPopup({useHtml:!0,popupClassesList:["popup-review","shown"],contentClasses:["popup__content"],useCenteredFunction:!0,lockScroll:!1,showCross:!1,onHide:(e,t)=>{null==a||a(c._feedbackSubmited,!!(null==t?void 0:t.isTrusted)),c._stopTooltipTimer(),3==c.step&&c.sendHowtoClosedEvent()},onShowAsync:async t=>{e.template.link(t.querySelector(".popup__content"),c),t.classList.add("popup--full--height"),window.requestAnimationFrame((()=>t.classList.add("slideUp"))),c.imageUploader.init(t),c.videoUploader.init(t)}}))},r.checkInfoAndTryGoToStep2=function(e){this.feedbackPointsState().notFilled.length>0&&this.feedbacksPaymentInfo?(this.$observable.setProperty({step:2}),this.popup.popup.classList.remove("popup--full--height"),this.popup.centered()):this.submitComment(e)},r.goToStep=function(e,t=!0){if(this.$observable.setProperty({step:e}),this.popup.centered(),1==e)if(t){if(this.popup.popup.classList.add("popup--full--height"),3===this.feedbackPointsState().notFilled.length||this.feedbackPointsState().filled.text&&!this.feedbackPointsState().filled.photo&&!this.feedbackPointsState().filled.video)return;if(!this.feedbackPointsState().filled.text&&this.feedbackPointsState().filled.photo&&this.feedbackPointsState().filled.video)return void this._focusTextareaComment();if(!this.feedbackPointsState().filled.photo&&this.feedbackPointsState().filled.video&&this.feedbackPointsState().filled.text&&t)return void this.openWindowForUploadMedia("img-load");if(!this.feedbackPointsState().filled.video&&this.feedbackPointsState().filled.photo&&this.feedbackPointsState().filled.text&&t)return void this.openWindowForUploadMedia("video-load")}else this.flagCommentFocus&&this._focusTextareaComment();3==e&&this.popup.popup.classList.add("popup--full--height")},r.openWindowForUploadMedia=function(e){const t=document.getElementById(e);t?t.click():console.error(`Input with id "${e}" not found.`)},r._focusTextareaComment=function(){const e=document.getElementById("commentTextarea");null==e||e.focus()},r.autoResizeTextarea=function(e){e.target.style.height="auto",e.target.style.height=e.target.scrollHeight+"px",this._trimText()},r.destroy=function(){var e,t;null===(e=this.imageUploader)||void 0===e||e.destroy(),null===(t=this.videoUploader)||void 0===t||t.destroy()},r.setPopup=function(e){this.popup=e},r.processRating=function(e){const{data:t}=$.view(e.currentTarget);$.observable(this).setProperty({selectedRating:t})},r.addImage=function(e){return this.$analitic.sendEvent("Item_Feedback_PhotoAdd_T",{}),this.imageUploader.loadImageAsync(e)},r.addVideo=function(e){return this.videoUploader.loadVideoAsync(e)},r.removeImages=function(e=!1,t){t.preventDefault(),t.stopPropagation(),this.imageUploader.processingImage=!1,$.observable(this.imageUploader).setProperty({photosAreUploading:!1,imagesError:null});const o=this.imageUploader.abortControllerData;o.abortController&&o.signal&&(this.$analitic.sendEvent("Item_Feedback_PhotoDelete_T",{}),o.abortController.abort("Пользователь отменил загрузку изображения"),o.abortController=null,o.signal=null,e&&this.$moduleLoader.execModule("bottomNotificationPanel","showNotification",[11]))},r.removeImage=function(e=!1,t){const{data:o}=$.view(t.currentTarget);if(!o)return;this.$analitic.sendEvent("Item_Feedback_PhotoDelete_T",{});const i=this.imageUploader.items.findIndex((e=>e==o));o.abortController&&o.signal&&(o.abortController.abort("Пользователь отменил загрузку изображения"),o.abortController=null,o.signal=null,e&&this.$moduleLoader.execModule("bottomNotificationPanel","showNotification",[11])),this.imageUploader.removeItem(i)},r.removeVideo=function(e=!1,t){this.videoUploader.processingVideo=!1,$.observable(this.videoUploader).setProperty({items:[],videoDuration:null,videoId:null,videoIsUploading:!1,videoPosterSrc:null,videoError:null}),this.videoUploader.abortController&&this.videoUploader.signal&&(this.videoUploader.abortController.abort("Пользователь отменил загрузку видео"),this.videoUploader.abortController=null,this.videoUploader.signal=null,e&&this.$moduleLoader.execModule("bottomNotificationPanel","showNotification",[12])),this.videoUploader.removeItem(0)},r.repeatUploadingPhoto=function(e){const{data:t}=$.view(e.target);return this.imageUploader.fetchPhoto(t.urlData,t)},r.repeatUploadingVideo=function(){return this.videoUploader.fetchVideo(this.videoUploader.items[0],!0)},r.feedbackPointsState=function(){var e,t,o;const i=["text","video","photo"];let s=0,n=[],r={};r={text:this.text.trim().length>=10||this.pros.trim().length>=10||this.cons.trim().length>=10,photo:!!(null===(e=this.useNewService?this.imageUploader.itemsIds:this.imageUploader.items)||void 0===e?void 0:e.length),video:!!this.videoUploader.videoId},r.text||n.push("text"),r.photo||n.push("photo"),r.video||n.push("video");for(const e of i)r[e]&&(s+=null!==(o=null===(t=this.feedbacksPaymentInfo)||void 0===t?void 0:t[e])&&void 0!==o?o:0);return{currentSum:s,filled:r,notFilled:n}},r.submitComment=function(e){var t,o,i,s,n,r;if($.observable(this).setProperty({formIsTouched:!0}),!e.validate())return;if(this.submitting)return;$.observable(this).setProperty("submitting",!0);const a={text:null!==(t=this.text)&&void 0!==t?t:"",pros:this.pros,cons:this.cons,matchingSize:null!==(i=null===(o=this.selectedSizeMatch)||void 0===o?void 0:o.value)&&void 0!==i?i:"",productValuation:null!==(s=this.selectedRating)&&void 0!==s?s:0,photo:null!==(n=this.imageUploader.itemsIds)&&void 0!==n?n:[],video:this.videoUploader.videoId&&this.videoUploader.videoDuration?{id:this.videoUploader.videoId,durationSec:this.videoUploader.videoDuration}:null,bables:this.selectedBubbles,includedInPointsPromotion:this._checkPointsPromotionEligibility()};this.$analitic.sendEvent("Item_Feedback_GiveFeedback_Send",{location:null!==(r=this.statParams.location)&&void 0!==r?r:"",item_id:this.nmId,type:a.photo?"photo":"no_photo",review_text:a.text?"yes":"no"}),this._checkFeedbackContentAsync(),this._uploadFeedbackAsync(a).catch((e=>{if(e.isCustomError)return wb.popup.showFeedbackError(e);this._showUnavailableFeedbacksService()})).finally((()=>$.observable(this).setProperty("submitting",!0)))},r._checkPointsPromotionEligibility=function(){const e=new Date(this.product.lastDate).addDays(5),t=new Date;return this.feedbackPointsState().currentSum>0&&t<e&&"Purchased"==this.product.status},r._checkFeedbackContentAsync=function(){var e,t;return wb.global.settings.switches.enableCommentContentCheck?this.$httpClient.fetchJSON("/webapi/spa/product/predictcomment",{method:"POST",body:new URLSearchParams({text:this.text,code1S:null!==(t=null===(e=this.selectedCod1S)||void 0===e?void 0:e.value)&&void 0!==t?t:this.namelessColor.cod1S})},{redirectUnauth:!0}):Promise.resolve(!1)},r.backBlock=function(){this.popup.close(),this._stopTooltipTimer()},r._trimText=function(){$.observable(this).setProperty({textTrim:this.text.trim()}),$.observable(this).setProperty({prosTrim:this.pros.trim()}),$.observable(this).setProperty({consTrim:this.cons.trim()})},r._uploadFeedbackAsync=function(e){var t;const o={comment:e,sellerId:this.sellerId,feedBacksProduct:null===(t=this.getFeedBacksProduct)||void 0===t?void 0:t.call(this,this.feedbackGoods,this.selectedCod1S.value,this.selectedSizeName.value)};return this.$services.feedbacksService.sendFeedback(o,(()=>{var t;$.observable(this).setProperty({ready:!1}),this._feedbackSubmited=!0,this.popup.close(),localStorage.removeItem("offerRateMain"),null===(t=this.onSubmit)||void 0===t||t.call(this,e),e.includedInPointsPromotion?this._renderPostFeedbackPopup(!1):this._renderPostFeedbackPopup(!0),this.$moduleLoader.loadServiceAsync("productFeedbacksService").then((()=>this.$services.productFeedbacksService.dropFromCache(this.imtId)))}).bind(this),this._showUnavailableFeedbacksService.bind(this),this.backBlock)},r._showDiscussionPopupAsync=function(){return $.views.loadTemplateAsync("spaNotCommentPopup").then((e=>(wb.popup.showCustomPopup({useCenteredFunction:!0,useHtml:!0,lockScroll:!0,popupClassesList:["popup-complain-feedback","shown"],contentClasses:["popup__content"],msg:e.render()}),Promise.resolve()))).catch((e=>(console.error(e.message),Promise.reject("Template cannot be loaded"))))},r._renderPostFeedbackPopup=async function(e){const t=await $.views.loadTemplateAsync("afterFeedbackMsgPopup");this.afterFeedbackPopup=wb.popup.showCustomPopup({useCenteredFunction:!0,useHtml:!0,lockScroll:!0,popupClassesList:["popup-after-feedback","shown"],contentClasses:["popup__content"],msg:t.render(),onShow:t=>{const o=t.querySelector(".j-standard"),i=t.querySelector(".j-feedbackforpoints"),s=t.querySelectorAll(".j-rules");e?i.classList.add("hide"):o.classList.add("hide"),s.forEach((e=>null==e?void 0:e.addEventListener("click",(()=>this.showRulesPopup()))))}})},r.showRulesPopup=async function(){const e=await $.views.loadTemplateAsync("popupFeedbackRules");wb.popup.showCustomPopup({lockScroll:!0,popupClassesList:["popup-feedback-rules","shown"],contentClasses:["popup__content"],useCenteredFunction:!0,useHtml:!0,msg:e.render(),onShow:()=>{var e;null===(e=this.afterFeedbackPopup)||void 0===e||e.close()}})},r.sendHowtoClickedEvent=function(){var e,t,o,i;this.$analitic.sendEvent("Item_FeedbackRules_T",{item_id:this.nmId,subject_id:this.product.subjectId,subject_parent_id:null===(t=null===(e=this.staticProduct)||void 0===e?void 0:e.data)||void 0===t?void 0:t.subject_root_id}),this.$analitic.sendEvent("Item_FeedbackRules_V",{item_id:this.nmId,subject_id:this.product.subjectId,subject_parent_id:null===(i=null===(o=this.staticProduct)||void 0===o?void 0:o.data)||void 0===i?void 0:i.subject_root_id})},r.sendHowtoClosedEvent=function(){var e,t;this.$analitic.sendEvent("Item_FeedbackRules_Close",{item_id:this.nmId,subject_id:this.product.subjectId,subject_parent_id:null===(t=null===(e=this.staticProduct)||void 0===e?void 0:e.data)||void 0===t?void 0:t.subject_root_id})},r._showUnavailableFeedbacksService=function(){$.views.loadTemplateAsync("feedbackSubmitError").then((e=>{if(!e)return Promise.reject();wb.popup.showCustomPopup({useHtml:!0,msg:e.render(),popupClassesList:["popup-alert","popup-error-feedbacks","shown"],contentClasses:["popup__content"],useCenteredFunction:!0,modal:!1})})).catch((e=>{wb.popup.renderModalError(this.$localziation.serverError)}))},t=e,n=[{key:"imageLoaderSettings",get:function(){return{maxItemsCount:5,useCropper:!1,uploadLimit:31457280,supportedExtensions:["jpg","jpeg","png","bmp","gif"],useDnD:!0,messages:{wrongFileSize:"Слишком большое фото: ограничение — {0}&nbsp;мб",wrongFileExtension:"Это фото не подходит: загрузите в формате {0}",filesLimitReached:"Не получилось загрузить {0}&nbsp;фото, максимальное количество&nbsp;—&nbsp;{1}",wrongImageResolution:"Фото не подходит: нужно не&nbsp;меньше&nbsp;{0}&nbsp;px&nbsp;по ширине и&nbsp;{1}&nbsp;px&nbsp;по&nbsp;высоте",errorImageLoad:"Не получилось загрузить, попробуйте&nbsp;еще&nbsp;раз",severalErrors:"Не получилось загрузить {0}&nbsp;фото"}}}},{key:"videoLoaderSettings",get:function(){return{maxItemsCount:1,uploadLimit:524288e3,supportedExtensions:["mp4","mov","x-m4v"],maxVideoDuration:120,useDnD:!0,messages:{wrongFileSize:"Слишком большое видео: ограничение — {0}&nbsp;мб",wrongFileExtension:"Видео не подходит: загрузите в формате {0}",filesLimitReached:"Не получилось загрузить {0}&nbsp;видео, максимальное количество&nbsp;—&nbsp;{1}",wrongVideoResolution:"Разрешение видео должно быть не&nbsp;менее&nbsp;{0}px&nbsp;по&nbsp;ширине и&nbsp;{1}px&nbsp;по&nbsp;высоте",errorVideoLoad:"Не получилось загрузить, попробуйте&nbsp;еще&nbsp;раз",severalErrors:"Не получилось загрузить {0}&nbsp;видео",wrongVideoDuration:"Видео длится больше {0}&nbsp;минут, загрузите другое"}}}}],(i=null)&&o(t.prototype,i),n&&o(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}();window.__spaModuleManager__.register("feedbacksEditor",n)})();
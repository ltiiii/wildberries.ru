/*! For license information please see groupedDeliveriesService.623d50ef701a7e56e95e.js.LICENSE.txt */
(()=>{"use strict";var e={13504:(e,t,i)=>{i.d(t,{AM:()=>y,DO:()=>l,F_:()=>o,NG:()=>h,QQ:()=>c,Yo:()=>s,bM:()=>n,dY:()=>a,f6:()=>r,r8:()=>u,vh:()=>d,wG:()=>p});const s=Object.freeze({Accepted:0,Assembling:1,Rejected:2,Processing:3,Completed:5,ValidateFail:6,Validated:7,Error:8}),r=Object.freeze({Unknown:-1,NotPaid:1,PaySent:2,PayFail:3,Paid:4,Refunded:5}),o=(Object.freeze({Accepted:0,New:1,Failed:2,Processing:4,Completed:5}),22),a=(r.NotPaid,r.PaySent,r.PayFail,[s.Accepted,s.Assembling,s.Processing,s.Validated]),n=[s.Rejected,s.Completed],c=new Set(["SRC","SRD","SRF","SRG","SRK","SRM","SRN","SRO","SRP","SRR","SRT","SRV"]),d=new Set(["CIF","CRE","IWB","WIF","WIS","XYZ","PDL","CWB","BPL"]),l=6,u=14,p=4,h=100,y=e=>{var t,i,s,r;const o=null!==(r=null===(s=null===(i=null===(t=wb.global)||void 0===t?void 0:t.settings)||void 0===i?void 0:i.variables)||void 0===s?void 0:s.failedPaymentsDisplayMinutes)&&void 0!==r?r:0;return Math.floor(Math.max(0,new Date(e).addMinutes(o)-new Date)/1e3)}},19372:(e,t,i)=>{i.d(t,{A:()=>c});var s=i(92901),r=i(13504);const o=Object.freeze({5:"Курьерская",6:"Пункт выдачи",17:"Грузовая доставка",30:"Пункт выдачи",63:"СЦ / Склад",83:"Курьерская",86:"Постамат"});let a=function(){function e(e,t,i){t!=e&&(e>0||e)?(this.type="shard",this.value=e>0?e:1):(this.type="user_id",this.value=t>0?t:i>0?i:1)}return e.prototype.toString=function(){return`${this.type}=${this.value}`},e}(),n=function(){function e(e,t,i){Object.assign(this,e),this.isCanceling&&(this.canPrepay=!1),this._ctx=t,this.options=null!=i?i:{},wb.xnm.expandSaleConditions(this,null,1),this.isPrepaid&&delete this.isVerificationReturn,this.setIsOnShelf(),this.isPdlPostPayment="CSH"===this.paymentType&&"PDL"===this.paymentSystem}e.fromNNSZ=function(e,t,i){var s;return null!==(s=null==e?void 0:e.rids.map(((s,o)=>{var a;const n=null===(a=e.services)||void 0===a?void 0:a.find((e=>{var t;return(null!==(t=e.rid_ref)&&void 0!==t?t:0)==o&&4==e.type})),c=new this({_debug:e,address:e.full_address,brand:s.brand,canCancel:s.can_reject_delayed,canCancelDelayed:s.can_reject_delayed,characteristicId:s.chrt_id,code1S:s.nm_id,color:s.color,currency:e.currency,dateTime:new Date(1e3*s.delivery_time),deliveryPrice:((null==n?void 0:n.price)||0)/100,latitude:e.latitude,longitude:e.longitude,name:s.name,officeId:e.dst_office_id,orderDate:new Date(1e3*e.order_dt),orderId:e.id,paymentSaleAmount:(s.discount||0)/100,paymentSaleType:s.wctype_id,payError:s.error,payLink:s.link_3_ds,payState:s.pay_state,pid:6===s.delivery_type?e.dst_office_id:null,price:s.total_price/100,prepaidDelivery:((null==n?void 0:n.pay_state)===r.f6.Paid?n.price:0)/100,rId:s.uid,returnCost:(s.return_fee||0)/100,logisticsCost:(e.logistic_with&&s.logistic_cost||0)/100,saleConditions:s.sale_conditions,size:s.size,smId:s.delivery_type,source:"nnsz",state:s.state,sticker:e.sticker,subjectId:s.subject_id,timestamp:1e3*e.order_dt,trackerShardKey:t.$auth.jwtData.shard_key,type:"active",wh:s.store_id,sellerId:s.seller_id},t,i);return c.payFailed&&0==(0,r.AM)(c.orderDate)&&(c.type="archive"),c.paymentSaleType>0&&(c.price-=c.paymentSaleAmount),c.payState===r.f6.NotPaid||c.payState==r.f6.PaySent?c.archive||(c.isPrepaid=!1,c.canPrepay=!0,c.selectedForPay=!0,c.prepaid=0):c.payState===r.f6.PayFail?(c.canPrepay=!0,c.selectedForPay=!0,c.prepaid=0,[r.Yo.Validated,r.Yo.Error].includes(this.state)||(c.isPrepaid=!1)):c.payState===r.f6.Paid?(c.isPrepaid=!0,c.archive||(c.prepaid=c.price,c.prepaidDelivery=c.deliveryPrice)):c.payState!==r.f6.Refunded&&c.state!==r.Yo.Completed||(c.archive=!0,c.payState===r.f6.Refunded&&(c.refunded=!0),c.trackingStatus="Заказ завершен",c.noTracking=!0,delete c.trackingStatusId,delete c.trackingStatusReady),c})))&&void 0!==s?s:[]};var t=e.prototype;return t.openProductPopup=function(e,t){if(!e.target.classList.contains("j-non-refundable")&&!e.target.classList.contains("rate-star__item")){var i=t.view.data;this._ctx.$productCardPopup.show(i.code1S,i.characteristicId)}},t.setDeliveryConfirmation=function(){!wb.global.settings.switches.enableCargoDeliveryUpdate||wb.global.settings.switches.enableCargoDeliveryUpdateV2||17!==this.smId||2!==(new Date).daysBetween(new Date(this.dateTime))||wb.global.userSettings.confirmed.includes(this.rId)||(this.needsDeliveryConfirmation=!0)},t.setIsOnShelf=function(e){if(6===this.smId&&(this.trackingStatusId?this.trackingStatusReady:this.readyToReceiveToday)&&("ordo"==this.source&&$.observable(this,e).setProperty({isOnShelf:!0}),!this.expirationTimestamp&&this.lastDate&&r.r8>0&&$.observable(this,e).setProperty({expirationTimestamp:new Date(this.lastDate).addDays(r.r8)}),this.expirationTimestamp&&r.wG>0)){(new Date).daysBetween(new Date(this.expirationTimestamp))<=r.wG&&$.observable(this,e).setProperty({unclaimedCost:r.NG})}wb.global.settings.switches.enableCargoDeliveryUpdateV2&&"ordo"==this.source&&300==this.trackingStatusId&&17===this.smId&&new Date(this.orderDate).daysBetween(new Date)<10&&!wb.global.userSettings.confirmed.includes(this.rId)&&($.observable(this,e).setProperty({needsDeliveryUpdate:!0}),3===(new Date).daysBetween(new Date(this.dateTime))&&(this.needsDeliveryUpdateTimeOut=!0))},t.setCancel=function(e){var t,i,s,o,a,n,c;if(this.canCancel||this.cancelProcessed||this.paymentType&&(r.QQ.has(this.paymentType.toUpperCase())||r.vh.has(this.paymentType.toUpperCase())||r.vh.has((null===(t=this.paymentSystem)||void 0===t?void 0:t.toUpperCase())||"")))return this;const d=this._ctx.$services.storeService.storesMap;if(this.wh>0&&(d.isForeign(this.wh)||!d.needVerification(this.wh,this.country))){let t=0;if(d.isMp(this.wh)||d.isCargoStore(this.wh)||d.isDbs(this.wh)?(null===(o=null===(s=null===(i=wb.global)||void 0===i?void 0:i.settings)||void 0===s?void 0:s.variables)||void 0===o?void 0:o.minutesForMPOrderCancel)>0&&(t=wb.global.settings.variables.minutesForMPOrderCancel):(null===(c=null===(n=null===(a=wb.global)||void 0===a?void 0:a.settings)||void 0===n?void 0:n.variables)||void 0===c?void 0:c.minutesForWBOrderCancel)>0&&(t=wb.global.settings.variables.minutesForWBOrderCancel),t>0&&300==this.trackingStatusId&&new Date(this.orderDate).addMinutes(t)>=new Date)return $.observable(this,e).setProperty({canCancel:!0}),this}return this},t.setChangeOffice=function(e){return 300==this.trackingStatusId&&6==this.smId&&"ordo"==this.source&&new Date(this.orderDate).addMinutes(30)>=wb.helpers.date.serverDate&&$.observable(this,e).setProperty({canChangeOffice:!0}),this},t.showStatusPopup=function(e,t){if(this.loading)return!1;this.loading=!0;var i=t.view.ctxPrm("delivery"),s=null==i?void 0:i.deliveryWay,r=i.products.findIndex((e=>e.rId===this.rId));return this._ctx.$moduleLoader.loadModuleAsync("trackingPopup").then((e=>{(new e).showStatusPopup({rid:this.rId,smId:this.smId,receiveDate:this.receiveDate,isCourier:this.readyToReceiveToday&&"Courier"==s,delayed:this.delayed,name:this.name,brand:this.brand,expirationTimestamp:this.expirationTimestamp,customTrackerStatus:this.customTrackerStatus,trackerKey:this.trackerKey,products:i.products,activeSlide:r}),this.loading=!1})).catch((e=>{console.log(e),this.loading=!1})),!1},t.cancelItem=async function(e,t){await wb.popup.confirm($.views.templates.cancelConfirmPopup.render(this),{yes:"Отменить",no:"Оставить",showCross:!0,noBtnClassList:["popup__btn-base","btn-minor"],classList:["shown","popup-cancel-confirm"],modal:!0})&&this._cancelItem(e,t)},t._cancelItem=function(e,t){if(this.isCanceling||this.cancelProcessed)return!1;$.observable(this).setProperty({isCanceling:!0});return("nnsz"==this.source?this._ctx.$getService("wbxOrderService").then((e=>e.cancelByRid({orderId:this.orderId,rid:this.rId,byDelay:this.canCancelDelayed}))).then((({success:e,error:t}={})=>{t?($.observable(this).setProperty({isCanceling:!1}),wb.popup.renderModalError(t)):!1===e&&($.observable(this).setProperty({isCanceling:!1,canCancel:!1,cancelProcessed:!0}),wb.popup.renderModalError("Товар нельзя отменить"))})):this._ctx.$getService("orderService").then((e=>e.cancelByRids([this.rId]))).then((e=>{var i;if(null==e?void 0:e.error)return $.observable(this).setProperty({isCanceling:!1}),void wb.popup.renderModalError("Не удалось отменить доставку");if(null==e?void 0:e.notExists){const e=null!==(i=t.view.ctx.parentView)&&void 0!==i?i:t.view;let s=e.get("array");if((null==s?void 0:s.data)&&($.observable(s.data).remove(e.getIndex()),0==s.data.length)){let e=s.parent;const t=null==e?void 0:e.get("array");(null==t?void 0:t.data)&&$.observable(t.data).remove(e.getIndex())}}}))).then((()=>{this.isCanceling?this._ctx.updateItems([this.rId],{isCanceling:!0}):this.cancelProcessed&&this._ctx.updateItems([this.rId],{cancelProcessed:!0}),this._ctx.$moduleLoader.execModule("bottomNotificationPanel","showNotification",[0,"Через несколько секунд товар пропадёт из доставок"])})).catch((e=>{e.isCustomError||console.log(e),$.observable(this).setProperty({isCanceling:!1}),wb.popup.renderModalError(e.isCustomError?e.message:"Ошибка при отмене доставки")})),!1},t.onShowAllStatus=function(e){const t=e.target.closest("li");null==t||t.classList.add("hide");const i=document.querySelector(".j-status-list"),s=null==i?void 0:i.querySelectorAll(".j-status");null==s||s.forEach((e=>e.classList.remove("hide")))},t.startSellerChat=function(e){const{rId:t,name:i,brand:s,color:r,size:o,code1S:a,orderDate:n,sellerId:c,sellerName:d,price:l,currency:u,shkId:p,country:h}=this;if(!c)return;const y=`seller_${c}`,m=[i];s&&m.push(`бренд ${s}`),o&&"0"!=o&&m.push(`размер ${o}`),a>0&&m.push(`артикул ${a}`),n&&m.push(`товар оформлен ${new Date(n).format("dd.MM.yyyy")}`);const v=`Здравствуйте! У меня вопрос по товару "${m.join(", ")}"`;wb.spa.getMainLayout().header.onlineChat.showChat({chatId:y,sellerId:c,text:v,title:d,goodCard:{rid:t,nmID:a,brand:s,name:i,color:r,shkID:p,size:o,price:Math.round(100*l),priceCurrency:u,date:n,site:null==h?void 0:h.toUpperCase(),statusID:(()=>this.trackingStatusId>=300&&this.trackingStatusId<=399?1:this.trackingStatusId>=10&&this.trackingStatusId<=99?2:210==this.trackingStatusId?4:260==this.trackingStatusId?5:this.trackingStatusId>=100&&this.trackingStatusId<=199||this.trackingStatusId>=500&&this.trackingStatusId<=599?3:0)()}})},t.setLocation=function(e){let t=this.address&&isNaN(this.address)?this.address:"Доставка";switch(this.pid||6!=this.smId||(this.pid=this.officeId),!0){case 6==this.smId||30==this.smId:this.locationId=`${this.smId}_${this.officeId}`;break;case 86==this.smId&&this.pid>0:this.locationId=`${this.smId}_${this.pid}`;break;default:this.locationId=`${this.smId}_${wb.helpers.getHashCode(t)}`}e[this.locationId]||(e[this.locationId]={address:t},this.latitude>0&&this.longitude>0&&(e[this.locationId].mapLocation={coordinates:`${this.latitude},${this.longitude}`,hasBalloon:!1,iconContent:t,latitude:this.latitude,longitude:this.longitude,useDefaultIcon:!0}),e[this.locationId].deliveryType=o[this.smId])},e.sortPositions=function(e,t){if(e.archive)return 1;if(t.archive)return-1;function i(e){switch(e){case 16:return 260;case 8:return 210;case 4:return 100;case 2:return 1;case 1:return 300}}const s=e.trackingStatusId||i(e.status),r=t.trackingStatusId||i(t.status),o=r-s;if(0!=o){if(260==s||555==s||210==s&&260!=r&&555!=r)return-1;if(260==r||555==r||210==r&&260!=s&&555!=s)return 1}if(!e.dateTime&&t.dateTime)return-1;if(e.dateTime&&!t.dateTime)return 1;if(e.dateTime&&t.dateTime){const i=e.dateTime-t.dateTime;if(0!=i)return i}return 300<=s&&s<=399?1:300<=r&&r<=399?-1:500<=s&&s<=599?1:500<=r&&r<=599?-1:o},t.getStatusReceiveDate=function(){const{dateTime:e,timeFrom:t,timeTo:i}=this,s=new Date,r=(new Date).daysBetween(e),o=new Date(`${$.views.converters.formatDate(e,"yyyy/MM/dd")} ${t}`),a=new Date(`${$.views.converters.formatDate(e,"yyyy/MM/dd")} ${i}`),n=$.views.converters.formatTimeStr(t);return 1===r?`Завтра с ${n} до ${i}`:2===r?`Послезавтра с ${n} до ${i}`:s>a?"Скоро будет":0===r&&s<o?`Сегодня с ${n} до ${i}`:0===r?`Сегодня до ${i}`:$.views.converters.formatDate(e,`d MMMM, ${t}&#8209;${i}`)},t.setCustomTrackingStatus=function(e){e==r.Yo.Accepted?this.trackingStatus="Оформлено":e==r.Yo.ValidateFail||e==r.Yo.Rejected?this.trackingStatus="Отмена":e==r.Yo.Assembling?this.trackingStatus="На сборке":e!=r.Yo.Processing&&e!=r.Yo.Validated||(this.trackingStatus="В обработке")},(0,s.A)(e,[{key:"trackerKey",get:function(){return new a(this.trackerShardKey,this.user)}},{key:"payFailed",get:function(){return this.payState===r.f6.PayFail&&("nnsz"!=this.source||[r.Yo.Validated,r.Yo.Error].includes(this.state))}},{key:"verificationRequired",get:function(){return!!(1&~this.options.verificationLevel)&&this._ctx.$services.storeService.storesMap.needVerification(this.wh,this.country)}},{key:"isHumanitarianAid",get:function(){return!(8&~this.orderOptionsFlags)}}])}();const c=n},22292:(e,t,i)=>{i.d(t,{A:()=>g});var s=i(92901);function r(e,t){return r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},r(e,t)}var o=i(13504);const a=function(){function e(){this.delivery={address:"",city:"",country:"",email:"",first_name:"",phone:"",region:"",surname:"",zip:""},this.payment={amount:0,delivery_cost:0,goods_total:0},this.items=[],this.rid_states=[]}return e.isRidStateCompleted=function({state:e,pay_state:t}){return!![o.Yo.Rejected,o.Yo.ValidateFail].includes(e)||(e===o.Yo.Completed&&t===o.f6.Refunded||e===o.Yo.Completed&&t===o.f6.Paid)},e.isCompleted=function(e){if(e.is_finished)return!0;const t=new Date(1e3*(e.timestamp||0));if(!e.rid_states||0==e.rid_states.length)return!1;const i=t.addDays(o.F_);return!(e.rid_states||[]).some((({state:e,pay_state:t,service_pay_state:s})=>![o.Yo.Rejected,o.Yo.ValidateFail].includes(e)&&((e!==o.Yo.Completed||t!==o.f6.Refunded)&&!(e===o.Yo.Completed&&t===o.f6.Paid&&i<new Date))))},e.trySetPositionProps=function(e,t,i){var s;if(!i)return!1;const r=null===(s=e.rid_states)||void 0===s?void 0:s.find((e=>e.rid==t));if(!r)return!1;const{isCanceling:a,isPrepaid:n,selectedForPay:c,canPrepay:d,trackingStatus:l,trackingStatusId:u,lastDate:p,mpmPaymentStatus:h,cancelProcessed:y}=i;let m=!1;if(a&&!r.is_canceling&&(m=!0,r.is_canceling=!0),y&&!r.cancel_processed&&(m=!0,r.cancel_processed=!0),n&&r.pay_state!=o.f6.Paid&&(m=!0,r.pay_state=o.f6.Paid),u>0&&r.tracking_id!=u&&(m=!0,r.tracking_id=u,r.tracking=l),h!==r.mpmPaymentStatus&&(m=!0,r.mpmPaymentStatus=h),p>0){const e=Math.floor(p/1e3);e!=r.updated_dt&&(r.updated_dt=e,m=!0)}return m},e.removePosition=function(e,t){var i,s;const r=e.items.findIndex((e=>e.rids.includes(t)));if(r>=0){const o=null===(i=e.rid_states)||void 0===i?void 0:i.findIndex((e=>e.rid==t));o>=0&&e.rid_states.splice(o,1);const a=100*(null===(s=e.items[r])||void 0===s?void 0:s.price)||0;return e.payment.amount=Math.max(0,e.payment.amount-a),e.payment.goods_total=Math.max(0,e.payment.goods_total-a),e.items.splice(r,1),!0}return!1},e}();const n=function(){function e(){this.sale=0}return e.fromOrdo=function(e){var t,i,s;const r=new this;return r.id=e.code1S,r.name=null!==(t=e.name)&&void 0!==t?t:"",r.subjectId=e.subjectId,r.nonRefundable=e.nonRefundable,r.brand=null!==(i=e.brand)&&void 0!==i?i:"",r.price=100*e.price,r.salePrice=100*e.price,r.sellerId=e.sellerId,r.sellerName=e.sellerName,r.paymentSaleAmount=100*e.paymentSaleAmount,r.paymentSaleType=e.paymentSaleType,r.customsFeeAmount=100*(e.customsFeeAmount||0),e.logisticsCost&&(r.logisticsCost=e.logisticsCost),r.option={id:e.characteristicId,color:e.color,name:null!==(s=e.size)&&void 0!==s?s:""},r.quantity=1,r.return_fee=100*e.returnCost,r.rids=[e.rId],e.saleConditions>-1&&(r.sale_conditions=e.saleConditions),r.cacheExpiration=e.cacheExpiration,r.positions=[{rid:e.rId,delivery_type:e.smId,delivery_time:new Date(e.dateTime)/1e3,wh:e.wh}],r},e.fromNnsz=function(e,t){var i,s,r;const o=new this;return o.positions=[e],o.rids=[e.rid],o.id=t.nm_id,o.name=null!==(i=t.name)&&void 0!==i?i:"",o.subjectId=t.subject_id,o.brand=null!==(s=t.brand)&&void 0!==s?s:"",o.dtype=t.dtype,o.price=t.price,o.salePrice=t.total_price,t.logisticsCost&&(o.logisticsCost=t.logistic_cost),o.option={id:t.chrt_id,color:t.color,name:null!==(r=t.size)&&void 0!==r?r:""},o.quantity=1,t.sale_conditions>-1&&(o.sale_conditions=t.sale_conditions),o},e}();const c=function(e){function t({uid:t,orderId:i,position:s,trackerKey:r,source:o,version:a}){var n;return(n=e.call(this)||this).uid=t,i&&(n.orderId=i),n.source=o||s.source,n.timestamp=Math.round(new Date(s.orderDate)/1e3),s.country&&(n.locale=s.country),a&&(s.version=a),n.delivery=Object.assign(n.delivery,{address:s.address,delivery_type:s.smId,delivery_time:new Date(s.dateTime)/1e3,dst_office_id:s.officeId,p_id:s.pid}),5==n.delivery.delivery_type||17==n.delivery.delivery_type?n.delivery.service="wb_courier":n.delivery.delivery_type>0&&(n.delivery.service="wb_pvz"),s.latitude>0&&s.longitude>0&&Object.assign(n.delivery,{latitude:s.latitude,longitude:s.longitude}),s.timeFrom&&s.timeTo&&Object.assign(n.delivery,{time_from:s.timeFrom,time_to:s.timeTo}),s.trackerShardKey&&(n.tracker_shard_key=s.trackerShardKey),n.addOrdoPosition(s),n.user=r,n}var i,s;return s=e,(i=t).prototype=Object.create(s.prototype),i.prototype.constructor=i,r(i,s),t.prototype.addOrdoPosition=function(e){this.payment.amount+=100*e.price,this.payment.delivery_cost=Math.max(100*e.deliveryPrice,this.payment.delivery_cost),this.payment.goods_total=this.payment.amount+this.payment.delivery_cost,this.payment.currency=e.currency,this.payment.type=e.paymentType,this.payment.system=e.paymentSystem,this.items.push(n.fromOrdo(e)),this.rid_states.push(Object.assign({rid:e.rId},t.getItemState(e)))},t.getItemState=function(e){let t=o.f6.Unknown,i=o.Yo.Assembling;return 4096==e.bitStatus?(t=o.f6.PayFail,i=o.Yo.Completed):"CSH"==e.paymentType||e.prepaid?e.hasOwnProperty("isPrepaid")&&(t=e.isPrepaid?o.f6.Paid:o.f6.NotPaid):t=o.f6.PayFail,{pay_state:e.payState||t,state:e.state||i,tracking:e.trackingStatus,tracking_id:e.trackingStatusId,expiration_timestamp:e.expirationTimestamp,updated_dt:Math.floor(e.lastDate/1e3),archive:e.archive,shk_id:e.shkId,version:e.version}},t.singleFromOrdo=function({positions:e,trackerKey:t,source:i,version:s}){return e.map((e=>new this({uid:e.rId,orderId:e.orderId,position:e,trackerKey:t,source:i,version:s})))},t.groupedFromOrdo=function({positions:e,trackerKey:t}){return[...e.reduce(((e,i)=>{var s;let r;const o=null!==(s=i.orderId)&&void 0!==s?s:i.rId;return e.has(o)?(r=e.get(o),r.addOrdoPosition(i)):(r=new this({uid:o,position:i,trackerKey:t,orderId:i.orderId}),e.set(o,r)),e}),new Map).values()]},t}(a);var d=i(19372);Object.freeze({user:"user",orders:"orders",chats:"chats"});const l="/chats/",u=`${l}chat/`,p=(Object.freeze({root:l,chatChat:u,chatList:`${l}list`,chatMaxSeen:`${l}maxSeen`,chat:e=>`${u}${e}`}),"/orders/"),h=Object.freeze({root:p,ordo:`${p}ordo-orders|1`});Object.freeze({info:"/user/info"});let y=function(){function e(){}var t=e.prototype;return t.sync=function(e){if(e){const t=btoa(JSON.stringify({pa:e.purchase,pp:e.purchasePercent,up:e.unpaid}));localStorage.setItem("_user_pa",t)}},t.get=function(){const e=localStorage.getItem("_user_pa");if(e)try{const t=JSON.parse(atob(e));return{purchase:+t.pa||0,purchasePercent:+t.pp||0,unpaid:+t.up||0}}catch(e){return console.error(e),null}return null},t.clear=function(){localStorage.removeItem("_user_pa")},e}(),m=function(){function e(){this._innerStorage=this._getFromCache()}var t=e.prototype;return t.put=function(e){if(e&&0!=e.length){for(const t of e)t.code1S>0&&this._innerStorage.set(t.code1S,{code1S:t.code1S,name:t.name,brand:t.brand,size:t.size,subjectId:t.subjectId,nonRefundable:t.nonRefundable});this._syncToCache()}},t.enrich=function(e){const t=this._innerStorage.get(e.code1S);t&&(e.name||(e.name=t.name),e.brand||(e.brand=t.brand),e.size||(e.size=t.size),e.subjectId||(e.subjectId=t.subjectId))},t._getFromCache=function(){const e=localStorage.getObject("_products_cache"),t=new Map;if(!e||0==e.length)return t;for(const i of e)i.code1S>0&&t.set(i.code1S,i);return t},t._syncToCache=function(){localStorage.putObject("_products_cache",[...this._innerStorage.values()])},e}(),v=function(){function e(){const e=e=>{Object.defineProperty(this,e,{enumerable:!1,configurable:!1,writable:!0,value:"_needRound"!=e&&0})};for(const t of["_totalAmountRub","_purchaseAmountRub","_purchaseAmountCurrency","_needRound","_unpaidAmountRub"])e(t)}var t=e.prototype;return t.addPosition=function(e){if("archive"==e.type){const{years:t,months:i,days:s}=wb.helpers.date.diff(new Date(1e3*e.timestamp));if(t<=2&&0==i&&0==s||i+s>0){const t=this._convertPrice(e.price,e.currency);this._totalAmountRub+=t,32==e.bitStatus&&(this._purchaseAmountRub+=t)}}else if("active"==e.type&&!1===e.isPrepaid){const t=this._convertPrice(e.price,e.currency);this._unpaidAmountRub+=t}},t._convertPrice=function(e,t){const i=$.views.helpers.priceToRub(e,t);return this._needRound=i!=e,i},(0,s.A)(e,[{key:"purchase",get:function(){return isNaN(this._purchaseAmountRub)?0:this._needRound?+this._purchaseAmountRub.toFixed(2):this._purchaseAmountRub}},{key:"purchasePercent",get:function(){return 0==this._totalAmountRub?0:(this._purchaseAmountRub/this._totalAmountRub*100).toFixed(2)}},{key:"unpaid",get:function(){return isNaN(this._unpaidAmountRub)?0:this._needRound?+this._unpaidAmountRub.toFixed(2):this._unpaidAmountRub}}])}(),f=function(){function e(){Object.defineProperty(this,"purchaseInfoCache",{enumerable:!1,configurable:!1,writable:!1,value:new y}),Object.defineProperty(this,"productsCache",{enumerable:!1,configurable:!1,writable:!1,value:new m}),Object.defineProperty(this,"_getItemsTask",{enumerable:!1,configurable:!1,writable:!0})}var t=e.prototype;return t.getItems=async function(e={}){return(null==e?void 0:e.fromCache)&&this._getItemsTask?(window._debug&&console.debug("[ORDERS FILES]:","read from memory","options: ",e),this._getItemsTask.task):(!this._getItemsTask||this._getItemsTask.ts<Date.now()?(this._getItemsTask={task:this._getItems(e).catch((e=>(console.error("[ORDERS FILES]:","get items error",e),wb.spa.logError(e,""),{broken:!0,positions:[],debtPositions:[],archivePositions:[],locations:[],purchaseInfo:{},forTrackers:new Map,positionsMap:new Map}))),ts:Date.now()+1e3},window._debug&&console.debug("[ORDERS FILES]:","read from storage","options:",e)):window._debug&&console.debug("[ORDERS FILES]:","read from memory lock","options:",e),this._getItemsTask.task)},t.resetCache=function(){this._getItemsTask=null,this.purchaseInfoCache.clear()},t.getPurchaseInfo=function(){return this.purchaseInfoCache.get()},t.setMergeOptions=function(e){this._getStorageService().then((()=>{this.$services.storageService.orders.setMergeOptions(e)&&this.resetCache()}))},t.addItem=function(e){e.version=o.DO;const t=c.singleFromOrdo(e);this._getStorageService().then((()=>{this.$services.storageService.orders.saveOrders(t),this.resetCache()}))},t.updateItems=async function(e,t,i){var s;const r=new Set(i?i.keys():e);if(0==r.size)return;await this._getStorageService();const o=await this.$services.storageService.orders.getFiles({localOnly:!0})||[],a=new Set;for(const e of o)for(const o of e.file){for(const n of r)c.trySetPositionProps(o,n,null!==(s=null==i?void 0:i.get(n))&&void 0!==s?s:t)&&(a.add(e),r.delete(n));if(0==r.size)break}a.size>0&&(await this.$services.storageService.orders.syncToServer([...a]),this.resetCache())},t._getItems=async function({notEnrich:e,ordoOnly:t,localOnly:i,uid:s}={}){var r,a,n,l,u,p,y,m,f,g,P,S,b,w,_,I,T,C,k,D,F,R,O;await this._getStorageService();const M=this.$user.getId(),x=M>0?`/orders/${M}|1`:"",A=await this.$services.storageService.orders.getFiles({ordoOnly:t,localOnly:i,excludePaths:x})||(t?[]:null);if(localStorage.setItem("_wbx_orders_t",Date.now()+6e4),null==A)return null;const j={},E=new Map,L=new Map,z=new Map,N=new Map,U=new Set,B=new Set,Y=new Map,V=new Set,K=Date.now();let W,q;const G={};for(const e of A)for(const t of e.file){Y.set(t.uid,e);for(const e of null!==(r=t.items)&&void 0!==r?r:[]){const i=null===(a=e.positions)||void 0===a?void 0:a.toMap((e=>e.rid),(e=>e));for(const s of e.rids){const r=(null===(n=t.rid_states)||void 0===n?void 0:n.find((e=>e.rid==s)))||{state:t.state},a=null!==(l=null==r?void 0:r.state)&&void 0!==l?l:t.state,c=new Date(1e3*t.timestamp),h=new d.A({_debug:t,archive:r.archive,brand:e.brand,characteristicId:null===(u=e.option)||void 0===u?void 0:u.id,code1S:e.id,currency:t.payment.currency,deliveryPrice:((null===(p=t.payment)||void 0===p?void 0:p.delivery_cost)||0)/100,expirationTimestamp:r.expiration_timestamp,country:t.locale,name:e.name,orderDate:c,price:(e.salePrice||e.price)/100,logisticsCost:e.logisticsCost||e.logistic_cost||0,paymentSaleAmount:(e.paymentSaleAmount||0)/100,paymentSaleType:e.paymentSaleType,customsFeeAmount:(e.customsFeeAmount||0)/100,paymentType:null===(y=t.payment)||void 0===y?void 0:y.type,paymentSystem:null===(m=t.payment)||void 0===m?void 0:m.system,prepaidDelivery:0,rId:s,returnCost:(e.return_fee||0)/100,saleConditions:e.sale_conditions||e.saleConditions,size:(null===(f=e.option)||void 0===f?void 0:f.name)||null,color:(null===(g=e.option)||void 0===g?void 0:g.color)||null,sellerId:e.sellerId,sellerName:e.sellerName,source:t.source,status:this._getStatus(r.state),subjectId:e.subjectId,timestamp:t.timestamp,version:r.version,mpmPaymentStatus:r.mpmPaymentStatus,sticker:t.sticker,orderId:t.orderId||t.uid,trackerShardKey:t.tracker_shard_key,cacheExpiration:e.cacheExpiration,smId:null===(P=null==i?void 0:i.get(s))||void 0===P?void 0:P.delivery_type,wh:null===(S=null==i?void 0:i.get(s))||void 0===S?void 0:S.wh,ridState:r,user:t.user},this,G);!h.trackerShardKey&&"nnsz"==h.source&&h.sticker&&(h.trackerShardKey=this.$auth.jwtData.shard_key),E.set(s,h),L.set(s,t),r.state>=0&&(await this.$getService("trackingService"),this._fillPositionState(h,r)),(0<h.cacheExpiration&&h.cacheExpiration<K||h.payState==o.f6.PayFail&&0==(0,o.AM)(c))&&B.add(s),(t.is_finished||99!=a&&!o.dY.includes(a))&&4096!=h.bitStatus&&(h.type="archive"),h.archive&&(h.noTracking=!0),U.add(s),Q.call(this,h);{const r=null!==(I=null!==(w=null===(b=null==i?void 0:i.get(s))||void 0===b?void 0:b.delivery_time)&&void 0!==w?w:null===(_=t.delivery)||void 0===_?void 0:_.delivery_time)&&void 0!==I?I:e.expected_delivery_time;r&&(h.dateTime=new Date(1e3*r),t.delivery.time_from&&t.delivery.time_to&&(h.timeFrom=t.delivery.time_from,h.timeTo=t.delivery.time_to)),t.delivery&&(h.address=t.delivery.address,h.officeId=t.delivery.dst_office_id,h.pid=t.delivery.p_id,h.latitude=t.delivery.latitude,h.longitude=t.delivery.longitude,h.smId||(h.smId=t.delivery.delivery_type),h.pid||6!=(null!==(T=t.delivery.delivery_type)&&void 0!==T?T:null===(C=null==i?void 0:i.get(s))||void 0===C?void 0:C.delivery_type)||(h.pid=t.delivery.dst_office_id),h.smId||("wb_courier"==t.delivery.service?h.smId=5:"wb_pvz"==t.delivery.service&&(h.smId=6)),null===(k=h.setIsOnShelf)||void 0===k||k.call(h),h.setLocation(j))}}}}function H(e){var t,i;let s;const r=null!==(i=null===(t=e.trackerKey)||void 0===t?void 0:t.toString())&&void 0!==i?i:"";z.has(r)?s=z.get(r):(s=[],z.set(r,s)),-1==s.indexOf(e.rId)&&s.push(e.rId)}function J(e){for(const t of[...z.values()]){const i=t.findIndex((t=>t==e.rId));if(i>=0){t.splice(i,1);break}}}function Q(e){function t(e){return!e.brand||!e.name||null==e.size||!e.subjectId}if(t(e)&&(this.productsCache.enrich(e),t(e))){let t;N.has(e.code1S)?t=N.get(e.code1S):(t=[],N.set(e.code1S,t)),t.push(e)}}let X=[];if(s){const[e,t]=await Promise.all([this.$getService("orderService").then((e=>e.getActive({localRids:[...U],uid:s,options:G,ctx:this}))),this.$getService("wbxOrderService").then((e=>e.getActive({options:G,ctx:this})))]);q=e;const{positions:i,archiveRids:r,trackerKey:a,broken:n,notFound:d,canCancel:l,wbxCanCancel:u,verificationLevel:p}=q;X=(null!=t?t:[]).concat(null!=i?i:[]),W=q.codeDeliveryVer,G.verificationLevel=p,G.wbxCanCancel=u;for(const[e,t]of E)!0!==l||t.archive||(t.canCancel=!0),a&&"nnsz"!=t.source&&t.user&&t.user!=a&&B.add(t.rId);if(!n){if((null==r?void 0:r.length)>0)for(const e of r){E.get(e)&&B.add(e)}if((null==d?void 0:d.length)>0)for(const e of d){const t=E.get(e);if(t)if((null===(D=null==t?void 0:t.ridState)||void 0===D?void 0:D.pay_state)==o.f6.PayFail)B.add(e);else if((null==t?void 0:t.timestamp)>0&&"nnsz"!=t.source){const i=new Date(1e3*t.timestamp).addMinutes(30);0==Math.floor(Math.max(0,i-new Date))&&B.add(e)}}}for(const e of B){const t=L.get(e);if(t&&c.removePosition(t,e)){const e=Y.get(t.uid);V.add(e)}E.delete(e)}for(const e of X){e.version=o.DO,e.setLocation(j);const t=E.get(e.rId);if(t){const i=c.getItemState(e);switch(t.canCancel=e.canCancel,t.canCancelDelayed=e.canCancelDelayed,t.country=e.country,t.status=e.status,8==t.status&&210!=t.trackingStatusId&&290!=t.trackingStatusId&&(t.trackingStatusId=210,t.trackingStatus=e.trackingStatus,t.trackingStatusReady=e.trackingStatusReady,t.setIsOnShelf(),t.customTrackerStatus={place_name:e.address,status_id:"210",status_name:e.trackingStatus,date:1e6*new Date(e.lastDate||new Date)}),!0){case i.pay_state!=(null===(F=t.ridState)||void 0===F?void 0:F.pay_state):case e.version!=t.version:case e.officeId!=t.officeId:case e.address&&e.address!=t.address:case e.smId!=t.smId:case(e.paymentSaleAmount||0)!=(t.paymentSaleAmount||0):case e.shadeModel&&!t.shadeModel:case e.archive&&e.trackingStatus!=t.trackingStatus:case e.cacheExpiration&&e.cacheExpiration!=t.cacheExpiration:case e.expirationTimestamp&&e.expirationTimestamp!=t.expirationTimestamp:case!t.currency&&e.currency:case!t.wh&&e.wh:case"ordo"==t.source&&t.isCanceling!=e.isCanceling:case e.timeFrom&&e.timeTo&&e.dateTime.getTime()!==t.dateTime.getTime():case e.deliveryPrice>0&&e.deliveryPrice!=t.deliveryPrice:case e.orderOptionsFlags>0&&e.orderOptionsFlags!=t.orderOptionsFlags:case e.trackerShardKey&&e.trackerShardKey!=t.trackerShardKey:case e.paymentSystem&&e.paymentSystem!=t.paymentSystem:case e.sellerId&&e.sellerId!=t.sellerId:case e.customsFeeAmount&&e.customsFeeAmount!=t.customsFeeAmount:e.dirty=!0,e.address||e.address==t.address||(e.address=t.address);break;default:continue}}Q.call(this,e),E.set(e.rId,e)}}if(!e&&N.size>0)try{const e=await wb.xnm.getXnmProducts([...N.keys()]);N.forEach(((t,i)=>{var s;const r=e[i];if(r)for(const e of t)e.name||(e.name=r.name),e.brand||(e.brand=r.brand),!e.size&&r.sizes&&(e.size=null===(s=r.sizes.find((t=>t.optionId==e.characteristicId)))||void 0===s?void 0:s.name),!e.subjectId&&r.subjectId&&(e.subjectId=r.subjectId),this.productsCache.put([e])}))}catch(e){console.error(e)}{const e=(null==A?void 0:A.find((e=>e.path==h.ordo)))||this.$services.storageService.orders.createOrdoFile();if(0==A.length&&A.push(e),X.length>0){const t=c.singleFromOrdo({trackerKey:(null==q?void 0:q.trackerKey)||this.$user.getId(),positions:X.filter((e=>{const t=L.get(e.rId);if(!t)return!0;if(!t.user)return!0;const i=E.get(e.rId);return i&&!i.archive&&i.trackingStatusId!=e.trackingStatusId&&i.trackingStatusId&&(e.trackingStatusId=i.trackingStatusId,e.trackingStatus=i.trackingStatus),(null==i?void 0:i.dirty)||!1}))});t.length>0&&(e.file=[...e.file.concat(t).reduce(((e,t)=>(e.set(t.uid,t),e)),new Map).values()],V.add(e))}if(V.size>0)try{V.has(e)&&(e.file=e.file.reduce(((e,t)=>{var i;return(null===(i=t.items)||void 0===i?void 0:i.length)>0&&e.push(t),e}),[]).filter((e=>{var t;return(null===(t=e.items)||void 0===t?void 0:t.length)>0}))),this.$services.storageService.orders.syncToServer([...V]),this.resetCache()}catch(e){console.error(e)}}const Z=[],ee=new Map,te=[],ie=new v;await wb.xnm.waitNoReturnSubjectsInitialized();const se=[];for(const e of E.values()){if(e.subjectId>0&&wb.xnm.setNoRefund(e.subjectId)&&$.observable(e,se).setProperty({nonRefundable:!0}),"active"==e.type&&(4096==e.bitStatus?te.push(e):Z.push(e)),"archive"==e.type&&ee.set(e.rId,e),e.archive||4096==e.status?J(e):H(e),e.dateTime){e.receiveDate=e.timeFrom&&e.timeTo?e.getStatusReceiveDate():wb.helpers.date.formatEstimated(e.dateTime);const t=new Date(e.dateTime);t.setDate(e.dateTime.getDate()+2),e.readyToReceiveToday||(e.delayed=t-new Date<0),e.payState==o.f6.PayFail?delete e.trackingStatus:e.noTracking&&!e.trackingStatus&&(e.trackingStatus=e.receiveDate)}o.QQ.has(null===(R=e.paymentType)||void 0===R?void 0:R.toUpperCase())&&(e.supplierPayment=!0),ie.addPosition(e),e.setDeliveryConfirmation(se)}return null===(O=se.trigger)||void 0===O||O.call(se),this.purchaseInfoCache.sync(ie),{broken:!1,codeDeliveryVer:W,positions:Z.filter((e=>!e.cacheExpiration||e.cacheExpiration>=K)).sort(d.A.sortPositions),debtPositions:te,archivePositions:ee,locations:j,purchaseInfo:ie,forTrackers:z,positionsMap:E}},t._fillPositionState=function(e,{state:t,pay_state:i,is_canceling:s,cancel_processed:r,tracking:a,tracking_id:n,shk_id:c,delivery_date:d,updated_dt:l}){99==t&&(t=o.Yo.Processing,i=o.f6.Paid),e.shkId=c,l>0&&(e.lastDate=new Date(1e3*l)),o.bM.includes(t)?(e.type="archive",e.status=this._getStatus(t,i),t==o.Yo.Rejected?e.bitStatus=i==o.f6.Refunded?128:64:i===o.f6.NotPaid||"nnsz"!=e.source&&i===o.f6.PayFail?(e.type="active",(i===o.f6.NotPaid||"nnsz"==e.source&&i==o.f6.PayFail)&&(e.isPrepaid=!1),e.bitStatus=4096,e.canPrepay=!0,e.selectedForPay=!0,e.prepaid=0):e.bitStatus=32):o.dY.includes(t)&&(e.type="active",!e.dateTime&&d>0&&(e.dateTime=new Date(1e3*d)),r&&(e.cancelProcessed=r),s?(e.archive=!0,e.isCanceling=s):(a?(e.trackingStatus=a,e.trackingStatusId=n):e.setCustomTrackingStatus(t),e.readyToReceiveToday=this.$services.trackingService.isStatusReady(n),e.trackingStatusReady=e.readyToReceiveToday&&(5!=e.smId||17!=e.smId||210!=e.trackingStatusId)),e.state=t,e.payState=i,e.payState==o.f6.NotPaid||"nnsz"==e.source&&e.payState==o.f6.PaySent?this._excludePay(e)||"Отмена"==a||e.archive||(e.isPrepaid=!1,e.canPrepay=!0,e.selectedForPay=!0,e.prepaid=0):e.payState==o.f6.PayFail?(e.canPrepay=!0,e.selectedForPay=!0,e.prepaid=0,e.isPrepaid=!1,e.deliveryPrice>0&&"nnsz"==e.source&&e.payFailed&&(e.type="archive")):e.payState==o.f6.Paid?(this._excludePay(e)||(e.isPrepaid=!0),"Отмена"==a||e.archive||(e.prepaid=e.price,e.prepaidDelivery=e.deliveryPrice)):e.payState!=o.f6.Refunded&&t!=o.Yo.Completed||(e.archive=!0,i==o.f6.Refunded&&(e.refunded=!0),e.trackingStatus="Заказ завершен",e.noTracking=!0,delete e.trackingStatusId,delete e.trackingStatusReady))},t._excludePay=function(e){var t;return o.QQ.has(null===(t=e.paymentType)||void 0===t?void 0:t.toUpperCase())||"CRE"==e.paymentType},t._getStatus=function(e){switch(e){case o.Yo.Rejected:return"Rejected";case o.Yo.Completed:return"Purchased"}},t._getStorageService=function(){return this.$moduleLoader.loadServiceAsSingletonAsync("storageService")},(0,s.A)(e,[{key:"isCacheExpired",get:function(){const e=localStorage.getItem("_wbx_orders_t");return!e||e<Date.now()}}])}();window.__spaServiceManager__.register("ordersSyncService",f);const g=f},92901:(e,t,i)=>{i.d(t,{A:()=>o});var s=i(49922);function r(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(0,s.A)(r.key),r)}}function o(e,t,i){return t&&r(e.prototype,t),i&&r(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}},92327:(e,t,i)=>{i.d(t,{A:()=>r});var s=i(82284);function r(e,t){if("object"!=(0,s.A)(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=(0,s.A)(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}},49922:(e,t,i)=>{i.d(t,{A:()=>o});var s=i(82284),r=i(92327);function o(e){var t=(0,r.A)(e,"string");return"symbol"==(0,s.A)(t)?t:t+""}},82284:(e,t,i)=>{function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}i.d(t,{A:()=>s})}},t={};function i(s){var r=t[s];if(void 0!==r)return r.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,i),o.exports}i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const s=function(e){this.totalPrice=e.sum("price"),this.canTotalToPay=this.totalPrice,this.totalToPay=this.totalPrice,this.logisticsCost=e.sum("logisticsCost"),this.products=e,this.currency=e[0].currency,this.source=e[0].source,this.mustPayTheRest=!0};var r=i(13504);const o=function(){function e(e){this.totalPrice=0,this.deliveryPrice=0,this.logisticsCost=0,this.prepaidDelivery=0,this.totalPrepaid=0,this.customsFeeAmount=0,this.canTotalToPay=0,this.totalPaymentFee=0,this.hasIsAdult=!1,this.showPrepaid=!1,this._ctx=e.ctx,e.postPayment&&Object.keys(e.postPayment).length>0?Object.assign(this,e.postPayment):e.options.short?this._createShort(e):(this._create(e),this._setJSView()),this.needsDeliveryConfirmation=this.products.some((e=>e.needsDeliveryConfirmation));const t=this.products.first();this.mpmPaymentStatus=t.mpmPaymentStatus,this.isPdlPostPayment=t.isPdlPostPayment,this.isOnlyProduct=1===this.products.length}var t=e.prototype;return t.loadSeller=function(e,t){$.view(e.target).data.loadSeller()},t.cancelDelivery=function(e,t){"nnsz"==this.source&&this.$moduleLoader.execModule("bottomNotificationPanel","showNotification",[0,"Эта функциональность недоступна","action-notification--error"]),wb.popup.confirm($.localize("Отменить доставку товаров?")).then((e=>{if(!e||this.isCanceling)return;$.observable(this).setProperty({isCanceling:!0});const i=this.products.map((e=>e.rId));this._ctx.$getService("orderService").then((e=>e.cancelByRids(i))).then((e=>{var s;if(null==e?void 0:e.notExists){const e=null!==(s=t.view.ctx.parentView)&&void 0!==s?s:t.view,i=null==e?void 0:e.get("array");i&&i.data&&$.observable(i.data).remove(e.getIndex())}this._ctx.updateItems(i,{isCanceling:!0});const r=[];for(const e of this.products)$.observable(e,r).setProperty({isCanceling:!0});r.trigger()})).catch((e=>{console.log(e),wb.popup.renderModalError("Ошибка при отмене доставки")}))}))},t.rescheduleDelivery=function(){const e=this.products.filter((e=>e.needsDeliveryUpdate));0==e.length&&wb.popup.renderModalError("В доставке нет товаров, которые можно перенести"),this._ctx.$moduleLoader.loadModuleAsync("cargoDeliveryDatePicker").then((t=>{(new t).showDatePickerPopup(e,this.address,"reschedule",!1,(t=>{$.observable(this).setProperty({needsDeliveryConfirmation:!1,needsDeliveryUpdate:!1,needsDeliveryUpdateTimeOut:!1,deliveryDateHasBeenChanged:!0}),e.forEach((e=>{const i=`Ожидается ${t.format("d MMMM")}, 09:00&#8209;23:00`;$.observable(e).setProperty({dateTime:t.toISOString(),receiveDate:i,trackingStatus:i})}))}))}))},t.confirmDelivery=function(){this._ctx.$moduleLoader.loadModuleAsync("cargoDeliveryDatePicker").then((e=>{(new e).confirmCurrentDeliveryDate(this.products.map((e=>e.rId))),$.observable(this).setProperty({needsDeliveryConfirmation:!1,needsDeliveryUpdate:!1,needsDeliveryUpdateTimeOut:!1,deliveryHasBeenConfirmed:!0})}))},t.payTheRest=function(e,t){this._ctx.$moduleLoader.loadModuleAsync("paymentPopup").then((e=>{var i;const s=t.view.ctxPrm("fromBasket"),r=s||t.view.ctxPrm("postPayment")||!(null===(i=this.isMultipleForPay)||void 0===i?void 0:i.call(this)),o=this.products.filter((e=>e.canPrepay&&(e.selectedForPay||r))),a=o[0].iSOCurrency||o[0].currency,n=o.map((e=>e.rId)),c=r?this.canTotalToPay:this.sumSelectedForPay();e.showPayTheRestPopupAsync({totalToPay:c,rids:n,currency:a,positions:o,onSuccess:({resetPaymentSale:e}={})=>{var t;s?$.observable(this).setProperty({paid:!0}):this._refreshPayedPositions(o,e),null===(t=this.closePopup)||void 0===t||t.call(this),this._ctx.$user.resetBalance(),wb.popup.renderModalError("Оплата прошла успешно")}}),this.paymentTimer>0&&this._ctx.$getService("groupedDeliveriesService").then((e=>e.updateItems(null,null,this.products.toMap((e=>e.rId),(e=>(e.mpmPaymentStatus=0,e))))))}))},t.showPopupChangePickUp=async function(){const e=this.products.filter((e=>e.canChangeOffice));e.length&&this._ctx.$moduleLoader.loadModuleAsync("changePickUpPopup").then((t=>{this._changePickUpPopup=new t({products:e,office:this.location,onSuccess:wb.spa.refresh}),this._changePickUpPopup.showPopup()}))},t.showPopupCourierPay=function(){this.location||wb.popup.renderModalError("Ошибка при получении данных, попробуйте обновить страницу");let e=this.products.filter((e=>e.isOnShelf));if(this.location.coordinates instanceof Array)this.location.latitude=this.location.coordinates[0],this.location.longitude=this.location.coordinates[1];else{const e=this.location.coordinates.split(",").map((e=>parseFloat(e)));this.location.latitude=e[0],this.location.longitude=e[1]}this._courierPopup?this._courierPopup.showSwitchToCourierPopup(e,this.location):this._ctx.$moduleLoader.loadModuleAsync("courierDeliveryOptionPopup").then((async t=>{this._courierPopup=new t({onPayCallback:(t,i)=>{t.success&&(this._refreshPayedPositions(e,i),this._ctx.$user.resetBalance())},onCourier:t=>{this._refreshMovedPositions(e,t),this._ctx.$user.resetBalance()}}),await this._courierPopup.showSwitchToCourierPopup(e,this.location)}))},t.calcPaymentTime=function(){var e;return 0==(null===(e=this.products)||void 0===e?void 0:e.length)?0:(0,r.AM)(this.products[0].orderDate)},t.showMap=function(e){const t=this[e];if(!t)return!1;this._ctx.$moduleLoader.loadModuleAsync("pooMapModule").then((e=>wb.popup.showCustomPopup({useHtml:!0,popupClassesList:["popup-map","shown","j-active-address-map"],showCross:!1,showCloseBtn:!0,closeClass:["popup__close-btn","j-close"],contentClasses:["popup__content"],useCenteredFunction:!0,onShow:i=>{const s=new e({form:".j-active-address-map",pooList:[Object.assign({id:t.id,_filled:!0,dtype:t.smId,createBalloon:void 0===t.hasBalloon,showSelectBtn:!1},t)],mapId:"addressMap",isShowMode:!0});6!=t.smId&&86!=t.smId||(s.pooBalloon=t,s.pooBalloon.comments||(s.pooBalloon.comments=[])),$.templates.singlePooMapTmpl.link(i.contentEl,s);const r=s.showPoo();s.pooBalloon&&r.then((e=>e.onPooMoreClick(t,{needExtInfo:!0})))}})))},t.showPopupCourierRoute=async function(e,t){this._ctx.$moduleLoader.loadModuleAsync("courierRoutePopup").then((e=>new e({privateCode:t.view.ctxPrm("privateCode"),products:t.view.ctxPrm("foundItems"),location:this.location}).show()))},t.paySelectStart=function(e){if("m"==wb.settings.displayMode){const t=wb.popup.showCustomPopup({useHtml:!0,popupClassesList:["popup-unpaid-product","shown"],contentClasses:["popup__content"],useCenteredFunction:!0,onShow:i=>{$.templates.unpaidProductPopupTmpl.link(i.querySelector(".popup__content"),{walletLimit:e,delivery:this,products:this.products.filter((e=>e.canPrepay)),sumSelectedForPay:this.sumSelectedForPay,walletSelectedTotal:this.walletSelectedTotal,totalPaymentFeeSelected:this.totalPaymentFeeSelected,isMultipleForPay:this.isMultipleForPay,currency:this.currency,canTotalToPay:this.canTotalToPay,totalPrice:this.totalPrice,deliveryPrice:this.deliveryPrice,prepaidDelivery:this.prepaidDelivery,payTheRest:this.payTheRest,source:this.source,closePopup:()=>t.close(),_calculatePayment:this._calculatePayment,_refreshPayedPositions:this._refreshPayedPositions,_ctx:this._ctx})}})}else $.observable(this).setProperty({paySelectMode:!0})},t.paySelectCancel=function(){$.observable(this).setProperty({paySelectMode:!1})},t.showWalletLimitPopup=function(){this._ctx.$moduleLoader.loadModuleAsync("walletLimitPopup").then((e=>{this.walletLimitPopup=new e(e.template,!0),this.walletLimitPopup.showWalletLimitPopup()}))},t.showInfoWbPayPopup=async function(e){var t;const i=this.walletTotalToPay-e,s=`Пополните на ${$.views.converters.priceWithCurrencyV2(i,!1,"₽")} для&nbsp;оплаты со&nbsp;скидкой`,[r,o]=await Promise.all([this._ctx.$services.userData.getUserDataAsync(),this._ctx.$moduleLoader.loadModuleAsync("infoWbPayPopup")]);this.infoWbPayPopup=new o({template:o.template,phone:null===(t=null==r?void 0:r.userInfo)||void 0===t?void 0:t.formattedPhoneMobile,title:s,totalPrice:i,balance:e,howTopUp:!0}),this.infoWbPayPopup.show()},t._refreshPayedPositions=function(e=[],t){var i,s;const r=[],o={isPrepaid:!0,selectedForPay:!1,canPrepay:!1};if(t){let t=0;e.forEach((e=>{t+=e.paymentSaleAmount,$.observable(e,r).setProperty({price:e.price+e.paymentSaleAmount,paymentSaleAmount:0})})),$.observable(null!==(i=this.delivery)&&void 0!==i?i:this,r).setProperty({totalPrice:this.totalPrice+t})}for(const t of e)$.observable(t,r).setProperty(o),$.observable(t,r).setProperty({prepaid:t.price});this._ctx.updateItems(e.map((e=>e.rId)),o);const{totalPaymentFee:a,canTotalToPay:n,totalPrepaid:c,totalToPay:d,walletTotalToPay:l,customsFeeAmount:u}=this._calculatePayment();$.observable(null!==(s=this.delivery)&&void 0!==s?s:this,r).setProperty({totalPaymentFee:a,canTotalToPay:n,totalPrepaid:c,totalToPay:d,walletTotalToPay:l,customsFeeAmount:u}),r.trigger()},t._refreshMovedPositions=function(e,t){var i;const s=[],r={place_name:t,status_id:"265",status_name:"Оформлена доставка курьером",date:1e6*Date.now()},o={smId:5,address:r.place_name,trackingStatusId:r.status_id,trackingStatus:r.status_name,trackingStatusReady:!1};for(const t of e)t.customTrackerStatus=r,$.observable(t,s).setProperty(o),$.observable(t,s).setProperty({isOnShelf:!1});null===(i=s.trigger)||void 0===i||i.call(s)},t._calculatePayment=function(){let e=0,t=0,i=0,s=0,r=0,o=0;for(const a of this.products.filter((e=>!e.archive)))a.supplierPayment?e+=a.prepaid:(t+=a.prepaid||0,o+=a.customsFeeAmount||0,a.prepaid&&(t+=o),a.canPrepay&&0==a.prepaid&&!a.isPdlPostPayment&&(i+=a.price+(a.customsFeeAmount||0),r+=a.paymentSaleAmount||0)),a.prepaid||1!==a.paymentSaleType||(s+=a.price);i&&(i+=(this.deliveryPrice||0)-(this.prepaidDelivery||0));const a=this.totalPrice-t-e+(this.deliveryPrice||0)-(this.prepaidDelivery||0)+o;return{totalPaymentFee:r,customsFeeAmount:+o.toFixed(2),canTotalToPay:+i.toFixed(2),totalPrepaid:+t.toFixed(2),totalToPay:+a.toFixed(2),walletTotalToPay:+s.toFixed(2)}},t._createShort=function({data:e,positions:t,locations:i}){var s;const r=i[e.locationId];if(r){if(this.deliveryType=r.deliveryType,r.address){const e=r.address.split(", телефон ");this.address=e[0],this.recipientPhone=e.length>1?e[1]:null}this.workTime=r.workTime}this.officeId=null===(s=t.find((e=>e.officeId>0)))||void 0===s?void 0:s.officeId,this.products=[],this.currency=e.currency,this.smId=e.smId,this.intervals=null==e?void 0:e.intervals,this.address=this.address||(null==e?void 0:e.address);let o=t[0].dateTime,a=t[0].dateTime;this.isCanceling=!0;for(const e of t)this.products.push({code1S:e.code1S}),e.dateTime&&(e.dateTime<o&&(o=e.dateTime),e.dateTime>a&&(a=e.dateTime)),e.isCanceling||(this.isCanceling=!1),!this.officeId&&e.officeId>0&&(this.officeId=e.officeId),!this.pid&&e.pid>0&&(this.pid=e.pid);this.totalToPay=0,this.source=e.source,this.readyToReceiveToday=e.readyToReceiveToday,this.readyToReceiveToday?this.courier=!(5!=e.smId&&17!=e.smId&&86!=e.smId||260!=t[0].trackingStatusId&&555!=t[0].trackingStatusId):!e.delayed&&o?this.receiveDate=wb.helpers.date.formatEstimated(o,null,this.intervals):this.receiveDate=t[0].receiveDate,e.archive&&(this.archive=e.archive)},t._create=function({data:e,positions:t,locations:i,options:s}){var r,o,a,n;this.products=t,e.payFailed&&(this.orderId=e.orderId,this.payFailed=!0,this.partialPayment=e.partialPayment,this.paymentTimer=this.calcPaymentTime()),this.smId=e.smId,this.verificationRequired=e.verificationRequired,this.officeId=null===(r=t.find((e=>e.officeId>0)))||void 0===r?void 0:r.officeId,this.pid=null===(o=t.find((e=>e.pid>0)))||void 0===o?void 0:o.pid,e.source&&(this.source=e.source),this.pid>0&&86==e.smId&&(this.pid+=1e7),this.currency=e.currency,this.returnCost=e.returnCost;const c=i[e.locationId];c&&(this.deliveryType=c.deliveryType,c.address&&([this.address,this.recipientPhone]=c.address.split(", телефон ")),this.workTime=c.workTime,this.location=c.mapLocation),this.canCancel="ordo"==this.source,this.isCanceling=!0,this.archive=!0;for(const t of this.products)e.payFailed&&0==this.paymentTimer&&(t.canCancel=!1),this.canCancel=this.canCancel&&t.canCancel&&!t.isCanceling,t.isCanceling||(this.isCanceling=!1),t.archive||(this.archive=!1);this.paymentType=this.products[0].paymentType,this.paymentSaleType=this.products[0].paymentSaleType,this.isHumanitarianAid=this.products[0].isHumanitarianAid,this.allSupplierReturn=!0;for(const e of this.products.filter((e=>!e.archive))){const t=e.supplierPayment;if(this.allSupplierReturn&=t,this.hasIsAdult=this.hasIsAdult||e.isAdult,t||(this.totalPrice+=e.price),this.deliveryPrice+=e.deliveryPrice||0,this.prepaidDelivery+=e.prepaidDelivery||0,this.logisticsCost+=e.logisticsCost||0,this.showPrepaid=this.showPrepaid||!t,!this.courierOfficeAddress){const t=i[e.officeLocationId];t&&(this.courierOfficeAddress=t.address,this.courierOfficeLocation=t.mapLocation)}!this.unclaimedCost&&e.unclaimedCost>0&&(this.unclaimedCost=e.returnCost?0:e.unclaimedCost||0)}this.totalPrice=+this.totalPrice.toFixed(2),this.logisticsCost=+this.logisticsCost.toFixed(2);const{totalPaymentFee:d,canTotalToPay:l,totalPrepaid:u,totalToPay:p,walletTotalToPay:h,customsFeeAmount:y}=this._calculatePayment();this.totalPaymentFee=d,this.totalToPay=p,this.canTotalToPay=l,this.totalPrepaid=u,this.walletTotalToPay=h,this.customsFeeAmount=y,this.mustPayTheRest=!1!==(null===(n=null===(a=wb.global.settings)||void 0===a?void 0:a.switches)||void 0===n?void 0:n.enablePayTheRestInDeliveries),this.source=e.source},t.setBankCards=function(e){var t;if(!this.paymentSaleType||this.paymentSaleType<256||this.paymentSaleType>16776960)return;const i=(null==e?void 0:e.filter((e=>{var t;return null===(t=e.allModifiers)||void 0===t?void 0:t.includes(this.paymentSaleType)})))||[];$.observable(this).setProperty({cardsType:(null===(t=i[0])||void 0===t?void 0:t.isSbp)?"sbp":"card"});const s=i.map((e=>e.name));this.cardNames?$.observable(this.cardNames).refresh(s):$.observable(this).setProperty({cardNames:s})},t.courierPhone=function(){var e;return null===(e=this.products.find((e=>260==e.trackingStatusId||555==e.trackingStatusId)))||void 0===e?void 0:e.courierPhone},t.canMoveToCourier=function(){var e;return(null===(e=this.location)||void 0===e?void 0:e.courier)&&"RUB"===this.currency&&this.products.some((e=>e.isOnShelf))},t.canChangeOffice=function(){var e;if(!this.isPremium){const t=this._ctx.$user.getUserGradeFromCache();if(!t)return!1;if(!(null===(e=t.subscription_features)||void 0===e?void 0:e.includes("change_pvz")))return!1;this.isPremium=!0}return this.products.some((e=>e.canChangeOffice))},t.needsDeliveryUpdate=function(){return 17==this.smId&&this.products.some((e=>e.needsDeliveryUpdate))},t.getByTracking=function(e){return this.products.filter((t=>t.trackingStatusId==e))},t._setJSView=function(){function e(){return this.products.some((e=>e.selectedForPay))}function t(){const e=this.products.filter((e=>e.selectedForPay)).reduce(((e,t)=>e+(t.canPrepay?t.price:0)),0);return e?e+(this.deliveryPrice||0)-(this.prepaidDelivery||0):0}function i(){return this.products.filter((e=>e.selectedForPay&&!e.prepaid&&1===e.paymentSaleType)).reduce(((e,t)=>e+t.price),0)}function s(){return this.products.filter((e=>e.selectedForPay)).reduce(((e,t)=>e+(t.canPrepay&&0===t.prepaid?t.paymentSaleAmount:0)),0)}function r(){return 86==this.smId&&this.products.find((e=>Number(260==e.trackingStatusId)||Number(210==e.trackingStatusId)))}this.canMoveToCourier.depends=["location^courier","products.[]^isOnShelf"],this.needsDeliveryUpdate.depends=["location^courier","products.[]^needsDeliveryUpdate"],e.depends="products.[]^selectedForPay",t.depends="products.[]^selectedForPay",i.depends="products.[]^selectedForPay",s.depends="products.[]^selectedForPay",r.depends="products.[]^trackingStatusId",this.courierPhone.depends="products.[]^courierPhone",this.canChangeOffice.depends="products.[]^canChangeOffice",this.anySelectedForPay=e,this.sumSelectedForPay=t,this.totalPaymentFeeSelected=s,this.walletSelectedTotal=i,this.showPostamatBlock=r,this.isMultipleForPay=function(){if(this.payFailed)return!1;let e=0;for(const t of this.products)if(t.canPrepay&&e++,e>1)return!0;return!1}},e}();var a=i(19372);const n=function(){function e(e){this.cnt=0,this.isCacheEmpty=e.isCacheEmpty,e.active.length>0&&this._initialize(e.active)}return e.prototype._initialize=function(e){const t=e[0].products[0];this.cnt=e.length,this.deliveryDate=t.readyToReceiveToday?new Date:new Date(t.dateTime),this.deliveryAmount=e[0].totalPrice+e[0].deliveryPrice,this.receiveDateFormatted=t.receiveDate},e}(),c="_private_code",d="_private_code_v2";const l=function(){function e(){}var t=e.prototype;return t.sync=function(e,t){if(t){const i=t.expireM||60,s=(new Date).addMinutes(i).getTime(),r=btoa(JSON.stringify({privateCode:t.privateCode,qrStr:t.qrStr,ver:t.ver,expire:s}));localStorage.clearStartsWith(c),localStorage.clearStartsWith(d),localStorage.setItem(`${d}_${e}`,r)}},t.get=function(e,t){const i=localStorage.getItem(`${d}_${e}`);if(i)try{const e=JSON.parse(atob(i));return t!=e.ver||(e.expire||0)<(new Date).getTime()?(this.clear(),null):e}catch(e){return console.error(e),null}return null},t.clear=function(){localStorage.clearStartsWith(c),localStorage.clearStartsWith(d)},e}();var u=i(22292);let p=function(){function e(){Object.defineProperty(this,"privateCodeCache",{enumerable:!1,configurable:!1,writable:!1,value:new l}),Object.setPrototypeOf(u.A.prototype,WbSpaModel.prototype),this.ordersSyncService=new u.A,this.updateTrackers=WbSpaModel.prototype.$helper.lockPromise(this.updateTrackers)}var t=e.prototype;return t.init=function(){const e=()=>{this.ordersSyncService.setMergeOptions({syncDisabled:!this.ordersSyncSupported(),ordoOnly:!0})};e(),this._subscribed||(this._subscribed=!0,wb.global.subscribe((()=>e()))),this.get({readyToReceive:"d"==wb.settings.displayMode,short:!0,fromCache:!0,caller:"GroupedDeliveriesService.init",useTracker:!0}).then((e=>{var t,i;let s=null!==(t=e.active)&&void 0!==t?t:[];e.postPayments&&(s=[...e.postPayments,...e.active]);const r=wb.spa.getMainLayout().$userEnv;s&&$.observable(r).setProperty({deliveries:s,readyCount:e.totalReady,debtsCount:e.debtsCount,activePositions:e.positions}),r.activePositionsTask.resolve(null!==(i=e.positions)&&void 0!==i?i:[])})).catch((e=>console.log(e))),this._confirmCargoDeliveryIfRequired()},t.ordersSyncSupported=function(){var e,t,i;return this.$isRangeEnabledFor(null===(i=null===(t=null===(e=wb.global)||void 0===e?void 0:e.settings)||void 0===t?void 0:t.variables)||void 0===i?void 0:i.wbxOrdersSyncRange)},t.getStorageModel=async function({fromCache:e,caller:t}={}){const i=this.$user.getUserInfo();return i.isAuth?this.ordersSyncService.getItems({uid:i.uid,fromCache:e&&!this.ordersSyncService.isCacheExpired,ordoOnly:!0,localOnly:!this.ordersSyncSupported(),caller:[...t?[].concat(t):[],"groupedDeliveriesService.getStorageModel"]}):{}},t.get=async function(e={}){var t;const i=await this.getStorageModel(Object.assign({caller:[...e.caller?[].concat(e.caller):[],"groupedDeliveriesService.get"]},e)),s=i.debtPositions;s.length&&(i.postPayment={totalPrice:s.sum("price"),canTotalToPay:s.sum("price"),totalToPay:s.sum("price"),products:s,currency:s[0].currency,mustPayTheRest:!0});const r=await this.$getService("orderService").then((e=>e.getOrders())),o=await this.$getService("wbxOrderService").then((e=>e.getOrders())),n=[...r.values()].concat([...o.values()]);if((null==n?void 0:n.length)>0){const t=n.filter((e=>{var t;return null===(t=e.state)||void 0===t?void 0:t.startsWith("need_")}));t.length>0&&(e.additionalPositions=[],e.additionalLocations={},n.forEach((t=>{const{positions:i,locations:s}=t.toPositionsModel({ctx:this,processing:!0,options:e,withLogistic:t.with_logistic});e.additionalPositions=[...e.additionalPositions,...i],e.additionalLocations=Object.assign(e.additionalLocations,s)})))}e.useTracker&&(null===(t=i.forTrackers)||void 0===t?void 0:t.size)>0&&(e.short?await this.updateTrackers(i).then((()=>i.positions.sort(a.A.sortPositions))):this.updateTrackers(i));const{groupedDeliveries:c,failedPayments:d,totalReady:l}=this._getGrouped(i,e);let u;return e.useTracker&&this._enrichOfficesAsync(c.concat(d)),c.length>0&&(u=await this.getCode(i.codeDeliveryVer)),{active:c,positions:i.positions,totalReady:l,debtsCount:i.debtPositions.length,isAllPostamat:c.every((e=>86===e.smId)),failedPayments:d,postPayments:this._getGroupedPostPayment(i,e),privateCode:null==u?void 0:u.privateCode,qrCode:null==u?void 0:u.qrCode,purchaseInfo:i.purchaseInfo,forTrackers:i.forTrackers,positionsMap:i.positionsMap,activePositions:i.positions}},t.getCode=async function(e){e||(e="v2");const t=this.$user.getUserInfo(),[i,s]=await Promise.all([this.getPrivateCode(t.uid,e),this.$moduleLoader.loadModuleAsync("qrGenerator")]);return i.qrStr&&(i.qrCode=(new s).generatePng(i.qrStr,{ecclevel:"Q",modulesize:20})),i},t.getLocalCount=async function({caller:e,useTracker:t}={}){var i,s;const r=await this.getStorageModel({fromCache:!0,caller:[...e?[].concat(e):[],"groupedDeliveriesService.getLocalCount"]});if(null==r)return{};const o={total:r.debtPositions.length,unpaid:r.debtPositions.length,ready:0};"SpaActiveOrdersEntrypoint"!=(null===(i=this.$router.currentRoute)||void 0===i?void 0:i.name)&&t&&(null===(s=r.forTrackers)||void 0===s?void 0:s.size)>0&&await this.updateTrackers(r);const a=await this.$getService("trackingService");for(const e of r.positions)o.total++,o.ready+=a.isStatusReady(e.trackingStatusId);return o},t.updateTrackers=async function(e,{timeout:t=1e3}={}){const i=[],s=[],o=new AbortController;setTimeout((()=>o.abort()),t||1e3);const a=new Map,n=await this.$getService("trackingService");return e.forTrackers.forEach(((t,c)=>{i.push(n.getLastStatuses(c,t,o.signal).then((({found:t,notFound:i})=>{t.forEach(((t,i)=>{const r=e.positionsMap.get(i);!r||8==r.status&&210!=t.statusId&&290!=t.statusId||(r.trackingStatusId==t.statusId&&Math.floor(r.lastDate/1e3)==t.unixSeconds||a.set(r.rId,r),r.trackingStatusId=t.statusId,r.readyToReceiveToday=t.ready,r.readyToReceiveToday&&(r.delayed=!1),$.observable(r,s).setProperty({noTracking:!1,trackingStatus:t.status,trackingStatusReady:t.isComplete(r.smId)}),r.setCancel(s),r.setChangeOffice(s),t.phone&&$.observable(r,s).setProperty({courierPhone:t.phone}),r.lastDate=new Date(t.dateTime),r.setIsOnShelf(s))}));for(const t of i){const i=e.positionsMap.get(t);$.observable(i,s).setProperty({noTracking:!0}),null==i||i.setCustomTrackingStatus(i.state),"nnsz"!=i.source||i.state!==r.Yo.Accepted&&i.state!=r.Yo.Validated||(i.trackingStatusId=300),i.setCancel(s)}})).catch((e=>{console.error(e)})))})),Promise.all(i).then((()=>{var e;null===(e=s.trigger)||void 0===e||e.call(s),this.updateItems(null,null,a)}))},t._enrichOfficesAsync=async function(e){var t;const i=new Map,s=new Map;for(const r of e){if(r.officeId>0&&(5==r.smId||86==r.smId)&&r.products.find((e=>e.readyToReceiveToday))){let o=i.get(r.officeId);o||(o=[],i.set(r.officeId,o)),o.push(r)}if(r.pid>0){let a=s.get(r.pid);a||(a=[],s.set(r.pid,a)),a.push(r)}}if(i.size>0||s.size>0){const n=[],c=[...i.keys(),...s.keys()].map((e=>this.$services.userAddressService.getPickupAsync(e).then((e=>{e&&(e.dtype?e.smId=e.dtype:e.smId=6,d(e))}))));if(await Promise.all(c),i.size>0||s.size>0){const l=await this.$httpClient.fetchJSON("/webapi/lk/myorders/delivery/offices",{method:"POST",body:new URLSearchParams([...i.keys(),...s.keys()].map((e=>["ids",e])))});for(const u of Object.keys(l)){const p=l[u];p&&(p.dtype?p.smId=p.dtype:p.smId=6,p.extended=!0,d(l[u]))}}function d(e){if(e){for(const t of i.get(+e.id)||[])5!=t.smId&&86!=t.smId||!t.products.find((e=>e.readyToReceiveToday))||$.observable(t,n).setProperty({courierOfficeAddress:e.address,courierOfficeLocation:e}),i.delete(e.id);for(const t of s.get(+e.id)||[])17!=t.smId&&($.observable(t,n).setProperty({workTime:e.workTime,location:e}),"Доставка"==t.address&&$.observable(t,n).setProperty({address:e.address})),s.delete(e.id)}}null===(t=n.trigger)||void 0===t||t.call(n)}},t.getPrivateCode=async function(e,t){const i=this.privateCodeCache.get(e,t);return i||this.$httpClient.fetchJSON("/webapi/lk/myorders/delivery/code2",{method:"POST"},{includeResponse:!0}).then((t=>(this.privateCodeCache.sync(e,t.responseData),t.responseData))).catch((()=>({})))},t.getPurchaseInfo=async function(){return this.ordersSyncService.getPurchaseInfo()||await this.get({fromCache:!0,caller:"getPurchaseInfo"}).then((e=>e.purchaseInfo))},t.getOverview=async function(){const e=await this.get({fromCache:!0,caller:"getOverview"});return new n(e)},t._confirmCargoDeliveryIfRequired=function(){var e,t,i,s,r;((null===(t=null===(e=wb.global.settings)||void 0===e?void 0:e.switches)||void 0===t?void 0:t.enableCargoDeliveryUpdate)||(null===(s=null===(i=wb.global.settings)||void 0===i?void 0:i.switches)||void 0===s?void 0:s.enableCargoDeliveryUpdateV2))&&"SpaActiveOrdersEntrypoint"!==(null===(r=this.$router.currentRoute)||void 0===r?void 0:r.name)&&wb.spa.getMainLayout().oferta.promise().then((()=>{this.$helper.sleep(300).then((()=>this.getCargoDeliveriesForConfirmation().then((e=>{var t;return(null===(t=null==e?void 0:e.cargoPositions)||void 0===t?void 0:t.length)&&this.$moduleLoader.loadModuleAsync("cargoDeliveryDatePicker").then((t=>{(new t).showDatePickerPopup(e.cargoPositions,e.address,e.multipleDeliveries?"confirm_multiple":"confirm")}))}))))})).catch((()=>null))},t.getCargoDeliveriesForConfirmation=async function(){const e=await this.get({fromCache:!0,caller:"getCargoDeliveriesForConfirmation"});let t=null,i=0;const s=e.active.reduce(((e,s)=>{if(17===s.smId){let r=wb.global.settings.switches.enableCargoDeliveryUpdateV2?s.products.filter((e=>e.needsDeliveryUpdateTimeOut)):s.products.filter((e=>e.needsDeliveryConfirmation));e.push(...r),r.length>0&&(t=s.address,i++)}return e}),[]);return s.length>0&&wb.global.userSettings.closed.indexOf(s.map((e=>e.rId)).join(","))>-1?{address:t,cargoPositions:[]}:{address:t,cargoPositions:s,multipleDeliveries:i>1}},t.resetCache=function(){this.ordersSyncService.resetCache(),this.privateCodeCache.clear()},t.merge=function(e){this.ordersSyncService.addItem(e)},t.updateItems=function(e,t,i){this.ordersSyncService.updateItems(e,t,i)},t.groupDebt=function(e){return this._getGroupedPostPayment(e)},t._getGrouped=function(e,t){var i,s;const r=new Map,a=null!==(i=t.additionalPositions)&&void 0!==i?i:[],n=null!==(s=t.additionalLocations)&&void 0!==s?s:[],c=new Set,d=new Set;let l=0;e.positions.concat(a).reduce(((e,t)=>(c.has(t.rId)||(c.add(t.rId),e.push(t)),e)),[]).filter((e=>{const i=e.trackingStatusId>0?e.trackingStatusReady||5==e.smId&&(210==e.trackingStatusId||e.timeFrom&&e.timeTo):e.readyToReceiveToday;return i&&l++,!t.readyToReceive||i})).forEach((e=>{const i=this._groupBy(e,t),s=JSON.stringify(i);let o;e.payFailed&&e.orderId&&d.add(e.orderId),r.has(s)?o=r.get(s):(o={data:i,positions:[]},r.set(s,o)),o.positions.push(e)}));const u=[],p=[];return r.forEach((({data:i,positions:s})=>{const r=i.payFailed?p:u;i.payFailed&&i.orderId&&d.has(i.orderId)&&(i.partialPayment=!0),r.push(new o({data:i,positions:s,locations:Object.assign({},n,e.locations),postamatOrderInfos:e.postamatOrderInfos,options:t,ctx:this}))})),u.sort(((e,t)=>86!=e.smId&&86!=t.smId?0:86==e.smId?1:-1)),p.sort(((e,t)=>(t.paymentTimer||0)-(e.paymentTimer||0))),{groupedDeliveries:u,failedPayments:p,totalReady:l}},t._getGroupedPostPayment=function(e){var t,i;if(0==(null!==(i=null===(t=e.debtPositions)||void 0===t?void 0:t.length)&&void 0!==i?i:0))return[];const r=new Map;e.debtPositions.forEach((e=>{const t={currency:e.currency,sticker:e.sticker},i=JSON.stringify(t);let s;r.has(i)?s=r.get(i):(s={positions:[]},r.set(i,s)),s.positions.push(e)}));let a=[];return r.forEach((({positions:e})=>{a.push(new o({ctx:this,postPayment:new s(e)}))})),a},t._groupBy=function(e,t){const i={smId:e.smId,locationId:e.locationId,payFailed:e.payFailed,verificationRequired:e.verificationRequired,orderId:e.payFailed?e.orderId:0,pt:e.isPdlPostPayment?1:0};return 5==e.smId&&(i.address=e.address||null),t.short?(i.delayed=e.delayed,i.archive=e.archive,i.readyToReceiveToday=e.trackingStatusId>0?e.trackingStatusReady||5==e.smId&&210==e.trackingStatusId:e.readyToReceiveToday,i.intervals=210!=e.trackingStatusId&&e.timeFrom&&e.timeTo?{timeFrom:e.timeFrom,timeTo:e.timeTo}:null,i.readyToReceiveToday||(i.smId=0,i.locationId="0",i.currency="")):(i.source=e.source,i.paymentSale=e.paymentSaleType>0?e.paymentSaleType:null,i.currency=e.currency),i},e}();window.__spaServiceManager__.register("groupedDeliveriesService",p)})();
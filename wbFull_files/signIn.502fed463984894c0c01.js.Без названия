(()=>{"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(t){var o=function(t,o){if("object"!=e(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var s=n.call(t,o||"default");if("object"!=e(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===o?String:Number)(t)}(t,"string");return"symbol"==e(o)?o:o+""}function o(e,o){for(var n=0;n<o.length;n++){var s=o[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,t(s.key),s)}}const n=[{countryName:"Россия",langCode:"ru",phoneCode:"7",phoneMask:"+0 000 000-00-00"},{countryName:"Армения",langCode:"am",phoneCode:"374",phoneMask:"+000 00 00-00-00"},{countryName:"Беларусь",langCode:"by",phoneCode:"375",phoneMask:"+000 00 000-00-00"},{countryName:"Казахстан",langCode:"kz",phoneCode:"7",r:"^7[6,7].*",phoneMask:"+0 000 000-00-00"},{countryName:"Киргизия",langCode:"kg",phoneCode:"996",phoneMask:"+000 000 00-00-00"},{countryName:"Узбекистан",langCode:"uz",phoneCode:"998",phoneMask:"+000 00 000-00-00"},{countryName:"Китай",langCode:"cn",optionCls:"hide",phoneCode:"86",phoneMask:"+00 000-0000-0000"},{countryName:"Макао и Гонконг",langCode:"cn1",optionCls:"hide",phoneCode:"85",phoneMask:"+00 0-0000-0000"},{countryName:"Тайвань",langCode:"cn2",optionCls:"hide",phoneCode:"886",phoneMask:"+000 000-000-000"},{countryName:"Таджикистан",langCode:"tj",optionCls:"hide",phoneCode:"992",phoneMask:"+000 00 000 0000"},{countryName:"",langCode:"unknown",phoneCode:"",phoneMask:"+00000000000"}];let s=function(){function e(){this._KEY="signin_authv3_dict_phones",window.addEventListener("storage",(e=>{e.key===this._KEY&&this._pull()})),this._pull()}var t=e.prototype;return t._pull=function(){this.dict=sessionStorage.getObject(this._KEY)||{}},t._push=function(){try{sessionStorage.putObject(this._KEY,this.dict)}catch(e){}},t.del=function(e){e&&(delete this.dict[e],this._push())},t.get=function(e){const t=this.dict[e];return t?Date.utcNow()-t._dt>3e5?(this.del(e),null):t:null},t.set=function(e,t){e&&t&&(t._dt=Date.utcNow(),this.dict[e]=t,this._push())},e}(),i=function(){function e(){}return e.isLocalUrl=function(e){return!!e&&("/"===e||!!e.match(/^~?\/[^\/\\]/))},e.getSafeUrl=function(t){if(!t)return null;if(e.isLocalUrl(t))return t;let o;try{o=new URL(t)}catch(e){return null}return e.HostWhiteList.includes(o.host)||window._debug&&"localhost"===o.hostname?t:null},e}();i.HostWhiteList=["www.wildberries.ru","www.wildberries.by","www.wildberries.kz","www.wildberries.kg","www.wildberries.am","www.wildberries.uz","travel.wildberries.ru","travel-stage.wildberries.ru","digital.wildberries.ru","digital.wb.ru","qr.nspk.ru","seller.wildberries.ru","guru.wildberries.ru","guru-stage.wildberries.ru","seller-portal-stage.wildberries.ru","kg.wildberries.ru","uz.wildberries.ru"];let r=function(){function e(e){var t;this.loading=!1,this.prevAuths=e.prevAuths||[],this.settings=e.settings||{},this.messagesHelper={push:{countDown:"Запросить новый код через <span>{0}</span>",message:"Запросить код на телефон"},notify:{countDown:"Запросить новый код через <span>{0}</span>",message:"Запросить код на телефон"},sms:{countDown:"Запросить новый код через <span>{0}</span>",message:"Запросить код повторно"}},this.urlDelPrevAuth="/webapi/security/spa/deleteprevauth",this.urlAfterAuth="/webapi/security/afterauth",this.disableSendCodeBtn.depends=["mobileController^canSendCode","mobileController^completed"],this.preventValidation.depends=["phoneEnteredOnce","maskedInputInFocus","forcedValidation"],this.maskComplete.depends=["phoneMobile"],this.returnUrl=null!==(t=this.$router.queryParams.get("ReturnUrl")||this.$router.queryParams.get("returnUrl"))&&void 0!==t?t:"/lk/basket",-1!==this.returnUrl.indexOf("/security/login")&&(this.returnUrl="/lk/basket"),this.mobileController=null,this.prevAuths.length&&(this.selectedPhone=this.prevAuths[0],this._setFormattedPhone(this.selectedPhone.text)),this.step=this.prevAuths.length?0:1,this.sendBtnMsg=null,this.phoneEnteredOnce=!1,this.maskedInputInFocus=!1,this.cdt="",this.selectPhoneMode=!1,this.onLinkMaskObject=this.onLinkMaskObject.bind(this),this.onCountrySelect=this.onCountrySelect.bind(this),this.onPhoneEnterComplete=this.onPhoneEnterComplete.bind(this),this.onMaskedInputAccept=this.onMaskedInputAccept.bind(this),this.onMaskedInputFocus=this.onMaskedInputFocus.bind(this),this.onMaskedInputBlur=this.onMaskedInputBlur.bind(this),this.onCaptchaInput=this.onCaptchaInput.bind(this),this.checkConfirmCode=this.checkConfirmCode.bind(this),this.onConfirmCodeFocus=this.onConfirmCodeFocus.bind(this),this.closeSelectPhoneModeOnOuterClick=this.closeSelectPhoneModeOnOuterClick.bind(this),this.onKeypressHandler=this.onKeypressHandler.bind(this),this.countriesForDropdown=n.map((e=>({name:`<div class="form-block__option-wrap"><span class="form-block__flag flag-${e.langCode}"></span>${e.countryName} +${e.phoneCode}</div>`,value:e.langCode,phoneCode:e.phoneCode,startsWith:e.phoneCode,optionCls:e.optionCls,_disabled:"unknown"===e.langCode}))),this.tagImaskOpt={mask:n.map((e=>({langCode:e.langCode,mask:e.phoneMask,startsWith:e.r||e.phoneCode,placeholderChar:"0",lazy:"unknown"===e.langCode,country:e.countryName}))).sort(((e,t)=>t.startsWith.length-e.startsWith.length)),dispatch:function(e,t){return t.compiledMasks.find((e=>isNaN(e.startsWith)?t.unmaskedValue.match(e.startsWith):0===t.unmaskedValue.indexOf(e.startsWith)))}},this.confirmCode="",this.selectedCountry=this.countriesForDropdown.find((e=>e.value===(wb.user.getLocale()||wb.settings.currentLocale)))||this.countriesForDropdown[0],this.selectedPhone?(this.fancyPhone=this.selectedPhone.phone.toString(),this.selectedCountry=this.countriesForDropdown.find((e=>this.fancyPhone.startsWith(e.startsWith)))||this.selectedCountry):this.fancyPhone=this.selectedCountry.phoneCode,this.captchaHelper=null,this.dict=new s,this.havePhone=!1,$.observe(this,"selectedPhone",((e,t)=>{var o,n;this._setFormattedPhone(null!==(o=t.value.text)&&void 0!==o?o:""),$.observable(this).setProperty("phoneMobile",(null===(n=t.value.phone)||void 0===n?void 0:n.toString())||this.selectedCountry.phoneCode)})),$.observe(this,"step",((e,t)=>{t.value<2&&this._phoneObserver(this.phoneMobile)})),$.observe(this,"phoneMobile",((e,t)=>{this._phoneObserver(t.value)}))}var t,r,l,a=e.prototype;return a._phoneObserver=function(e){var t,o,n,s;const i=e;null===(t=this.mobileController)||void 0===t||t.reset();const r=this.dict,l=null===(o=r.get(i))||void 0===o?void 0:o.sticker;if($.observable(this).setProperty({havePhone:!!r.get(i)&&l,sendBtnMsg:null}),this.havePhone){const e=r.get(i).ttl-Date.now(),t=null===(n=r.get(i))||void 0===n?void 0:n.cdt,o=null===(s=this.messagesHelper[t])||void 0===s?void 0:s.countDown;$.observable(this.mobileController).setProperty({timeLeft:e>0?e:0,sticker:l,codeL:6}),e>6e5&&$.observable(this.mobileController).setProperty("inputBanned",!0),t&&$.observable(this).setProperty("cdt",t),o&&$.observable(this.mobileController).setProperty("countDownMsg",o)}},a.maskComplete=function(){var e,t;return 1!==this.step||null!==(t=null===(e=this._maskTag)||void 0===e?void 0:e.masked.isComplete)&&void 0!==t&&t},a.disableSendCodeBtn=function(){return!!this.mobileController.completed||(!this.mobileController.canSendCode||(!this.selectedCountry||"unknown"===this.selectedCountry.value))},a.onBeforeRender=async function(){const e=await this.$moduleLoader.loadModuleAsync("spaWbxAuthController");if(this.mobileController=new e({wbCaptchaAuthPrefix:this.settings.wbCaptchaAuthPrefix,requestCodeTimeout:6e4,onSuccess:e=>this._authReload(e,this.returnUrl),onFail:e=>this.onCodeEnterFail(e),getCachedData:e=>this.dict.get(e)}),$.views.settings.advanced({noValidate:!0}),null!=window.wba)try{this.$moduleLoader.loadModuleAsync("signInWbaHelper").then((e=>{this.signInWbaHelper=new e}))}catch(e){console.error(e)}$.observe(this.$router,"activeContainer","showPreview",((e,t)=>{document.body.classList.toggle("bg-gray","SpaSignInEntrypoint"==this.$router.currentRoute.name)})),this.proceedBasedOnQueryParams()},a.closeSelectPhoneModeOnOuterClick=function(e){const t=document.querySelector(".j-b-phone-drop-list"),o=document.querySelector(".j-b-dropdown-prevauth");!t.contains(e.target)&&o.contains(e.target)||$.observable(this).setProperty("selectPhoneMode",!1)},a.onAfterRender=function(){const e=this;this.$moduleLoader.loadModuleAsync("animationHelper").then((t=>{$.observe(this,"selectPhoneMode",(function(o,n){if(n.value&&"m"===wb.settings.displayMode)return;const s=document.querySelector(".j-b-phone-drop-list");s&&t.slideToggle(s,n.value),n.value?document.addEventListener("click",e.closeSelectPhoneModeOnOuterClick):document.removeEventListener("click",e.closeSelectPhoneModeOnOuterClick)}))})),$.observe(this,"selectPhoneMode",(function(t,o){var n;o.value?"m"===wb.settings.displayMode&&(e._prevAuthPhonesPopup=wb.popup.showCustomPopup({showCross:!0,useCenteredFunction:!0,popupClassesList:["popup","popup-auth-phones","shown"],contentClasses:["popup__content"],onShow:t=>{$.templates.prevAuthPhonesPopupTmpl.link(t.querySelector(".popup__content"),e)},onHide:(t,o)=>{e._prevAuthPhonesPopup=null,$.observable(e).setProperty("selectPhoneMode",!1)}})):null===(n=e._prevAuthPhonesPopup)||void 0===n||n.close()})),$.observe(this,"step",(function(t,o){1===o.value&&e.setPhoneInputFocus()})),1===this.step&&e.setPhoneInputFocus(),document.addEventListener("keypress",this.onKeypressHandler)},a.onCountrySelect=function(){1===this.step&&($.observable(this).setProperty({phoneMobile:this.selectedCountry.phoneCode||this.phoneMobile,phoneEnteredOnce:!1,forcedValidation:!1}),this.setPhoneInputFocus())},a.setPhoneInputFocus=function(){setTimeout((()=>{var e,t,o;const n=document.querySelector(".j-b-phonemask-input input");if(n===document.activeElement||!n)return;const s=(null===(t=null===(e=$.view(n).tag.spanDecorate)||void 0===e?void 0:e.fill)||void 0===t?void 0:t.length)||n.value.length;null===(o=n.setSelectionRange)||void 0===o||o.call(n,s,s),n.focus({preventScroll:!0})}),10)},a.onSamePageNavigation=function(){var e;null===(e=this.mobileController)||void 0===e||e.reset(),$.observable(this).setProperty({authType:"basic",step:this.prevAuths.length?0:1,sendBtnMsg:null,phoneEnteredOnce:!1,agreeToReceiveSms:!0,forcedValidation:!1,selectPhoneMode:!1})},a.onBeforeUnrender=function(){var e,t;null===(e=this.mobileController)||void 0===e||e.reset(),null===(t=this.signInCall)||void 0===t||t.dispose(),$.unobserve(this),document.removeEventListener("keypress",this.onKeypressHandler)},a.onKeypressHandler=function(e){"Enter"!==e.key||this.authType||(0===this.step?document.querySelector("#prevAuthBtn").click():1===this.step&&document.querySelector("#requestCode").click())},a.onConfirmCodeFocus=function(e){$.observable(this.signinSberid).setProperty({inputError:!1,errorText:""}),$.observable(this.signinEsia).setProperty({inputError:!1,errorText:""}),$.observable(this.mobileController).setProperty({errorMessage:null,codeHasBeenEnteredOnce:!1})},a.checkConfirmCode=function(e){this.mobileController.checkConfirmCodeV2Debounced?this.mobileController.checkConfirmCodeV2Debounced(this.confirmCode,this.phoneMobile):this.mobileController.checkConfirmCodeDebounced(this.confirmCode)},a.onPhoneEnterComplete=function(e){!this.phoneEnteredOnce&&$.observable(this).setProperty({phoneEnteredOnce:!0}),this._setFormattedPhone(e),$.observable(this).setProperty({forcedValidation:!0})},a.onLinkMaskObject=function(e){this._maskTag=e},a.onMaskedInputAccept=function(e){const t=e.masked.currentMask.langCode;if(e.masked.currentMask.unmaskedValue===e.masked.currentMask.startsWith&&e.masked.currentMask.startsWith===this.selectedCountry.startsWith)return;if(t===this.selectedCountry.value)return;const o=this.countriesForDropdown.find((e=>e.value===t));$.observable(this).setProperty({selectedCountry:o})},a.onMaskedInputFocus=function(){$.observable(this).setProperty({maskedInputInFocus:!0,forcedValidation:!1}),this.signinSberid&&$.observable(this.signinSberid).setProperty({phoneMobileError:""})},a.onMaskedInputBlur=function(){$.observable(this).setProperty("maskedInputInFocus",!1)},a.onCaptchaInput=function(e,t){t.target.value.length==t.target.getAttribute("maxlength")&&this.requestConfirmCode(e,t)},a._setFormattedPhone=function(e){$.observable(this).setProperty({formattedPhone:e})},a.requestConfirmCode=function(e,t){var o,n,s;if(e=null!=e?e:$.view(t.target.form).ctx.tag,$.observable(this).setProperty({forcedValidation:!0}),(!(this.step<2)||e.validate())&&(2!==this.step||!(null===(o=this.mobileController)||void 0===o?void 0:o.showCaptcha)||(null===(s=null===(n=this.mobileController)||void 0===n?void 0:n.captchaHelper)||void 0===s?void 0:s.captchaInput.length)>0)&&!this.disableSendCodeBtn()){if(t.currentTarget.classList.contains("disabled"))return;$.observable(this).setProperty({confirmCode:""}),$.observable(this.mobileController).setProperty({codeHasBeenEnteredOnce:!1}),this._moveToNextStep(t,e)}},a.preventValidation=function(){return(!this.phoneEnteredOnce||this.maskedInputInFocus)&&!this.forcedValidation},a.preventSubmit=function(){return!1},a.goForward=function(){var e;this.prevStep=this.step,$.observable(this).setProperty({confirmCode:"",step:3}),null===(e=document.querySelector(".j-b-charinput"))||void 0===e||e.focus()},a.goBack=function(e){void 0===e&&(e=this.prevStep),$.observable(this).setProperty({step:e,"mobileController.codeHasBeenEnteredOnce":!1}),0!==e||this.selectedPhone.phone||$.observable(this).setProperty({selectedPhone:this.prevAuths[0],"mobileController.errorMessage":""})},a.sberidGoBack=function(e){1==e&&$.observable(this).setProperty({step:e,authType:null})},a.delPrevPhone=function(e,t){e.preventDefault(),e.stopPropagation();const o=this.prevAuths[t.view.index].phone;$.observable(this.prevAuths).remove(t.view.index),this.prevAuths.length?o===this.selectedPhone.phone&&$.observable(this).setProperty("selectedPhone",this.prevAuths[0]):(this.goBack(1),$.observable(this).setProperty("selectPhoneMode",!1)),this.$httpClient.fetchJSON(this.urlDelPrevAuth,{method:"POST",body:new URLSearchParams({prevPhoneAuth:o})})},a.declinePreviousAuth=function(){$.observable(this).setProperty({selectPhoneMode:!1,selectedPhone:{},"mobileController.canSendCode":!1,"mobileController.errorMessage":"",phoneEnteredOnce:!1}),this.goBack(1)},a.changeAuthType=async function(e,t){var o;if("call"===e){const e=await this.$moduleLoader.loadModuleAsync("signinCall");this.signInCall=new e({base:this,requestCall:0===this.step})}if("call"!==e?null===(o=this.signInCall)||void 0===o||o.dispose():this.signInCall.afterRender(t),"esia"===e){const e=await this.$moduleLoader.loadModuleAsync("signinEsia");this.signinEsia=new e(this),this.signinEsia.esiaStartAuth()}if("sberid"===e){const e=await this.$moduleLoader.loadModuleAsync("signinSberid");this.signinSberid=new e(this),this.signinSberid.sberidAuthStart("auth")}"basic"!==e||1!==this.step||this.phoneMobile||this.setPhoneInputFocus()},a.selectPrevPhone=function(e,t){$.observable(this).setProperty("selectedPhone",t.view.data),$.observable(this).setProperty("selectPhoneMode",!1)},a.submitPrevAuth=function(e,t){this.selectedPhone&&(this._setFormattedPhone(this.selectedPhone.text),$.observable(this).setProperty({phoneMobile:this.selectedPhone.phone.toString()}),this.requestConfirmCode(e,t))},a.onCodeEnterFail=function(e){var t,o,n;4!==(null===(t=e.confirmCode)||void 0===t?void 0:t.length)&&6!==(null===(o=e.confirmCode)||void 0===o?void 0:o.length)||null===(n=this.signInWbaHelper)||void 0===n||n.sendEvent(this.signInWbaHelper.constructor.types.authError,e.error)},a._authReload=async function(e,t){var o;return!!e&&($.observable(this).setProperty({loading:!0}),this.dict.del(this.phoneMobile),this.$auth.setToken(e),this.$httpClient.fetchJSON(this.urlAfterAuth,{method:"POST"}),wb.spa.getMainLayout().oferta.confirm(),wb.spa.getMainLayout().updateAfterLogin(),null===(o=this.signInWbaHelper)||void 0===o||o.sendEvent(this.signInWbaHelper.constructor.types.authSuccess),t&&this.$router.moveTo(i.getSafeUrl(t)||"/lk/basket",!0,!1,!0),!0)},a._moveToNextStep=async function(e,t){var o,n,s,i,r,l,a,h,d;try{this.step<2&&(this.prevStep=this.step),e&&(e.currentTarget.disabled=!0),$.observable(this).setProperty({loading:!0});const t=await this.mobileController.requestCodeWithPhone(this.phoneMobile,null===(n=null===(o=this.mobileController)||void 0===o?void 0:o.captchaHelper)||void 0===n?void 0:n.captchaInput,(e=>{var t;$.observable(this.mobileController).setProperty({countDownMsg:null===(t=this.messagesHelper[e])||void 0===t?void 0:t.countDown})}));if($.observable(this).setProperty({loading:!1}),t.isSuccess){const e=t.cdt;$.observable(this).setProperty({cdt:e,sendBtnMsg:null===(s=this.messagesHelper[e])||void 0===s?void 0:s.message,step:3}),this.dict.set(this.phoneMobile,{ttl:Date.now()+this.mobileController.timeLeft,sticker:this.mobileController.sticker,cdt:e}),null===(i=document.querySelector(".j-b-charinput"))||void 0===i||i.focus(),null===(r=this.signInWbaHelper)||void 0===r||r.setLastReceivedCodeType(e),null===(l=this.signInWbaHelper)||void 0===l||l.sendEvent(this.signInWbaHelper.constructor.types.reqestCode)}else t.data.showCaptcha?(2!==this.step&&$.observable(this.mobileController).setProperty("captchaError",""),this.$observable.setProperty({step:2})):(this.mobileController.timeLeft&&this.dict.set(this.phoneMobile,{ttl:Date.now()+this.mobileController.timeLeft}),$.observable(this.mobileController).setProperty("errorMessage",null===(a=t.data)||void 0===a?void 0:a.err),null===(h=this.signInWbaHelper)||void 0===h||h.sendEvent(this.signInWbaHelper.constructor.types.authError,null===(d=t.data)||void 0===d?void 0:d.err))}catch(e){}finally{(null==e?void 0:e.currentTarget)&&(e.currentTarget.disabled=!1)}},a.proceedBasedOnQueryParams=async function(){const e=new URLSearchParams(window.location.search),t=e.get("type"),o=e.get("option1");if("esia"===t){const t=e.get("code"),o=e.get("state");t&&o&&(window.opener.postMessage({name:"esia_auth",payload:{code:t,state:o}}),"esia_auth_popup"===window.name&&window.close())}if("sberid"===o){const t=await this.$moduleLoader.loadModuleAsync("signinSberid");this.signinSberid=new t(this);const o=e.get("code"),n=e.get("state");o&&n&&("m"===wb.settings.displayMode&&"sberid_auth_popup"!==window.name?await this.signinSberid.sberidAuth({code:o,state:n}):(window.opener.postMessage({name:"sberid_auth",payload:{code:o,state:n}}),"sberid_auth_popup"===window.name&&window.close()),window.history.replaceState(null,"",window.location.pathname))}},t=e,(r=[{key:"phoneMobile",get:function(){return this.fancyPhone.replace(/[^0-9]/g,"")},set:function(e){$.observable(this).setProperty({fancyPhone:e})}}])&&o(t.prototype,r),l&&o(t,l),Object.defineProperty(t,"prototype",{writable:!1}),t}();wb.spa.registerViewModel(r)})();
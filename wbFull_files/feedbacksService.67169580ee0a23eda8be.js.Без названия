(()=>{"use strict";const e="https://feedbacks3-api.wb.ru/api/user/feedback/",t={1:"Неправильная подпись запроса",2:"Можно загрузить не более (\\d*) изображений",3:"Поле [\"|'](\\w*)[\"|'] содержит номер телефона(.*)",4:"Поле [\"|'](\\w*)[\"|'] слишком короткое",5:"Превышено максимальное количество символов в поле [\"|'](\\w*)[\"|'], лимит = (\\d*)",6:"Поле [\"|'](\\w*)[\"|'] содержит ссылки(.*)",7:"Поле [\"|'](\\w*)[\"|'] содержит email(.*)",8:"Поле [\"|'](\\w*)[\"|'] не содержит содержательного текста",9:"Поле [\"|'](\\w*)[\"|'] содержит запрещенные слова(.*)",10:"Превышено максимальное количество баблов",11:"Превышено максимальное количество символов в бабле",12:"Загруженный файл не является изображением",13:"Превышен допустимый общий размер фотографии",14:"re-creating a feedback by one user",15:"Загруженный файл не является видео-файлом"};!function(){const e={testOn:!1,img:!0,video:!0,fb:!0};e.testOn||(e.img=!1,e.video=!1,e.fb=!1)}();let r=function(){function r(){}var s=r.prototype;return s.showFeedbacksPopup=async function(e,t,r){Promise.all([this.getPurchasedGoodModel(e.nmId),this.$httpClient.fetchBasicJSON(wb.helpers.url.urlProductStatic(e.nmId)),this.$moduleLoader.loadModuleAsync("feedbacksEditor"),this.$moduleLoader.loadModuleAsync("imageUploader"),this.$services.userData.getUserDataAsync()]).then((([s,o,n,{ImageUploader:i,VideoUploader:a}])=>{var d,c;s||null===(d=t.onError)||void 0===d||d.call(t,err),!s.selectedCod1S&&t.selectedCod1S&&(s.selectedCod1S=t.selectedCod1S),!s.selectedSizeName&&(null===(c=t.selectedSizeName)||void 0===c?void 0:c.value)&&(s.selectedSizeName={value:t.selectedSizeName.value}),t.selectedRating&&(s.selectedRating=t.selectedRating),t.onSubmit&&(s.onSubmit=t.onSubmit);const l={requestInfo:{sellerId:e.sellerId,feedBacksProduct:s.getFeedBacksProduct(s.feedbackGoods,s.selectedCod1S.value,s.selectedSizeName.value)},requestService:this};n.showFeedbacksPopup(e.imtId,e,s,new i(n.imageLoaderSettings,l),new a(n.videoLoaderSettings,l),r,t.onEditorClose,o)})).catch((e=>{var r;null===(r=t.onError)||void 0===r||r.call(t,e)}))},s.complaintComment=function(t,r,s){const o={"Content-Type":"application/json"},n={method:"POST",body:JSON.stringify({requestId:this._getRequestId(),nmId:r,id:t,complaintType:parseInt(s)}),headers:o,credentials:"omit"};return this.$wbxHttpClient.fetch(`${e}complaint/v1`,n,{redirectUnauth:!0,noProcessResponse:!0})},s.complaintAnswer=function(t,r){const s={"Content-Type":"application/json"},o={method:"POST",body:JSON.stringify({requestId:this._getRequestId(),nmId:r,id:t}),headers:s,credentials:"omit"};return this.$wbxHttpClient.fetch(`${e}answer/complaint/v1`,o,{redirectUnauth:!0,noProcessResponse:!0})},s.voteForComment=function(t,r,s){const o={"Content-Type":"application/json"},n={method:"POST",body:JSON.stringify({requestId:this._getRequestId(),nmId:r,id:t,vote:s>0?"plus":"minus"}),headers:o,credentials:"omit"};return this.$wbxHttpClient.fetch(`${e}vote/v1`,n,{redirectUnauth:!0,noProcessResponse:!0})},s.deleteFeedback=async function(t,r){try{const s={"Content-Type":"application/json"},o={method:"POST",body:JSON.stringify({requestId:this._getRequestId(),nmId:r,id:t}),headers:s,credentials:"omit"},n={redirectUnauth:!0,noProcessResponse:!0};return await this.$wbxHttpClient.fetch(`${e}delete/v1`,o,n)}catch(e){wb.popup.renderModalError(e)}},s.saveImages=async function(t,r){const s="Не получилось загрузить, попробуйте ещё раз",o=await this._getPurchaseDetails(t.feedBacksProduct,t.sellerId),n={requestId:this._getRequestId(),purchaseDetails:o,purchaseDetailsSignature:t.feedBacksProduct.reviewSign},i=new FormData;i.append("request",new Blob([JSON.stringify(n)],{type:"application/json"})),t.userPhotos.forEach((e=>{i.append("image",e)}));const a={method:"POST",body:i,credentials:"omit",signal:r},d={keepRespData:!0,redirectUnauth:!0,noProcessResponse:!0,timeout:2e4};try{const t=await this.$httpClient.fetchJSON(`${e}photos/v1`,a,d);return this._validateResult(t,s)}catch(e){return this._getErrorData(e,s)}},s.saveVideo=async function(t,r){const s=await this._getPurchaseDetails(t.feedBacksProduct,t.sellerId),o={requestId:this._getRequestId(),purchaseDetails:s,purchaseDetailsSignature:t.feedBacksProduct.reviewSign},n=new FormData;n.append("request",new Blob([JSON.stringify(o)],{type:"application/json"})),t.userVideos.forEach((e=>{n.append("video",e)}));const i={method:"POST",body:n,credentials:"omit",signal:r},a={keepRespData:!0,redirectUnauth:!0,noProcessResponse:!0,timeout:2e4},d="Не получилось загрузить, попробуйте&nbsp;еще&nbsp;раз";try{const t=await this.$httpClient.fetchJSON(`${e}video/v1`,i,a);return this._validateResult(t,d,!0)}catch(e){return this._getErrorData(e,d)}},s._validateResult=function(e,t,r){if(!(null==e?void 0:e.data)){if(r){const t=this._getError(e.errorText);if(t.byCode&&"15"==t.code){const r={serviceErrorCode:t.code};return e.data=r,e}}return{data:null,error:!0,errorText:t,additionalErrors:null,loadingFailed:!0,serverError:!0}}const s=e=>{if(e.id)return e;if("clientError"===e.status||r){const t=this._getError(e.error);return!t.byCode&&t.canTryAgain||(e.serviceErrorCode=t.code),t.canTryAgain&&(e.serverError=!0),e}return e=Object.assign(Object.assign({},e),{errorText:t,loadingFailed:!0,serverError:!0})};return e.data=r?s(e.data):e.data.map((e=>s(e))),e},s._getErrorData=function(e,t){var r;if(null===(r=e.data)||void 0===r?void 0:r.errorText){let t=this._getError(e.data.errorText);return t.byCode&&(e.serviceErrorCode=t.code,e.canTryAgain=t.canTryAgain,t=t.canTryAgain?null:e.data.errorText),null==t&&(e.message=""),e.message=t,e}return e.isCustomError||"AbortError"===e.name?{data:null,error:!0,errorText:t,additionalErrors:null,loadingFailed:!0,serverError:!0}:{data:null,error:!0,errorText:"",additionalErrors:null}},s.loadBadReasonBubbles=async function(e){const t=`https://reviews-reasons.wb.ru/reviews-reasons/api/v1/w/bad-reasons/${e.data.subject_root_id}`,r=await this.$httpClient.fetchBasicJSON(t,{},{nullOnError:!0});if(null==r?void 0:r.reasons){return r.reasons.map((e=>({text:e,isActive:!1})))}return[]},s._sendFeedbackNew=async function(t,r){const s=await this._getPurchaseDetails(t.feedBacksProduct,t.sellerId),o={requestId:this._getRequestId(),purchaseDetails:s,purchaseDetailsSignature:t.feedBacksProduct.reviewSign,feedback:t.comment},n={method:"POST",body:JSON.stringify(o),headers:{"Content-Type":"application/json"}},i=Object.assign({keepRespData:!0,noProcessResponse:!0},r);return t.comment.parentFeedbackId?this.$httpClient.fetchJSON(`${e}extend/v1`,n,i):this.$httpClient.fetchJSON(`${e}v1`,n,i)},s.sendFeedback=async function(e,t,r,s){var o,n;const i={redirectUnauth:!0,tryResend:!0,timeout:3e3,tryTill:Date.now()+216e5};try{return await this._sendFeedbackNew(e,i),null==t?void 0:t()}catch(e){if(null===(o=null==i?void 0:i.modified)||void 0===o?void 0:o.timeout)return null==t||t(),this.$services.retryFetchService.saveRequest(url,options,i);if(e.isCustomError)wb.popup.showFeedbackError(e);else if(null===(n=e.data)||void 0===n?void 0:n.errorText){const t=this._getError(e.data.errorText);null==t?null==r||r():(e.message=t,wb.popup.showFeedbackError(e))}else null==r||r();return null==s?void 0:s()}},s._getError=function(e){for(let r in t){const s=new RegExp(t[r],"i"),o=e.match(s);if(o){if(["1","10","11"].includes(r))e={code:r,byCode:!0,canTryAgain:!0};else if(["2","12","13","15"].includes(r))e={code:r,byCode:!0};else if(1==o.length&&14==r)e="Поделиться мнением о товаре можно только один раз";else if(o.length>1&&2!=r){const t=o[1];if(e=e.replace(t,"Расскажите о товаре"),["3","6","7","9"].includes(r)&&3==o.length){const t=o[2];e=e.replace(t,"")}}break}}return e},s._getRequestId=function(){return URL.createObjectURL(new Blob).substr(-36)},s._getPurchaseDetails=async function(e,t){var r,s,o;const n=await this.$services.userData.getUserDataAsync(),i=parseInt(e.code1S);let a=e.supplierId||t;const{userInfo:d}=n||{};return{rid:e.rId,wbUserId:parseInt(d.id),globalUserId:(null===(r=this.$auth.jwtData)||void 0===r?void 0:r.user)||"",nmId:i,supplierId:parseInt(a||0),chrtId:parseInt(e.characteristicId),color:e.color||"",size:e.size||"",userDetails:{name:null!==(s=d.fullName)&&void 0!==s?s:"",country:null===(o=d.localeShortName)||void 0===o?void 0:o.toUpperCase(),hasPhoto:d.hasPhoto},productOrders:[{created:e.orderDateString,shkId:parseInt(e.shkId)}]}},s.getPurchasedGoodModel=async function(e,t){const r=await this.$httpClient.fetchJSON(`/webapi/product/comments/goodsArchive?nmId=${e}`,{method:"POST",body:new URLSearchParams({disableCheck:t})},{redirectUnauth:!0});return this._toPurchasedGoodModel(r)},s._toPurchasedGoodModel=function(e){if(!e)return null;const t=e.feedbackGoods,r=t.reduce(((e,t)=>(e.find((e=>e.code1S==t.code1S))||e.push(t),e)),[]),s=r.filter((e=>!!e.color)).map((e=>({name:e.color,value:e.code1S}))),o=r.find((e=>!e.color)),n=t.map((e=>e.size)).reduce(((e,t)=>(e.find((e=>e.name==t))||e.push({name:t,value:t}),e)),[]),i=1==s.length?s[0].value:0==s.length&&(null==o?void 0:o.code1S)?o.code1S:null,a="0"==t[0].size;return{colors:s,namelessColor:o,sizes:n,selectedCod1S:i?{value:i}:null,selectedSizeName:a||1==n.length?{value:n[0].value}:"",sizeless:a,selectedVisibility:e.selectedVisibility,visibilities:e.visibilities,feedbackGoods:t,getFeedBacksProduct:function(e,t,r){let s=e;return t&&(s=s.filter((e=>e.code1S==t))),r&&(s=s.filter((e=>e.size==r))),s[0]}}},r}();window.__spaServiceManager__.register("feedbacksService",r)})();
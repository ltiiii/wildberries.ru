(()=>{"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(e){var s=function(e,s){if("object"!=t(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,s||"default");if("object"!=t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===s?String:Number)(e)}(e,"string");return"symbol"==t(s)?s:s+""}function s(t,s){for(var n=0;n<s.length;n++){var r=s[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,e(r.key),r)}}function n(t,e,n){return e&&s(t.prototype,e),n&&s(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function r(t,e){return r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},r(t,e)}function i(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,r(t,e)}const o=function(){function t(e,s){Object.setPrototypeOf(t.prototype,WbSpaModel.prototype),this.isAuth=e,this.uid=s,this.baseUrl="by"===wb.settings.currentLocale?"https://chat-prod.wildberries.by":"https://chat-prod.wildberries.ru"}var e=t.prototype;return e.reinit=function(t,e){this.isAuth=t,this.uid=e},e.getHistoryAsync=function(t,{signal:e}={}){const s=new URL(this.getMessagesUrl);return t&&(s.search=new URLSearchParams(t).toString()),this._fetchService(s.toString(),{signal:e})},e.sendMessage=function(t,e){return this._fetchService(this.sendMessageUrl,{method:"POST",body:JSON.stringify(t),timeout:e||1e3},!0)},e.sendRating=function(t,e){return this._fetchService(this.getRateUrl(t,e))},e.sendChatRating=function(t,e,s){return this._fetchService(this.getRateChatUrl(e,s),{method:"POST",body:JSON.stringify(t)},!0)},e.sendOperatorRating=function(t){return this._fetchService(this.getRateOperatorUrl(),{method:"POST",body:JSON.stringify(t)},!0)},e.sendFile=function(t){const e=new FormData;return e.append("file",t),this._fetchService(this.fileUploadUrl,{method:"POST",processData:!1,body:e})},e._getEndpoint=function(t="v2"){return"api/support/"+(this.isAuth?t+"/client":"v1/unauth")},e.getRateUrl=function(t,e){let s=`${this.baseUrl}/${this._getEndpoint()}/rate?mark=${t}`;return e&&(s+=`&message_id=${e}`),s},e.getRateChatUrl=function(t,e){let s=`${this.baseUrl}/${this._getEndpoint("v3")}/rate/chat?mark=${t}`;return e&&(s+=`&message_id=${e}`),s},e.getRateOperatorUrl=function(){return`${this.baseUrl}/${this._getEndpoint("v3")}/rate/employee`},e._fetchService=function(t,e,s=!1){return e=Object.assign(e,this._requestOptions(s)),this.isAuth?this.$wbxHttpClient.fetch(t,e).then((t=>{if(t.ok)return t.json();throw new Error(t.statusText)})):this.$httpClient.fetchBasicJSON(t,e,{nullOnError:!0,timeout:null==e?void 0:e.timeout})},e._requestOptions=function(t=!1){const e={credentials:"omit",cache:"no-cache",headers:{locale:wb.settings.currentLocale}};return t&&(e.headers["Wb-Apptype"]="rusite"),this.isAuth||(e.headers.BasketUID=this.uid),e},n(t,[{key:"getMessagesUrl",get:function(){return`${this.baseUrl}/${this._getEndpoint("v4")}/messages`}},{key:"sendMessageUrl",get:function(){return`${this.baseUrl}/${this._getEndpoint()}/send`}},{key:"fileUploadUrl",get:function(){return`${this.baseUrl}/${this._getEndpoint()}/upload`}}])}(),a=/^((https:\/\/chat-basket-0\d.)wb(.ru\/.*))$/;const l=function(){function t({ctx:t,message:e,attachment:s,messageIndex:n,attachmentIndex:r,imgCounter:i}){this.parentIndex=n,this.index=r;const{url:o,name:l,size:c}=s;this.url=null==o?void 0:o.replace(a,"$2wbbasket$3"),this.name=l,this.size=c,(null==e?void 0:e.dt)&&(this.dt=e.dt),this.ctx=t,this.imgCounter=i}var e=t.prototype;return e.goToMessage=function(t,e){if(t.preventDefault(),t.stopPropagation(),Number.isInteger(this.parentIndex)){$.observable(this.ctx).setProperty({isTabsOpen:!1}),this.ctx.closeSlider();const t=this.ctx.chat.querySelector(`.chat__message:nth-last-of-type(${this.parentIndex})`);t&&t.scrollIntoView()}},e.download=function(t,e){if(t.preventDefault(),!this.url)return;window.navigator&&window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveOrOpenBlob(blob,data.fileName);const s=(t,e)=>{const s=document.createElement("a");s.href=t,s.download=this.name||wb.helpers.path.fileName(this.url),s.onclick=t=>t.stopPropagation(),s.target="_blank",document.body.appendChild(s),s.click(),setTimeout((()=>{document.body.removeChild(s),e&&URL.revokeObjectURL(t)}),200)};return fetch(this.url).then((async t=>{const e=await t.blob();if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,data.fileName);else{const t=URL.createObjectURL(e);s(t,!0)}})).catch((()=>s(this.url,!1))),!1},t}();const c=function(){function t(t,e,s){var n,r,i,o;function a(t,e,s){let n=t.get(e);n||(n=[],t.set(e,n)),n.push(s)}let c;this.groupedFiles=new Map,this.groupedImages=new Map,this.groupedLinks=new Map,this.images=[],this.ctx=e,this.hasLastMessageFromEmployer=!1;const h=new Map;$.observable(s).setProperty("notification",""),clearTimeout(s.timerForNotification);let u=[];[...t].forEach(((t,e)=>{const n=`${t.dt.getFullYear()}-${t.dt.getMonth()}`;let r=h.get(n);r||(r=new Date(t.dt),r.setHours(0,0,0,0),r.setDate(1),h.set(n,r));const i=e+1;if(!this.hasLastMessageFromEmployer&&(null==t?void 0:t.sender)&&(this.hasLastMessageFromEmployer=!0,t.toOperator)){const e={wait:"Оператор скоро подключится и поможет вам",apologize:"Извините, пока что все операторы заняты. Как только кто-то освободится, сразу напишем вам"},n=9e5-(new Date-new Date(t.dt));n>0?($.observable(s).setProperty("notification",e.wait),s.timerForNotification=setTimeout((()=>{$.observable(s).setProperty("notification",e.apologize),clearTimeout(s.timerForNotification)}),n)):$.observable(s).setProperty("notification",e.apologize)}t.hasFile()&&a(this.groupedFiles,r,{message:t,reverseIndex:i}),t.hasImage()&&(a(this.groupedImages,r,{message:t,reverseIndex:i}),this.images.push({message:t,reverseIndex:i}),t.images&&(c=t.images[t.images.length-1].imgCounter)),t.hasUrl()&&a(this.groupedLinks,r,{message:t,reverseIndex:i}),t.payload&&u.push(t)})),c||(c={counter:0});for(let t=this.images.length-1;t>=0;t--){const e=this.images[t].message;e.images||(e.images=null===(n=e.attachments)||void 0===n?void 0:n.images.map((t=>new l({message:e,attachment:t,imgCounter:c,attachmentIndex:c.counter++}))))}const d=[];u.forEach(((t,e)=>$.observable(t,d).setProperty("lastFromBot",0==e))),(null===(i=null===(r=u[0])||void 0===r?void 0:r.payload)||void 0===i?void 0:i.showProducts)&&this.ctx.loadMessageProducts(),null===(o=d.trigger)||void 0===o||o.call(d)}var e=t.prototype;return e.get=function(t="m"){return[...this._get(t)]},e.getImages=function(){return[...this._getAttachments(this.images,"m")]},e.isNotEmpty=function(){return this.groupedFiles.size+this.groupedImages.size+this.groupedLinks.size>0},e._getAttachments=function*(t,e){let s=0;let n={m:"images",d:"files",l:"urls"}[e];for(const{message:e,reverseIndex:r}of t){const t=e.attachments[n];for(const i of[...this._reverseArray(t)])yield new l({message:e,attachment:i,messageIndex:r,attachmentIndex:s++,ctx:this.ctx,attachmentType:n})}},e._reverseArray=function*(t){for(let e=t.length-1;e>=0;e--)yield t[e]},e._get=function*(t){if("m"!=t&&"d"!=t&&"l"!=t)throw new Error("wrong filter");const e={m:this.groupedImages,d:this.groupedFiles,l:this.groupedLinks};for(const[s,n]of e[t])yield{dt:s,attachments:[...this._getAttachments(n,t)]}},t}();function h(t){return h=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},h(t)}function u(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(u=function(){return!!t})()}function d(t){var e="function"==typeof Map?new Map:void 0;return d=function(t){if(null===t||!function(t){try{return-1!==Function.toString.call(t).indexOf("[native code]")}catch(e){return"function"==typeof t}}(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,s)}function s(){return function(t,e,s){if(u())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,e);var i=new(t.bind.apply(t,n));return s&&r(i,s.prototype),i}(t,arguments,h(this).constructor)}return s.prototype=Object.create(t.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),r(s,t)},d(t)}const g=function(t){function e(e){return t.call(this,e)||this}return i(e,t),e}(d(Error)),p=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,m=$.templates("Возврат одобрен. Принесите товар в пункт выдачи, в котором его получали. {{if refundPrice > 0}}<b>{{priceWithCurrencyV2:refundPrice iso=currency}}</b>{{else}}Денежные средства{{/if}} вернутся после того, как товар поступит на склад. О возврате денег проинформируем уведомлением в личном кабинете."),f=$.templates("Ваша заявка на возврат {{if refundPrice > 0}}<b>{{priceWithCurrencyV2:refundPrice iso=currency}}</b>{{else}}денежных средств{{/if}} одобрена{{if currency == 'RUB'}}, деньги поступят на баланс{{/if}}"),v={message:new Set(["create"]),refund:new Map([["sellerRejectRefund",()=>"Возврат товара отклонен"],["sellerRequestRefund",()=>'Чтобы вернуть товар, найдите его в Покупках, нажмите <span class="message__dots"></span> и выберите Вернуть товар по&nbsp;браку'],["sellerAcceptFullRefund",t=>f.render(t)],["sellerAcceptRefundInOffice",t=>m.render(t)]])},b=[{id:1,name:"Слишком долго"},{id:2,name:"Мне не помогли"},{id:3,name:"Не нравится решение"},{id:4,name:"Невежливо"},{id:5,name:"Смена оператора"},{id:6,name:"Пришлось повторять"}],y=[{id:7,name:"Медленно"},{id:8,name:"Мало информации"},{id:3,name:"Не нравится решение"},{id:4,name:"Невежливо"},{id:5,name:"Смена оператора"},{id:6,name:"Пришлось повторять"}],w=[{id:9,name:"Всё быстро"},{id:10,name:"Мне помогли"},{id:11,name:"Дружелюбно"}],P=[{id:"operator-rating-negative",text:"Плохо",value:1,class:"rate-operator__item--negative"},{id:"operator-rating-neutral",text:"Нормально",value:2,class:"rate-operator__item--neutral"},{id:"operator-rating-positive",text:"Хорошо",value:3,class:"rate-operator__item--positive"}];const x=function(){function t({id:t,chatId:e,text:s="",dt:n=new Date,inbox:r=!1,attachments:i,type:o="message",action:a,body:l,rating:c,translated:h,locale:u,uniqueId:d,isNew:g,to_operator:p,employee_id:m}){t&&(this.id=t),e&&(this.chatId=e),this.text=s,this.translated=h,this.locale=u,this.dt=new Date(n),this.inbox=r,this.toOperator=p,this.employeeId=m,i&&(this.attachments=i),this.type=o,this.action=a,this.ogLanguageExpanded=!1,"refund"==o&&l&&v[o].has(a)&&(this.custom=!0,this.text=v[o].get(a)({refundPrice:l.price/100,currency:l.priceCurrency})),c&&(this.rating=c)}var e=t.prototype;return e.setUniqueId=function({id:t,create:e}){return e?this.uniqueId=wb.helpers.generateGuid():t&&(this.uniqueId=t),this},e.hasFile=function(){var t,e;return(null===(e=null===(t=this.attachments)||void 0===t?void 0:t.files)||void 0===e?void 0:e.length)>0},e.hasImage=function(){var t,e;return(null===(e=null===(t=this.attachments)||void 0===t?void 0:t.images)||void 0===e?void 0:e.length)>0},e.hasUrl=function(){var t,e;return(null===(e=null===(t=this.attachments)||void 0===t?void 0:t.urls)||void 0===e?void 0:e.length)>0},e.files=function(){var t;return null===(t=this.attachments)||void 0===t?void 0:t.files.map((t=>new l({attachment:t})))},e.urls=function(){var t;return null===(t=this.attachments)||void 0===t?void 0:t.urls.map((t=>new l({attachment:t})))},e.setId=function(t){return this.id=t,this},e.setDt=function(t){return this.dt=t?new Date(t):new Date,this},e.setSender=function({id:t,name:e,bot:s}){return t||e?(this.sender={id:t,name:e,bot:s},this):this},e.addImage=function({url:t,name:e,size:s,type:n,date:r}){return t?(this.attachments||(this.attachments={}),this.attachments.images||(this.attachments.images=[]),this.attachments.images.push({url:t,name:e,size:s,type:n,date:r}),this):this},e.addFile=function({url:t,name:e,size:s,type:n,date:r}){return t?(this.attachments||(this.attachments={}),this.attachments.images||(this.attachments.files=[]),this.attachments.files.push({url:t,name:e,size:s,type:n,date:r}),this):this},e.tryLinkify=function(t){if(!this.text)return this;const e=new Set;if(t){const t=(new DOMParser).parseFromString(this.text,"text/html"),s=t.body.getElementsByTagName("a");s.length>0&&(s.forEach((t=>{t.target="_blank",e.add(t.href),t.href=encodeURI(t.href)})),t.body.querySelectorAll(":not(a)").forEach((t=>t.outerHTML=t.innerText)),this.text=t.body.innerHTML,this.custom=!0)}return this.text=this.text.replace(p,(t=>e.has(t)?t:(this.attachments||(this.attachments={}),this.attachments.urls||(this.attachments.urls=[]),this.attachments.urls.push({url:t}),""))),this},e.addPayload=function(t){var e;return this.payload=null===(e=null==t?void 0:t.interface_command)||void 0===e?void 0:e.reduce(((t,e)=>{var s,n,r,i,o;switch(e.type){case"TEXT":this.text=(null===(s=e.values[0])||void 0===s?void 0:s.text)||"";break;case"SHOW_PRODUCTS_LIST":t.showProducts=null!==(r=null===(n=e.values[0])||void 0===n?void 0:n.show)&&void 0!==r&&r;break;case"MENU":t.buttons=(null===(i=e.values)||void 0===i?void 0:i.map((t=>Object.assign(Object.assign({},t),{name:t.name.replace(/[<>]/g,"").trim()}))))||[];break;case"NAVIGATIONS":t.navigation=(null===(o=e.values)||void 0===o?void 0:o.map((t=>Object.assign(Object.assign({},t),{name:t.name.replace(/[<>]/g,"").trim()}))))||[]}return t}),{}),this},e.addSentActions=function(t){return this.inbox||((null==t?void 0:t.choose_product)?(this.text="Вопрос о товаре",t.choose_product.nmId>0&&(this.sentProduct=t.choose_product)):(null==t?void 0:t.choose_button)&&(this.text=t.choose_button.text)),this},e.addRateMessage=function(t,e){return t?(this.inbox=!this.rating,this.rateChat=!0,this.chatRated=this.rating>0,this.ratingButtonsSelected=[]):e&&(this.inbox=!this.rating,this.rateOperator=!0,this.operatorRating=this.rating,this.operatorRated=this.rating>0),this},e.getBy=function(t){return t?t<3?b:t>3?w:y:[]},e.getOperatorRatingButtons=function(){return P},e.expandOgLanguage=function(){$.observable(this).setProperty({ogLanguageExpanded:!this.ogLanguageExpanded})},t.createFromWbChat=function({message_id:t,msg_text:e,image_url:s,file_url:n,dt:r,is_inside:i,employee_id:o,employee_first_name:a,rate:l,to_operator:c,bot_payload:h,actions:u,rate_chat:d,rate_employee:g,idempotency_key:p}={}){return new this({id:t,text:e,dt:r,inbox:i,rating:l,rateChatAnswer:d,rateEmployee:g,to_operator:c}).setUniqueId({id:p}).addFile({url:n}).addImage({url:s}).setSender({id:o,name:a,bot:!!h||null}).tryLinkify(!0).addPayload(h).addSentActions(u).addRateMessage(d,g)},t.createFromEvent=function(t){var e,s,n;const r=t[t.eventType];if(!v[t.eventType]||!(null===(e=v[t.eventType])||void 0===e?void 0:e.has(null==r?void 0:r.actionType)))return null;const i=new this({chatId:t.chatID,type:t.eventType,action:r.actionType,body:r,text:null==r?void 0:r.text,translated:null==r?void 0:r.translated,locale:null==r?void 0:r.locale,attachments:Object.assign({},null==r?void 0:r.attachments),dt:new Date(t.addTime||t.clientCreatedAt),inbox:"seller"==(null===(s=t.sender)||void 0===s?void 0:s.type)||"wb"==(null===(n=t.sender)||void 0===n?void 0:n.type)}).tryLinkify();return"message"!=t.eventType&&i.setSender({name:"Бот Wildberries",bot:!0}),i},t.createBotMessage=function({chatID:t,dt:e}){const s=new this({chatId:t,text:"Ожидайте ответа продавца",dt:e,inbox:!0});return s.setSender({name:"Бот Wildberries",bot:!0}),s},t}();let _=function(t="",e,{isImage:s=!0}={}){this.mime=t,this.extensions=[].concat(e),this.isImage=s};const S=new _("image/jpg",["jpg","jpeg"]),I=Object.freeze({ffd8ffe0:S,ffd8ffe1:S,ffd8ffe2:S,ffd8ffe3:S,ffd8ffe8:S,"89504e47":new _("image/png","png"),25504446:new _("application/pdf","pdf",{isImage:!1})});let M=function(t){function e(e,s,{ctx:n,storageService:r}){var i,a;return(i=t.call(this)||this).ctx=n,i.storageService=r,i.isAuth=e,i.uid=s,i.chatService=new o(e,s),i.needPoll=!0,i.chatId="wb",i.name="wb",i.title="Поддержка Wildberries",i.currentPoll=null,i.pollId=null,i.isPremium=!!i.$auth.isAuth&&(null===(a=i.$user.getUserGradeFromCache())||void 0===a?void 0:a.isPremium),i._longPoll=i._longPoll.bind(i),i.sendRating=i.sendRating.bind(i),i.submitChatRating=i.submitChatRating.bind(i),i.wb=!0,i.isBroken=!1,i}i(e,t);var s=e.prototype;return s.initAsync=async function(){var t,e;try{const s={};(null===(e=null===(t=wb.global.settings)||void 0===t?void 0:t.switches)||void 0===e?void 0:e.enableChatBot)&&(s.enter_chat=!0);const n=await this.chatService.getHistoryAsync(s).then((t=>null==t?void 0:t.map((t=>x.createFromWbChat(t)))));return n?(this.history.push(...n),this._longPoll(),!0):(this.isBroken=!0,!1)}catch(t){return console.error(t),this.isBroken=!0,!1}},s.refreshAsync=async function(){$.observable(this.history).refresh([]),this.stopChat();const t=await this.chatService.getHistoryAsync().then((t=>t.map((t=>x.createFromWbChat(t)))));$.observable(this.history).refresh(t||[]),this.scrollToBottom(),this._longPoll()},s.sendRating=async function(t){const e=$.view(t.target),s=e.ctxPrm("message");if(s.rating)return!1;const n=e.data;if(!n||n>5)return!1;const r=e.ctxPrm("isMessageRate")?s.id:null,{message_id:i}=await this.chatService.sendRating(n,r).catch((()=>null))||{};if(!i)return wb.popup.renderModalError("Не удалось отправить оценку"),!1;$.observable(s).setProperty({rating:n})},s.showPopupRateChat=function(t){const e=$.view(t.target);e.ctxPrm("rating",e.data),$.views.loadTemplateAsync("PopupRateTmpl").then((s=>{const n=wb.popup.showCustomPopup({useHtml:!0,popupClassesList:["popup-rate-chat","shown","j-prevent-chat-close"],overlayClasses:["j-prevent-chat-close"],contentClasses:["popup__content"],useCenteredFunction:!0,onShow:e=>{s.link(e.querySelector(".popup__content"),{rating:this},{parentView:$.view(t.target),selectRating:function(t,e){e.view.ctxPrm("rating",$.view(t.target).data),e.view.ctxPrm("ratingButtonsSelected",[])},onSubmit:function(){n.close()}})},onHide:()=>{e.ctxPrm("message").chatRated||(e.ctxPrm("rating",0),e.ctxPrm("ratingButtonsSelected",[]))}})}))},s.selectRating=function(t){if(this.chatRated)return;const e=$.view(t.target);e.ctxPrm("rating",e.data),this.ctx.scrollIntoView(t,!0)},s.onCloseTooltip=function(){this.ctxPrm("rating",0)},s.showAdditionalRatingButtons=function(t){const e=$.view(t.target),s=e.ctxPrm("message");e.ctxPrm("rating",e.data),$.observable(s).setProperty({ratingButtonsSelected:[]})},s.submitChatRating=async function(t){var e,s;t.preventDefault();const n=$.view(t.target),r=n.data,i=r.ratingButtonsSelected.map((t=>+t)),o=n.ctxPrm("rating")||n.data.rating;if(!o)return!1;try{$.observable(r).setProperty({sendingMessage:!0});const{message_id:t}=await this.chatService.sendChatRating({reason:i},o,n.data.id)||{};if(!t)return wb.popup.renderModalError("Не удалось отправить оценку"),!1;if($.observable(r).setProperty({chatRated:!0,inbox:!1,rating:o,sendingMessage:!1}),n.ctxPrm("onSubmit")&&(null===(e=n.ctxPrm("onSubmit"))||void 0===e||e()),this.currentPoll)return null;this.pollId=setTimeout(this._longPoll,100)}catch(t){return $.observable(r).setProperty({sendingMessage:!1}),n.ctxPrm("onSubmit")&&(null===(s=n.ctxPrm("onSubmit"))||void 0===s||s()),console.log(t),null}},s.selectOperatorRating=function(t){const e=$.view(t.target);e.ctxPrm("operatorRating",e.data.value),this.ctx.scrollIntoView(t)},s.submitOperatorRating=async function(t){t.preventDefault();const e=$.view(t.target).data;try{$.observable(e).setProperty({sendingMessage:!0});const{message_id:t}=await this.chatService.sendOperatorRating({employee_id:`${e.sender.id}`||"1",message_id:e.id,rate:+e.operatorRating}).catch((()=>null))||{};if(!t)return wb.popup.renderModalError("Не удалось отправить оценку"),!1;if($.observable(e).setProperty({operatorRated:!0,inbox:!1,operatorRating:+e.operatorRating}),this.currentPoll)return null;this.pollId=setTimeout(this._longPoll,100)}catch(t){$.observable(e).setProperty({sendingMessage:!1}),console.log(t)}},s._saveUnsent=function(t){return this._refreshHistory([t]),t},s.resendMessage=async function(t){const e=$.view(t.target).data;$.observable(e).setProperty({sendingMessage:!0,errorMessage:!0,sending:!0});try{const{message_id:t}=await this.chatService.sendMessage(e.unsent,1e4)||{};if(t){if($.observable(e).removeProperty("unsent"),$.observable(e).removeProperty("sending"),this.currentPoll)return null;this.pollId=setTimeout(this._longPoll,100)}}catch(t){$.observable(e).setProperty({sendingMessage:!1,errorMessage:!0,sending:!1}),console.log(t)}},s.sendMessage=async function(t){var e,s;const n=new x({text:t,inbox:!1}).setUniqueId({create:!0}),r={msg_text:t,idempotency_key:n.uniqueId};try{const{message_id:t}=await this.chatService.sendMessage(r)||{};if(!t)throw new Error("Не удалось отправить сообщение");return this.currentPoll?null:(this.pollId=setTimeout(this._longPoll,100),n.setId(t))}catch(t){return n.unsent=r,n.id=null!==(s=null===(e=this.lastMessage())||void 0===e?void 0:e.id)&&void 0!==s?s:0,n}},s.chooseProduct=async function(t,e){const s=$.view(e.target.closest(".message")).data;$.observable(s).setProperty({sendingMessage:!0,errorMessage:!1});const{data:{rId:n,code1S:r,name:i,brand:o,price:a,currency:l,color:c,size:h,status:u,trackingStatus:d,trackingStatusId:g,lastDate:p}}=$.view(e.target),m=new x({inbox:!1}).setUniqueId({create:!0}),f={bot_pld:{actions:{choose_product:{srid:n,nmId:r,name:i,brand:o,price:a,currency:l,size:h,color:c,status:u,trackingStatus:d,trackingStatusId:g,lastDate:p}}},idempotency_key:m.uniqueId};m.addSentActions(f.bot_pld.actions);try{const{message_id:s}=await this.chatService.sendMessage(f)||{};if(!s){if(wb.popup.renderModalError("Не удалось отправить товар"),!t)throw new Error("Не удалось отправить сообщение");return}return t&&this.ctx.returnToHomeScreen(e),this.currentPoll?null:(this.pollId=setTimeout(this._longPoll,100),m.setId(s))}catch(e){return $.observable(s).setProperty({sendingMessage:!1,errorMessage:!0}),m.unsent=f,this._saveUnsent(m)}},s.chooseButtonWithAnswer=async function(t){const e=$.view(t.target).ctxPrm("message"),s=$.view(t.target).data,n=s.name.replace(/[<>]/g,"").trim();$.observable(e).setProperty({sendingMessage:!0,errorMessage:!1});const r=new x({inbox:!1}).setUniqueId({create:!0}),i={bot_pld:{actions:{choose_button:{id:s.code,text:n}}},idempotency_key:r.uniqueId};r.addSentActions(i.bot_pld.actions);try{const{message_id:t}=await this.chatService.sendMessage(i)||{};if(!t)throw new Error("Не удалось отправить сообщение");return this.currentPoll?null:(this.pollId=setTimeout(this._longPoll,100),r.setId(t))}catch(t){return $.observable(e).setProperty({sendingMessage:!1,errorMessage:!0}),r.unsent=i,this._saveUnsent(r)}},s.openAllProductsScreen=function(t){t.stopPropagation(),$.observable(this).setProperty({screen:"products"}),$.observable(this.ctx).setProperty({isMessageSearchOpen:!1}),this.ctx.resetSearch("home"),0==this.ctx.totalProducts.length&&$.observable(this.ctx.archiveFilters).setProperty({offset:0})},s.returnToHomeScreen=async function(t){t.stopPropagation(),$.observable(this).setProperty({screen:"home"})},s.sendFile=async function(t,e){var s,n;const r=new x({inbox:!1}).setUniqueId({create:!0}),i={idempotency_key:r.uniqueId},{url:o}=await this.chatService.sendFile(t)||{};if(!o)throw new Error("Не удалось загрузить файл");try{i[e?"image_url":"file_url"]=o,r.addFile({url:i.file_url}).addImage({url:i.image_url});const{message_id:t}=await this.chatService.sendMessage(i)||{};if(!t)throw new Error("Не удалось отправить сообщение");return this.currentPoll?null:(this.pollId=setTimeout(this._longPoll,100),r.setId(t))}catch(t){return r.unsent=i,r.id=null!==(n=null===(s=this.lastMessage())||void 0===s?void 0:s.id)&&void 0!==n?n:0,r}},s._longPoll=async function(){var t,e,s,n,r,i;if((null===(e=null===(t=wb.global.settings)||void 0===t?void 0:t.switches)||void 0===e?void 0:e.enableChatBot)||this.history.length>0){this.currentPoll=new AbortController;try{const t=Math.max(this.lastId||0,null!==(n=null===(s=this.lastMessage())||void 0===s?void 0:s.id)&&void 0!==n?n:0)+1,e=await this.chatService.getHistoryAsync({message_id:t,lp:!0,delay:50},{signal:this.currentPoll.signal}).then((t=>(null==t?void 0:t.map((t=>x.createFromWbChat(t))))||[]));this.lastId=null===(r=null==e?void 0:e[e.length-1])||void 0===r?void 0:r.id,this._refreshHistory(e);e.length>0&&(null===(i=this.lastMessage())||void 0===i?void 0:i.inbox)&&(this.chat.isVisible()?this.visit({dt:+this.lastMessage().dt,observe:!0}):this.$eventBus.dispatchEvent(new CustomEvent("OnlineChatShowUnread"))),this.pollId=setTimeout(this._longPoll.bind(this),100)}catch(t){console.log(t),this.pollId=setTimeout(this._longPoll.bind(this),6e4)}}},n(e,[{key:"template",get:function(){return e.template}}])}(function(){function t(){this.unreadCount=0,this.uploading=!1,this.uploadingImg=!1,this.tooltipTag=!!$.views.tags.tooltip,this.history=[],this.timerForNotification=null,this.onSubmit=this.onSubmit.bind(this),this.onFileChange=this.onFileChange.bind(this),this.beginSearch=this.$helper.debounce(this.beginSearch.bind(this),500),this.lastMessage.depends="history.length",$.observe(this,"history.length","maxSeen",((t,e)=>{let s=0;if(this.maxSeen&&!Number.isNaN(this.maxSeen))for(const t of this.reverseHistory()){if(+t.dt<=this.maxSeen)break;t.inbox&&s++}$.observable(this).setProperty({unreadCount:s})})),this.foundPatterns=[],this.searchIndex=0,this.maxSeen=0;const t=()=>new c([...this.reverseHistory()],this.ctx,this);Object.defineProperty(this,"filteredWrapper",{get(){const e=t();return Object.defineProperty(this,"filteredWrapper",{value:e,writable:!0,configurable:!0}),e},configurable:!0,enumerable:!0}),$.observe(this,"history.length",((e,s)=>$.observable(this).setProperty({filteredWrapper:t()})))}var e=t.prototype;return e.reverseHistory=function*(){for(let t=this.history.length-1;t>=0;t--)yield this.history[t]},e.init=function(t,e){return this.chat=e,this},e.stopChat=function(){this.currentPoll&&this.currentPoll.abort(),clearTimeout(this.pollId),this.currentPoll=null},e.scrollToBottom=function(){var t;const e=null===(t=this.chat)||void 0===t?void 0:t.querySelector(".j-chat-body");e&&(e.scrollTop=e.scrollHeight-e.clientHeight)},e.visit=function({dt:t,observe:e}){e?$.observable(this).setProperty({maxSeen:+t}):this.maxSeen=+t,this.storageService.updateMaxSeen({chatID:this.chatId,ts:+t})},e.sendMessage=async function(t){return{}},e.sendFile=async function(){},e.lastMessage=function(){return this.history[this.history.length-1]},e.onInput=function(t){t.target.style.height="auto";const e=t.target.scrollHeight;t.target.style.height=e+"px"},e.onSubmit=function(){if(!this.text||0===this.text.trim().length)return!1;const t=$.views.helpers.stripHtml(this.text),e=document.querySelector(".j-chat-textarea");return this.chat.querySelector(".j-fake-for-focus").focus(),$.observable(this).setProperty({uploading:!0}),this.$helper.debounce(this.sendMessage(t).then((t=>{var s,n,r;t?(this._refreshHistory([t]),this.visit({dt:+t.dt}),(null===(n=null===(s=t.attachments)||void 0===s?void 0:s.goodCard)||void 0===n?void 0:n.needRefund)&&setTimeout((()=>{const t=x.createBotMessage({chatID:this.chatID});this._refreshHistory([t]),this.visit({dt:Date.now()})}),500),null===(r=this.afterSubmit)||void 0===r||r.call(this),this.afterSubmit=null):this.visit({dt:Date.now()}),$.observable(this).setProperty({text:""}),e.style.height="auto",$.observable(this).removeProperty("onTop")})).catch((t=>{console.error("[Online Chat]:",t)})).finally((()=>{$.observable(this).setProperty({uploading:!1}),e.focus()})),100),!1},e.onKeyPress=function(t,e){13!==t.which||t.shiftKey||(t.target.form.dispatchEvent(new Event("submit",{cancelable:!0})),t.preventDefault())},e.onFileChange=function(t){$.observable(this).setProperty({uploading:!0});const e=t.currentTarget,s=e.files[0];return e.value="",this._onFileChangeAsync(s).then((t=>$.observable(this).removeProperty("onTop"))).finally((t=>{$.observable(this).setProperty({uploading:!1,uploadingImg:!1})}))},e.highlight=function(){var t;const e=this.parentElem||(null===(t=this.tag)||void 0===t?void 0:t.parentElem);e&&e.scrollIntoView({behavior:"smooth"})},e.unhighlight=function(t){t.target.classList.remove("blinking")},e.setSearching=function(t,e){$.observable(this).setProperty("searching",!0),$.observable(this).setProperty("searchingComplete",!1)},e.onSearchEnter=function(t,e){var s;return"Enter"==t.key&&(!(!this.searchingComplete&&!(null===(s=this.foundPatterns)||void 0===s?void 0:s.length))&&void this.goNextSearch())},e.beginSearch=function(t,e){var s;const n=[];$.observable(this.foundPatterns,n).refresh([]),$.observable(this,n).setProperty("searchIndex",0);const r=null===(s=t.target.value)||void 0===s?void 0:s.trim().replace(/[/\-\\^$*+?.()|[\]{}]/g,"\\$&");if($.observable(this).setProperty("searchText",r),r&&/[\wА-Яа-я]/.test(r)){const t=new RegExp(r,"ig");let e=0;for(const s of this.history)s.text&&t.test(s.text)?($.observable(s,n).setProperty("foundText",$.views.helpers.stripHtml(s.text).replace(t,(t=>`<span class="message__text-highlited">${t}</span>`))),$.observable(this.foundPatterns,n).insert(e)):$.observable(s,n).removeProperty("foundText"),e++;$.observable(this).setProperty("searchingComplete",!0),this.ctx.sendAnalytics("Purchases_Chat_Search_Send")}else{for(const t of this.history)$.observable(t,n).removeProperty("foundText");t.target.value||$.observable(this).setProperty("searchingComplete",!1)}n.trigger(),$.observable(this).setProperty("searching",!1)},e.clearSearch=function(t,e){t.stopPropagation();const s=[];$.observable(e.view.root.data,s).setProperty("searchText",""),$.observable(this.foundPatterns,s).refresh([]),$.observable(this,s).setProperty("searchIndex",0);for(const t of this.history)$.observable(t,s).removeProperty("foundText");s.trigger(),$.observable(this).setProperty("searchingComplete",!1),$.observable(this).setProperty("searchText","")},e.goPrevSearch=function(t){const e=this.searchIndex<=1?this.foundPatterns.length:this.searchIndex-1;1==this.searchIndex&&1==e&&$.observable(this).removeProperty("searchIndex"),$.observable(this).setProperty("searchIndex",e)},e.goNextSearch=function(t){const e=this.searchIndex>=this.foundPatterns.length?1:this.searchIndex+1;1==this.searchIndex&&1==e&&$.observable(this).removeProperty("searchIndex"),$.observable(this).setProperty("searchIndex",e)},e.isEmpty=function(t){return!t||""===t.trim()},e.downloadAttachment=function(t,e){$.view(t.target).data.download(t,e)},e._refreshHistory=function(t){if(!Array.isArray(t)||0==t.length)return;const e=this.history.reduce(((t,e)=>(e.uniqueId&&t.add(e.uniqueId),t)),new Set);e.size>0&&(t=t.filter((t=>!e.has(t.uniqueId)))),$.observable(this.history).insert(t),this.scrollToBottom()},e._onFileChangeAsync=async function(t){try{const{supported:e,isImg:s}=await this._getFileInfo(t);if(!e)return void wb.popup.renderModalError("Файл не поддерживается");if(this.ctx.chat.dispatchEvent(new CustomEvent("sellerChat_upload",{detail:{type:s?"media":"file",quantity:1}})),t.size>=10485760)return void wb.popup.renderModalError("Слишком большой файл");s&&($.observable(this).setProperty({uploadingImg:!0}),this.scrollToBottom());const n=await this.sendFile(t,s);n&&(this._refreshHistory([n]),this.visit({dt:+n.dt}))}catch(t){console.error(t);const e=t instanceof g?t.message:"Ошибка при отправке сообщения";wb.popup.renderModalError(e)}},e._getFileInfo=async function(t){const e=await this.$moduleLoader.loadModuleAsync("promisifiedFileReader"),s=await(new e).readAsArrayBuffer(t.slice(0,4)),n=new Uint8Array(s).reduce(((t,e)=>t+e.toString(16)),""),r=wb.helpers.path.extension(t.name),i=I[n];return(null==i?void 0:i.extensions.includes(r))?{supported:!0,isImg:i.isImage}:{supported:!1}},t}());window.__spaModuleManager__.register("onlineChat",M)})();
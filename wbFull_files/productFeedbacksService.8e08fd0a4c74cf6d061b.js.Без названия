(()=>{"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(t){var n=function(t,n){if("object"!=e(t)||!t)return t;var o=t[Symbol.toPrimitive];if(void 0!==o){var a=o.call(t,n||"default");if("object"!=e(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(t)}(t,"string");return"symbol"==e(n)?n:n+""}function n(e,n){for(var o=0;o<n.length;o++){var a=n[o];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,t(a.key),a)}}function o(e,t){return o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},o(e,t)}function a(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,o(e,t)}var r=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(o=Object.getOwnPropertySymbols(e);a<o.length;a++)t.indexOf(o[a])<0&&Object.prototype.propertyIsEnumerable.call(e,o[a])&&(n[o[a]]=e[o[a]])}return n};const i="wb_feedbacks_summary",s="wb_feedbacks",c="createDt",d="productValuation",u="votesBalance";const l=function(e){function t(){var t;return(t=e.call(this)||this).interval=t._startBackgroundTask(),t}a(t,e);var n=t.prototype;return n.loadFeedbacksByPhotoVideoIds=async function(e,t){if(!e)return t;const n=await this._openDb(),o=await this.$storageHelper.getItem(n,i,e);if(null==o||o.ttl<Date.now())return null;const a=o.mediaItemsMap,r=t.reduce(((e,t)=>{const n=a.get(t.id);return n?(t.feedbackId=n,e.add(n),e):(t.feedbackFailed=!0,e)}),new Set).toArray(),s=await this.loadFeedbacksByIds(e,r);return t.forEach((e=>{e.feedback=s.get(e.feedbackId)})),s},n.loadFeedbacksByIds=async function(e,t){const n=`feedbacks-${e}`,o=(await this._openFeedbacksDb(n)).transaction([s],"readwrite").objectStore(s),a=t.reduce(((e,t)=>{const n=(a=t,new Promise((e=>{const t=o.get(a);t.onsuccess=()=>{const n=t.result;e(n)},t.onerror=t=>{console.error(`Error to get student information: ${t}`),e(null)}})));var a;return e.push(n),e}),[]),r=(await Promise.all(a)).reduce(((e,t)=>(t&&e.set(t.id,t),e)),new Map);return r},n.getSummary=async function(e,t,n){var o,a,r,s,c,d,u;const l=await this._openDb(),h=await this.$storageHelper.getItem(l,i,e);if(null==h||h.ttl<Date.now())return null;if(!(null===(o=h.mediaItems)||void 0===o?void 0:o.length)&&((null===(a=h.photo)||void 0===a?void 0:a.length)||(null===(r=h.video)||void 0===r?void 0:r.length)))return null;const b=n.nmId&&h.summaryByNm?h.summaryByNm[n.nmId]:null,p=!!n.nmId&&!!h.summaryByNm&&!!h.summaryByNm[n.nmId];let f;n.byNmId?p?(f=b,n.hasPhoto&&0==b.feedbackCountWithPhoto&&(n.hasPhoto=!1),n.hasVideo&&0==b.feedbackCountWithVideo&&(n.hasVideo=!1)):f=Object.assign(Object.assign({},h),{mediaItems:[],feedbacks:[],feedbackCountWithText:0,feedbackCountWithPhoto:0,feedbackCountWithVideo:0}):f=h;const m=await this._openFeedbacksDb(h.tableId),v=await this._loadFeedbacks(m,n);if((null===(s=f.pinnedFeedbacks)||void 0===s?void 0:s.length)>0){const e=f.pinnedFeedbacks.find((e=>(!n.byNmId||e.nmId==n.nmId)&&e.wbUserDetails));if(e&&(!n.hasVideo||e.video)&&(!n.hasPhoto||(null===(c=e.photo)||void 0===c?void 0:c.length))){const t=v.findIndex((t=>t.id===e.id));-1!==t&&v.splice(t,1),0===n.skip&&(e.pinned=!0,v.unshift(e),e.video&&!h.mediaItemsMap.has(e.video.id)&&h.mediaItemsMap.set(e.video.id,e.id),null===(d=e.photo)||void 0===d||d.forEach((t=>{h.mediaItemsMap.has(t)||h.mediaItemsMap.set(t,e.id)})))}}return(null===(u=f.premiumUsers)||void 0===u?void 0:u.length)>0&&v.forEach((e=>{f.premiumUsers.some((t=>t==e.globalUserId))&&(e.isPremiumUser=!0)})),f.feedbacks=v,f.votes=this._collectUserVotes(f.votes,t),f.summaryAll=h,f.currentIsByNm=n.byNmId,f.allFeedbackCount=h.feedbackCount,f.allFeedbackCountWithText=h.feedbackCountWithText,p&&(f.byNmFeedbackCount=b.feedbackCount,f.byNmFeedbackCountWithText=b.feedbackCountWithText),f},n.getFeedbacks=async function(e,t){const n=await this._openDb(),o=await this.$storageHelper.getItem(n,i,e);if(null==o)return null;const a=await this._openFeedbacksDb(o.tableId),r=await this._loadFeedbacks(a,t);return null!=r?r:[]},n.saveFeedbacks=async function(e,t){const n=await this._openDb(),{feedbacks:o}=e,a=r(e,["feedbacks"]),c=Date.now()+9e5,d=await this.$storageHelper.getAll(n,i);if(d.length>=3){d.sort(((e,t)=>t.ttl-e.ttl));const e=[];for(;d.length>=3;)e.push(this.$storageHelper.removeDb(d[0].tableId)),e.push(this.$storageHelper.removeItem(n,i,d[0].id)),d.pop();await Promise.all(e)}const u=`feedbacks-${t}`;n.transaction([i],"readwrite").objectStore(i).put(Object.assign({ttl:c,tableId:u,id:t},a));const l=(await this._openFeedbacksDb(u)).transaction([s],"readwrite").objectStore(s);o.forEach((e=>l.put(e)))},n.updateVote=async function(e,t,n,o,a){var r;const c=await this._openDb(),d=await this.$storageHelper.getItem(c,i,e);if(null===d)return;const u={id:t,vote:n>0?"plus":"minus"};function l(e,t,n){e.votes[t]?e.votes[t].push(n):e.votes[t]=[n]}if(l(d,o,u),a){l(null===(r=d.summaryByNm)||void 0===r?void 0:r[a],o,u)}c.transaction([i],"readwrite").objectStore(i).put(d);const h=await this._openFeedbacksDb(d.tableId),b=String.format(s,d.tableId),p=await this.$storageHelper.getItem(h,b,t);p.votes||(p.votes={pluses:0,minuses:0}),n>0?p.votes.pluses++:p.votes.minuses++,p.votesBalance=p.rank,await this.$storageHelper.setItem(h,b,p)},n._openDb=async function(){try{return await this.$storageHelper.openDb("wb_feedbacks_v1",{onupgradeneeded(e){indexedDB.deleteDatabase("wb_feedbacks");e.createObjectStore(i,{keyPath:"id"}).createIndex("ttl","ttl",{unique:!1})},version:1})}catch(e){return null}},n._openFeedbacksDb=async function(e){return await this.$storageHelper.openDb(e,{onupgradeneeded(e){const t=e.createObjectStore(s,{keyPath:"id"});t.createIndex(c,c,{unique:!1}),t.createIndex(u,u,{unique:!1}),t.createIndex(d,d,{unique:!1})},version:1})},n._loadFeedbacks=function(e,t){return new Promise((n=>{var o,a;const r=[],i=e.transaction([s],"readwrite"),{indexName:c,cursorQuery:d,direction:u}=this._getSearchParams(t),l=null!==(a=null===(o=t.productValuation)||void 0===o?void 0:o.toHashSet())&&void 0!==a?a:new Set,h=i.objectStore(s).index(c);let b=0,p=0;h.openCursor(d,u).onsuccess=e=>{const o=e.target.result,a=null==o?void 0:o.value;if(!o||p==t.take)return n(r);if(t.byNmId&&t.nmId&&t.nmId!=a.nmId)return o.continue();if(!(Array.isArray(a.photo)&&0!=a.photo.length||a.video||""!=a.text||""!=a.pros||""!=a.cons))return o.continue();if(t.hasPhoto&&t.hasVideo&&!(Array.isArray(a.photo)&&0!==a.photo.length||a.video))return o.continue();if(t.hasPhoto&&t.hasVideo)if(a.parentFeedback){if(!(Array.isArray(a.parentFeedback.photo)&&0!==a.parentFeedback.photo.length||a.parentFeedback.video))return o.continue()}else if(!(Array.isArray(a.photo)&&0!==a.photo.length||a.video))return o.continue();if(!t.hasVideo&&t.hasPhoto)if(a.parentFeedback){if(!Array.isArray(a.parentFeedback.photo)||0==a.parentFeedback.photo.length)return o.continue()}else if(!t.hasVideo&&t.hasPhoto&&(!Array.isArray(a.photo)||0==a.photo.length))return o.continue();if(!t.hasPhoto&&t.hasVideo)if(a.parentFeedback){if(!a.parentFeedback.video)return o.continue()}else if(!a.video)return o.continue();return l.size>0&&!l.has(a.productValuation)?o.continue():b<t.skip?(b++,o.continue()):(r.push(o.value),p++,void o.continue())}}))},n._getSearchParams=function(e){let t,n,o;switch(e.order){case"dateAsc":t=c,n=IDBKeyRange.bound(-1/0,1/0),o="next";break;case"valuationDesc":t=d,n=IDBKeyRange.bound(0,5),o="prev";break;case"valuationAsc":t=d,n=IDBKeyRange.bound(0,5),o="next";break;case"rankDesc":t=u,n=IDBKeyRange.bound(-1/0,1/0),o="prev";break;case"rankAsc":t=u,n=IDBKeyRange.bound(-1/0,1/0),o="next";break;default:t=c,n=IDBKeyRange.bound(-1/0,1/0),o="prev"}return{indexName:t,cursorQuery:n,direction:o}},n._collectUserVotes=function(e,t){return e[t]?e[t].reduce(((e,t)=>(e[t.id]=t.vote,e)),{}):{}},n._startBackgroundTask=function(){return this._removeOutDateCache(),setInterval(this._removeOutDateCache.bind(this),6e4)},n._removeOutDateCache=async function(){const e=(await this._openDb()).transaction([i],"readwrite").objectStore(i);e.index("ttl").openCursor(IDBKeyRange.upperBound(Date.now())).onsuccess=t=>{const n=t.target.result;n&&(e.delete(n.value.id),this.$storageHelper.removeDb(n.value.tableId),n.continue())}},t}(WbSpaModel);const h=function(){function e(){}return e.fromStatic=function(e){var t,n;if(!e)return{summary:e,votes:{}};const o=this._adaptFromStatic(e),a=new Map,r=new Map,i=[];let s=0;const c=[],d=new Map;null===(t=o.feedbacks)||void 0===t||t.forEach((e=>{var t;e.video&&(s++,a.set(e.video.id,e.id),c.push(Object.assign({isVideo:!0},e.video))),null===(t=e.photo)||void 0===t||t.forEach((t=>{a.set(t,e.id),c.push({id:t})})),r[e.id]=Object.assign(Object.assign({},e),{hasParentReview:!1}),d.set(e.nmId,[...d.get(e.nmId)||[],e])}));for(const e of Object.values(r)){const t=r[e.parentFeedbackId];e.id&&t&&(r[e.id].parentFeedback=t,r[e.id].hasParentReview=!0),e.childFeedbackId||i.push(e)}o.feedbacks=i,null===(n=o.photo)||void 0===n||n.forEach((e=>{a.get(e)||c.push({id:e})})),o.mediaItems=c,o.mediaItemsMap=a,o.feedbackCountWithVideo=s;const u=d.reduce(((t,n,o)=>{let a=0,r=0;const i=[];n.forEach((e=>{var t;e.video&&(r++,i.push(Object.assign({isVideo:!0},e.video))),(null===(t=e.photo)||void 0===t?void 0:t.length)&&(a++,e.photo.forEach((e=>{i.push({id:e})})))}));const s=Object.assign(Object.assign({},e),{feedbacks:n,feedbackCount:n.length,feedbackCountWithText:n.filter((e=>!!e.text)).length,feedbackCountWithPhoto:a,feedbackCountWithVideo:r,mediaItems:i});return t[o]=this._adaptFromStatic(s),t}),{});return o.summaryByNm=u,o},e._adaptFromStatic=function(e){const t={};let{valuationDistribution:n,valuationDistributionPercent:o,feedbackCount:a,feedbackCountWithText:r,valuation:i,matchingSizePercentages:s,feedbacks:c}=e;i=parseFloat(i).toFixed(1),c=this.feedbacksFromStatic(c,t);const d=s;return n=!n||a<1?null:Array.from({length:5},((e,t)=>5-t)).map((e=>{var t;return{valuation:e,share:null!==(t=null==o?void 0:o[e])&&void 0!==t?t:Math.round(100*n[e]/a),count:n[e]}})),Object.assign(Object.assign({},e),{valuation:i,feedbacks:c,matchingSizeDistribution:d,valuationDistribution:n,votes:t})},e.feedbacksFromStatic=function(e,t){return Array.isArray(e)?e.map((e=>{var n;return null===(n=e.feedbackHelpfulness)||void 0===n||n.forEach((n=>{t[n.wbUserId]?t[n.wbUserId].push({id:e.id,vote:n.helpfulness}):t[n.wbUserId]=[{id:e.id,vote:n.helpfulness}]})),e.video&&!e.video.id&&(e.video=null),Object.assign({createDt:new Date(e.createdDate).getTime(),votesBalance:e.rank},e)})):[]},e.fromService=function(e){if(!e)return e;const{valuationDistribution:t,feedbackCount:n}=e;return e.valuationDistribution=!t||n<1?null:Object.entries(t).map((([e,t])=>({valuation:parseInt(e),share:t,count:Math.round(t*n/100)}))).sort(((e,t)=>t.valuation-e.valuation)),e},e}();const b=function(){function e(){}return e.numToUint8Array=function(e){const t=new Uint8Array(8);for(let n=0;n<8;n++)t[n]=e%256,e=Math.floor(e/256);return t},e.crc16Arc=function(e){const t=this.numToUint8Array(e);let n=0;for(let e=0;e<t.length;e++){n^=t[e];for(let e=0;e<8;e++)(1&n)>0?n=n>>1^40961:n>>=1}return n},e}();var p=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(o=Object.getOwnPropertySymbols(e);a<o.length;a++)t.indexOf(o[a])<0&&Object.prototype.propertyIsEnumerable.call(e,o[a])&&(n[o[a]]=e[o[a]])}return n};const f=new(function(e){function t(){var t;return(t=e.call(this)||this).cache=new l,t}a(t,e);var n=t.prototype;return n.loadFeedbacksByPhotoVideoIds=async function(e,t){return await this.cache.loadFeedbacksByPhotoVideoIds(e,t)},n.loadSummaryAndVotes=async function(e,t,n,o=null,a=0,r=!1,i=!1,s=!1){const{userInfo:c}=await this.$services.userData.getUserDataAsync(),d=await this.cache.getSummary(e,c.id,{order:null!=o?o:"dateDesc",take:30,skip:0,nmId:t,byNmId:r,hasPhoto:i,hasVideo:s});if(null!=d){const{votes:e}=d;return{summary:p(d,["votes"]),votes:e}}return null==await this._loadStaticFeedbacks(e)||a>0?{summary:{feedbackCount:0},votes:{}}:this.loadSummaryAndVotes(e,t,n,o,a++,r,i,s)},n.loadFeedbacksAsync=async function(e,t,n=0){const o=await this.cache.getFeedbacks(e,t);if(null!=o)return o;return null==await this._loadStaticFeedbacks(e,0)||n>0?[]:this.loadFeedbacksAsync(e,t,n++)},n.voteUpdate=async function(e,t,n){const{userInfo:o}=await this.$services.userData.getUserDataAsync();this.cache.updateVote(e,t,n,o.id)},n._prepareUrl=function(e){const t=b.crc16Arc(e);return String.format("https://feedbacks{0}.wb.ru",t%100>=50?"2":"1")},n._loadStaticFeedbacks=async function(e){const t=this._prepareUrl(e);try{const[n,o]=await Promise.all([this.loadPinnedFeedbackAsync(e),this.$httpClient.fetchBasicJSON(`${t}/feedbacks/v2/${e}`)]);o.pinnedFeedbacks=n;const a=o.feedbacks.map((e=>e.globalUserId));await this.$getService("premiumSubscriptionService").then((e=>e.getPremiumUsers(a,500))).then((({marks:e})=>(null==e?void 0:e.length)>0?($.observable(o).setProperty({premiumUsers:e}),o.premiumUsers=e,e):[])).catch((e=>(console.log(e),[])));const r=h.fromStatic(o);return await this.cache.saveFeedbacks(r,e),r}catch(e){return null}},n.loadPinnedFeedbackAsync=async function(e){var t,n,o;const a="https://pin.wb.ru/pin-user-api/api/v1/pin/w/card/"+e;if(null===(o=null===(n=null===(t=wb.global)||void 0===t?void 0:t.settings)||void 0===n?void 0:n.switches)||void 0===o?void 0:o.enableFeedbackFirstLock)try{const e=await this.$httpClient.fetchBasicJSON(a,{method:"GET"},{timeout:500});return e.Items&&e.Items.length>0?e.Items.map((e=>e.Feedback)):[]}catch(e){return[]}},n.loadPremiumUsers=async function(e){return await this.$httpClient.fetchBasicJSON("https://highlight.wildberries.ru/highlight-api/api/v1/w/users/mark",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({users:e})}).then((e=>e)).catch((e=>{console.log(e)}))},t}(WbSpaModel));let m=function(){function e(){}var t,o,a,r=e.prototype;return r.loadFeedbacksByPhotoVideoIds=async function(e,t){return this.provider.loadFeedbacksByPhotoVideoIds(e,t)},r.loadSummaryAndVotes=async function(e,t,n,o,a=0,r=!1,i=!1,s=!1){return this.provider.loadSummaryAndVotes(e,t,n,o,a,r,i,s)},r.loadFeedbacksAsync=async function(e,t){return this.provider.loadFeedbacksAsync(e,t)},r.saveFeedbacksModelToCache=function(e,t){var n,o;null===(o=(n=this.provider).saveFeedbacksModelToCache)||void 0===o||o.call(n,e,t)},r.voteUpdate=function(e,t,n){this.provider.voteUpdate(e,t,n)},r.dropFromCache=function(e){var t,n;null===(n=(t=this.provider).dropFromCache)||void 0===n||n.call(t,e)},t=e,(o=[{key:"provider",get:function(){return f}}])&&n(t.prototype,o),a&&n(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}();window.__spaServiceManager__.register("productFeedbacksService",m)})();
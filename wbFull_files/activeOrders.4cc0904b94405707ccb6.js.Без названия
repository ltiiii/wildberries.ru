(()=>{"use strict";let e=function(){function e(e){this.model=e,this.model.options||(this.model.options={}),this.model.options.caller="ActiveOrdersViewModel",this.model.options.useTracker=!0,this.model.signedBalance={walletLimit:0},this.bankCardsReceived=!1,this.requestedWalletUpgrade=!1,this.isWalletUpgraded=!1,this.isUpgradeWalletAlertClosed=wb.global.userSettings.closed.includes("upgrade_wallet_alert_closed"),this.openCommentPopup=this.openCommentPopup.bind(this),this.onResize=this.$helper.throttle((()=>this._onResize()),50)}var s=e.prototype;return s.onBeforeRender=async function(){var e,s,i,n,a;Object.assign(this.model,await this.$getService("groupedDeliveriesService").then((e=>e.get(this.model.options)))),this.$user.getBalance({timeout:2e3}).catch((e=>Promise.resolve())).then((e=>this._setBalance(e))),this.$services.cartService.getBankCards(2e3).catch((e=>Promise.resolve())),this.model.actionMenuHelper={chatEnabled:()=>this.model.chatEnabled},this.model.isCacheEmpty&&(this.model.loadingError=await this.$getLoadingError()),this.model.needEvaluate=null,this.model.recentItems=[],this.model.areNoDeliveries=function(){var e,t,s,i;return(null!==(t=null===(e=this.failedPayments)||void 0===e?void 0:e.length)&&void 0!==t?t:0)+this.active.length+(null!==(i=null===(s=this.postPayments)||void 0===s?void 0:s.length)&&void 0!==i?i:0)===0},this.model.areNoDeliveries.depends=["active","failedPayments"];const o=[];if(this.nonExpiredPayments=[],(null===(e=this.model.failedPayments)||void 0===e?void 0:e.length)>0)for(const e of this.model.failedPayments)e.paymentTimer>0&&(this.nonExpiredPayments.push(e),e.verificationRequired&&o.push(e));this.nonExpiredPayments.length>0&&(this.failedPaymentTimer=setInterval((()=>{var e;this.nonExpiredPayments=this.nonExpiredPayments.filter((e=>e.paymentTimer>0));const t=[];for(const e of this.nonExpiredPayments)if($.observable(e,t).setProperty({paymentTimer:e.calcPaymentTime()}),e.canCancel&&0==e.paymentTimer){$.observable(e,t).setProperty({canCancel:!1});for(const s of e.products)$.observable(s,t).setProperty({canCancel:!1})}null===(e=t.trigger)||void 0===e||e.call(t),0==this.nonExpiredPayments.length&&clearInterval(this.failedPaymentTimer)}),6e4));const r=localStorage.getObject("wbwallet_upgrade_requested");r&&$.observable(this).setProperty({requestedWalletUpgrade:!0}),(o.length>0||this.requestedWalletUpgrade)&&(await this._loadWalletInfo(),this.isWalletUpgraded=this.walletInfo.isVerified&&1===this.walletInfo.walletState,this.isWalletUpgraded&&!wb.global.userSettings.closed.includes("upgrade_wallet_alert_closed")&&this.saveWalletAlertStateToLs());const l=new Date;(this.requestedWalletUpgrade&&l.getTime()>r.expirationTime||this.isWalletUpgraded)&&localStorage.removeItem("wbwallet_upgrade_requested");const d=this.$moduleLoader,c=this.$httpClient;let h={};$.views.helpers({showSurvey:function(e,s){let i=s.view.parent.parent.data;s.view.ctxPrm("rating",this),s.view.ctxPrm("isTouched",!1),i.survey||(h[i.surveyType]||(h[i.surveyType]=c.fetchJSON(`/webapi/lk/getsurvey/${i.surveyType}`,{},{noProcessResponse:!0})),h[i.surveyType].then((async e=>{let s=null;if("Courier"!=i.deliveryWay){s=new((await d.loadModuleAsync("imageUploader")).ImageUploader)({maxItemsCount:4,useCropper:!0,uploadLimit:10485760,requalitySizeLimit:5242880})}$.observable(i).setProperty("survey",new t(e,s))})).catch((()=>{wb.popup.renderModalError("<h2>Не получилось оценить </h2><p>Попробуйте ещё раз</p>","popup-rate-error-message","Закрыть",!0,!0),h[i.surveyType]=null})))},sendSurvey:function(e,t){var s;if(t.view.ctxPrm("isTouched",!0),t.view.tag&&!t.view.tag.isValid)return;var i=t.view.parent.parent.data;if(i.isSubmiting)return;i.isSubmiting=!0;const n=new FormData(t.linkCtx.elem.form);return n.append("recordId",i.id),(null===(s=i.survey.imageUploader)||void 0===s?void 0:s.files.length)>0&&i.survey.imageUploader.files.forEach(((e,t)=>{n.append("files",e)})),c.fetchJSON("/webapi/lk/myorders/survey",{method:"POST",body:n}).then((()=>$.observable(i).setProperty("surveySent",!0))).catch((e=>{i.isSubmiting=!1,wb.popup.renderModalError(e)})),!1},showCommunication:()=>{d.loadModuleAsync("communicationCreatorSpa").then((e=>{new e(e.data,e.template,(()=>{this.$router.moveTo(e.data.communicationPageLink)})).showCommunicationPopup()}))}},$.templates.needEvaluateBottomBlock),this._onChatInited=this._onChatInited.bind(this),this._onToggleSellersSwitcher=this._onToggleSellersSwitcher.bind(this),this.model.chatSuppliers=[],(null===(i=null===(s=wb.global.settings)||void 0===s?void 0:s.switches)||void 0===i?void 0:i.enableSellersChat)&&null!=(null===(a=null===(n=wb.spa.getMainLayout())||void 0===n?void 0:n.header)||void 0===a?void 0:a.onlineChat)&&this._onChatInited()},s.onAfterRender=function(){var e,t,s;if(null!=this.model.paymentUrl){const e=new URL(window.location.href);e.searchParams.delete("paymentUrl"),window.history.replaceState(window.history.state,document.title,e.toString()),window.location.replace(this.model.paymentUrl)}let i=new URLSearchParams(location.search);if(i.has("failReason"))return wb.popup.renderModalError("Ошибка при оплате долга!"),void window.history.replaceState({},"",location.pathname);if("true"==(null===(e=i.get("paymentSuccess"))||void 0===e?void 0:e.toLowerCase())&&(wb.popup.renderModalError("Оплата прошла успешно"),window.history.replaceState({},"",location.pathname)),!this.chatEnabled&&(null===(s=null===(t=wb.global.settings)||void 0===t?void 0:t.switches)||void 0===s?void 0:s.enableSellersChat)&&this.$eventBus.addEventListener("OnlineChatStarted",this._onChatInited),this.$eventBus.addEventListener("SellersChatSwitched",this._onToggleSellersSwitcher),this.nonExpiredPayments.length>0)for(const e of this.nonExpiredPayments)2!==e.mpmPaymentStatus&&this._updateFailedOrdersPaymentStatus(e);this.$eventBus.addEventListener("BalanceUpdated",this._updateBalance.bind(this),{single:!0}),this.$eventBus.addEventListener("BankCardsUpdated",this._updateBankCards.bind(this),{single:!0}),this._getCatalogInfo(),Promise.all([this.$httpClient.fetchJSON("/webapi/lk/myorders/delivery/foreval",{method:"POST"}),this.$httpClient.fetchJSON("/webapi/lk/myorders/goods/notevaluated?limit=100",{method:"POST"})]).then((async([e,t])=>{var s;if((null==t?void 0:t.length)>0||(null==e?void 0:e.length)>0){let i={deliveriesToEval:e};if(await wb.xnm.fillFeedbacksPaymentByUser(t),t.sort(((e,t)=>e.feedbacksPaymentInfo&&!t.feedbacksPaymentInfo?-1:t.feedbacksPaymentInfo&&!e.feedbacksPaymentInfo?1:0)),i.products=t,$.observable(this.model).setProperty({needEvaluate:i}),null===(s=location.hash)||void 0===s?void 0:s.startsWith("#rate")){const e=document.querySelector(`.delivery-block__content--review.j-rate-type-${location.hash.replace("#rate","")}`);null==e||e.scrollIntoView({behavior:"smooth",block:"start",inline:"start"})}window.addEventListener("resize",this.onResize),this._onResize(),this._handleEvalCarouselAnalytics()}else $.observable(this.model).setProperty({needEvaluate:""})})),window.requestIdleCallback((()=>{this.model.active.forEach((e=>e.products.forEach((e=>"PDL"===e.paymentType&&this.sendAnaliticBtn("Loan_Mark_S")))))}))},s._getCatalogInfo=async function(){const e=this.model.activePositions.groupBy((e=>e.code1S));if(!e||0==e.size)return;const t=await wb.xnm.getXnmProducts([...e.keys()]);e.forEach(((e,s)=>{const i=t[s];i&&i.supplier&&"wildberries"!=i.supplier.toLowerCase()&&"wb retail"!=i.supplier.toLowerCase()&&e.forEach((async e=>{var t;if(e.sellerId||$.observable(e).setProperty({sellerId:i.supplierId}),i.supplier)$.observable(e).setProperty({sellerName:i.supplier});else{const s=await this.getSellerName(null!==(t=e.sellerId)&&void 0!==t?t:i.supplierId);$.observable(e).setProperty({sellerName:s.name})}}))}))},s.getSellerName=async function(e){var t;const s=await WbSpaModel.prototype.$httpClient.fetchBasicJSON(`https://static-basket-01.wbbasket.ru/vol0/data/supplier-by-id/${e}.json`,{},{nullOnError:!0});return{id:s.supplierId,name:null!==(t=s.supplierName)&&void 0!==t?t:s.supplierFullName,ogrn:s.ogrn,ogrnip:s.ogrnip,taxpayerCode:s.taxpayerCode,inn:s.inn,kpp:s.kpp,unp:s.unp,bin:s.bin,unn:s.unn,trademark:s.trademark,legalAddress:s.legalAddress,isUnknown:!1,orgForms:s.orgForms}},s._updateBalance=function(e){null==this||this._setBalance(e.detail)},s._updateBankCards=function(e){null==this||this._setBankCards(e.detail)},s._setBalance=function(e){if(!e)return;const t=e&&"RUB"===this.$user.getCurrency();this.$observable?this.asObservable(this.model)[this.model.signedBalance?"setAllProperty":"setProperty"]({signedBalance:e,showBalance:t}):(this.model.signedBalance=e,this.model.showBalance=t)},s._setBankCards=function(e){this.model.active.forEach((t=>t.setBankCards(e))),this.$observable?this.asObservable(this).setProperty({bankCardsReceived:!0}):this.bankCardsReceived=!0},s._loadWalletInfo=async function(){const e=await this.$moduleLoader.loadModuleAsync("wbWalletManager").then((e=>(this.walletManager=new e,this.walletManager.loadWalletInfo({updateStatus:!0})))).catch((()=>({loading:"error"})));$.observable(this).setProperty({walletInfo:e})},s.showAgreeTermsPopup=function(){this.$moduleLoader.loadModuleAsync("agreeTermsPopup").then((e=>e.showPopup({walletManager:this.walletManager})))},s.closeWalletUpgradeAlert=function(e){e.stopPropagation(),$.observable(this).setProperty({isUpgradeWalletAlertClosed:!0}),wb.global.userSettings.closed.includes("upgrade_wallet_alert_closed")||this.saveWalletAlertStateToLs()},s.saveWalletAlertStateToLs=function(){wb.global.userSettings.closed.push("upgrade_wallet_alert_closed"),wb.global.saveUserSettings()},s.reloadPage=function(){window.location.reload()},s._onResize=function(){var e,t;const s=[];null===(e=document.querySelectorAll(".delivery-block__list--rating"))||void 0===e||e.forEach((e=>{var t;const i=$.view(e);if(null===(t=i.data)||void 0===t?void 0:t.toggledMore)return;const n=e.offsetWidth,a=e.querySelector(".delivery-block__item");if(!a)return;const o=Math.floor(n/(a.offsetWidth+16));$.observable(i.data,s).setProperty({visibleItems:2*o})})),null===(t=s.trigger)||void 0===t||t.call(s)},s._handleEvalCarouselAnalytics=function(){var e;const t=document.querySelector(".j-eval-carousel"),s=null===(e=null==t?void 0:t.querySelectorAll(".j-archive-observe"))||void 0===e?void 0:e.toArray();this.observer=new IntersectionObserver(((e,t)=>{e.forEach((e=>{e.isIntersecting&&(t.unobserve(e.target),this._sendViewItemEcEvent(e.target,"DRE"))}))}),{threshold:.5}),null==s||s.forEach((e=>{this.observer.observe(e)})),null==s||s.forEach(((e,t)=>{e.addEventListener("click",(()=>{this.$analitic.proceedAndSave("DRE",t+1)}))}))},s._sendViewItemEcEvent=function(e,t){var s,i;const{data:n}=$.view(e),a=document.querySelector(".j-eval-carousel"),o=(null===(s=null==a?void 0:a.querySelectorAll(".j-archive-observe"))||void 0===s?void 0:s.toArray()).indexOf(e),r=[{id:null===(i=n.code1S)||void 0===i?void 0:i.toString(),name:n.name,brand:n.brand,price:n.price,inListIndex:o+1,listName:`${t}|||||||`,subjectId:n.subjectId,subjectParentId:n.subjectParentId,feedbacksCount:n.feedbacks,rating:n.reviewRating,affiliation:n.supplierId,storeId:n.fastestStore,logs:n.logs,tailObject:this.$analitic.getTailObjectFromAnalyticsInfo({l:t})}];this.$analitic.sendWbaEcomStat("view_item_in_list",r)},s.onBeforeUnrender=function(){var e,t;document.removeEventListener("click",this),this.$eventBus.removeEventListener("BalanceUpdated",this._updateBalance),this.$eventBus.removeEventListener("BankCardsUpdated",this._updateBankCards),this.$eventBus.removeEventListener("OnlineChatInited",this._onChatInited),this.$eventBus.removeEventListener("SellersChatSwitched",this._onToggleSellersSwitcher),window.removeEventListener("resize",this.onResize),clearInterval(this.failedPaymentTimer),null===(e=this.trackingController)||void 0===e||e.abort(),null===(t=this.observer)||void 0===t||t.disconnect()},s.getScreenName=function(){return"Delivery"},s.openProductPopup=function(e,t){if(e.target.classList.contains("j-non-refundable")||e.target.classList.contains("rate-star__item")||e.target.classList.contains("j-paid-refusal"))return;const{data:s}=$.view(e.target);this.$productCardPopup.show(s.code1S,s.characteristicId)},s.openCommentPopup=function(e,t){const s=$.view(e.target),i=s.data,n=s.ctxPrm("product");if(n.rating)return!1;const a={location:"Delivery",item_id:n.code1S};this.$analitic.sendEvent("Item_Feedback_GiveFeedback_T",a);const o={imtId:n.imtId,nmId:n.code1S,goodName:n.name,brandName:n.brand,adult:n.isAdult,sellerId:n.sellerId,feedbacksPaymentInfo:n.feedbacksPaymentInfo},r={selectedCod1S:{value:n.code1S},selectedSizeName:{value:n.size},selectedRating:i,onSubmit:()=>{var e,t;let i=s.ctxPrm("delivery");$.observable(i.products).remove(s.ctxPrm("productIndex")),null==this.model.needEvaluate||(null===(e=this.model.needEvaluate.products)||void 0===e?void 0:e.length)||(null===(t=this.model.needEvaluate.deliveriesToEval)||void 0===t?void 0:t.length)||this.asObservable(this.model).setProperty({needEvaluate:""})},onError:e=>wb.popup.showFeedbackError(e)};return Promise.all([this.$moduleLoader.loadServiceAsync("feedbacksService")]).then((()=>{this.$services.feedbacksService.showFeedbacksPopup(o,r,a)}))},s.showMoreItems=function(e,t){e.toggledMore=!0,$.observable(e).removeProperty("visibleItems")},s.showInstallmentDetailsPopup=function(e="",t=null){null==t||t.stopPropagation();const s=this.model.active.reduce(((t,s)=>(t.push(...s.products.filter((t=>t.orderId===e))),t)),[]);(async()=>{if(!this._installmentHelper){const e=await this.$moduleLoader.loadModuleAsync("installmentChart");this._installmentHelper=(new e).init()}await this._installmentHelper.loadPaymentPlansInfo(s),this._installmentHelper.showPlanDetailsPopup(e)})()},s.showCustomChargesPopup=function(e){e.stopPropagation();const t=$.view(e.target).data;WbSpaModel.prototype.$moduleLoader.loadModuleAsync("customChargesPopup").then((e=>{this.customChargesPopup=new e(e.template,t.customsFeeAmount,t.currency),this.customChargesPopup.showPopup()}))},s.showComInstallmentDetailsPopup=function(e="",t=null){null==t||t.stopPropagation();const s=this.model.active.reduce(((t,s)=>(t.push(...s.products.filter((t=>t.orderId===e))),t)),[]);(this.model.failedPayments||[]).reduce(((t,s)=>(t.push(...s.products.filter((t=>t.orderId===e))),t)),s);(async()=>{if(!this._comInstallmentHelper){const e=await this.$moduleLoader.loadModuleAsync("commissionInstallmentChart");this._comInstallmentHelper=(new e).init()}await this._comInstallmentHelper.loadPaymentPlansInfo(s),this._comInstallmentHelper.showPlanDetailsPopup(e),this.sendAnaliticBtn("Loan_Mark_T")})()},s.sendAnaliticBtn=function(e,t="loan"){const s={location:"delivery",type:t};this.$analitic.sendEvent(e,s)},s.showFeedbacksForPointsPopup=function(e){e.stopPropagation(),this.$moduleLoader.loadModuleAsync("feedbacksForPointsPopup").then((e=>{this.feedbacksForPointsPopup=new e(e.template),this.feedbacksForPointsPopup.showFeedbacksForPointsPopup()}))},s._updateFailedOrdersPaymentStatus=async function(e){const t=await this.$getService("orderService").then((t=>t.checkRidsPaymentStatus(e.products.map((e=>e.rId)))));if(this.asObservable(e).setProperty({mpmPaymentStatus:t.status}),2!==t.status)return;const s=e.products.toMap((e=>e.rId),(t=>(t.mpmPaymentStatus=e.mpmPaymentStatus,t)));s.size>0&&this.$getService("groupedDeliveriesService").then((e=>e.updateItems(null,null,s)))},s._onToggleSellersSwitcher=function(e){const t=e.detail;$.observable(this.model).setProperty("chatEnabled",t)},s._onChatInited=function(){$.observable(this.model).setProperty("chatEnabled",!0)},e}(),t=function(){function e(e,t){if(this.ratings={},this.questions={},this.type=e.surveyType,this.imageUploader=t,e&&0!=e.length){var[i,...n]=e.questions;i.index=0,i.answers.forEach((e=>{this.ratings[e.text]=e.id})),n.map(((e,t)=>{e.dependsOnAnswers&&e.dependsOnAnswers.forEach((i=>{e.index=t+1,this.questions[i]?this.questions[i].addQuestion(e):this.questions[i]=new s(e)}))})),Object.entries(this.questions).forEach((([e,t])=>{t.prependQuestion(i,e)}))}}return e.prototype.getQuestion=function(e){return this.questions[this.ratings[e]]},e}(),s=function(){function e(e){this.index=e.index,this.innerQuestions=[],this.answers=[],this.text=e.text,this.showDiscussion=e.showDiscussion,this.addQuestion(e)}var t=e.prototype;return t.addQuestion=function(e){this.innerQuestions.push({index:e.index,id:e.id,type:e.type}),this.answers.push(...e.answers.map((t=>new i(e,t))))},t.prependQuestion=function(e,t){this.innerQuestions.unshift({index:e.index,id:e.id,type:e.type});const s=e.answers.find((e=>e.id==t));s&&this.answers.unshift(new i(e,s))},e}(),i=function(){function e(e,t){this.id=t.id,this.firstId=e.answers[0].id,this.parentIndex=e.index,this.text=t.text,this.isRequired=t.isRequired,this.isCustomAnswer=t.isCustomAnswer,this.isStar=t.isStar,this.isStar||(t.isCustomAnswer?(this.text||(this.text=e.text,this.showDiscussion=e.showDiscussion),this.type="1"==e.type?"multicustom":"custom"):"-"==t.text[0]?(this.type="title",this.text=this.text.substring(1).trim(),this.showDiscussion=e.showDiscussion):"1"==e.type?this.type="multi":"0"==e.type&&(this.type="single"))}var t=e.prototype;return t.hiddenName=function(e,t){return t?`Item.Questions[${this.parentIndex}].Answers.${e}`:`Item.Questions[${this.parentIndex}].Answers[${this.id}].${e}`},t.hiddenFirstName=function(e){return`Item.Questions[${this.parentIndex}].Answers[${this.firstId}].${e}`},e}();wb.spa.registerViewModel(e)})();
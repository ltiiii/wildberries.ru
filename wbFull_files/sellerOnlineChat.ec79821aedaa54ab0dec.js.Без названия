(()=>{"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(e){var s=function(e,s){if("object"!=t(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,s||"default");if("object"!=t(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===s?String:Number)(e)}(e,"string");return"symbol"==t(s)?s:s+""}function s(t,s){for(var i=0;i<s.length;i++){var n=s[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,e(n.key),n)}}function i(t,e){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},i(t,e)}function n(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,i(t,e)}const r=/^((https:\/\/chat-basket-0\d.)wb(.ru\/.*))$/;const a=function(){function t({ctx:t,message:e,attachment:s,messageIndex:i,attachmentIndex:n,imgCounter:a}){this.parentIndex=i,this.index=n;const{url:o,name:h,size:c}=s;this.url=null==o?void 0:o.replace(r,"$2wbbasket$3"),this.name=h,this.size=c,(null==e?void 0:e.dt)&&(this.dt=e.dt),this.ctx=t,this.imgCounter=a}var e=t.prototype;return e.goToMessage=function(t,e){if(t.preventDefault(),t.stopPropagation(),Number.isInteger(this.parentIndex)){$.observable(this.ctx).setProperty({isTabsOpen:!1}),this.ctx.closeSlider();const t=this.ctx.chat.querySelector(`.chat__message:nth-last-of-type(${this.parentIndex})`);t&&t.scrollIntoView()}},e.download=function(t,e){if(t.preventDefault(),!this.url)return;window.navigator&&window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveOrOpenBlob(blob,data.fileName);const s=(t,e)=>{const s=document.createElement("a");s.href=t,s.download=this.name||wb.helpers.path.fileName(this.url),s.onclick=t=>t.stopPropagation(),s.target="_blank",document.body.appendChild(s),s.click(),setTimeout((()=>{document.body.removeChild(s),e&&URL.revokeObjectURL(t)}),200)};return fetch(this.url).then((async t=>{const e=await t.blob();if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,data.fileName);else{const t=URL.createObjectURL(e);s(t,!0)}})).catch((()=>s(this.url,!1))),!1},t}();const o=function(){function t(t,e,s){var i,n,r,o;function h(t,e,s){let i=t.get(e);i||(i=[],t.set(e,i)),i.push(s)}let c;this.groupedFiles=new Map,this.groupedImages=new Map,this.groupedLinks=new Map,this.images=[],this.ctx=e,this.hasLastMessageFromEmployer=!1;const l=new Map;$.observable(s).setProperty("notification",""),clearTimeout(s.timerForNotification);let d=[];[...t].forEach(((t,e)=>{const i=`${t.dt.getFullYear()}-${t.dt.getMonth()}`;let n=l.get(i);n||(n=new Date(t.dt),n.setHours(0,0,0,0),n.setDate(1),l.set(i,n));const r=e+1;if(!this.hasLastMessageFromEmployer&&(null==t?void 0:t.sender)&&(this.hasLastMessageFromEmployer=!0,t.toOperator)){const e={wait:"Оператор скоро подключится и поможет вам",apologize:"Извините, пока что все операторы заняты. Как только кто-то освободится, сразу напишем вам"},i=9e5-(new Date-new Date(t.dt));i>0?($.observable(s).setProperty("notification",e.wait),s.timerForNotification=setTimeout((()=>{$.observable(s).setProperty("notification",e.apologize),clearTimeout(s.timerForNotification)}),i)):$.observable(s).setProperty("notification",e.apologize)}t.hasFile()&&h(this.groupedFiles,n,{message:t,reverseIndex:r}),t.hasImage()&&(h(this.groupedImages,n,{message:t,reverseIndex:r}),this.images.push({message:t,reverseIndex:r}),t.images&&(c=t.images[t.images.length-1].imgCounter)),t.hasUrl()&&h(this.groupedLinks,n,{message:t,reverseIndex:r}),t.payload&&d.push(t)})),c||(c={counter:0});for(let t=this.images.length-1;t>=0;t--){const e=this.images[t].message;e.images||(e.images=null===(i=e.attachments)||void 0===i?void 0:i.images.map((t=>new a({message:e,attachment:t,imgCounter:c,attachmentIndex:c.counter++}))))}const u=[];d.forEach(((t,e)=>$.observable(t,u).setProperty("lastFromBot",0==e))),(null===(r=null===(n=d[0])||void 0===n?void 0:n.payload)||void 0===r?void 0:r.showProducts)&&this.ctx.loadMessageProducts(),null===(o=u.trigger)||void 0===o||o.call(u)}var e=t.prototype;return e.get=function(t="m"){return[...this._get(t)]},e.getImages=function(){return[...this._getAttachments(this.images,"m")]},e.isNotEmpty=function(){return this.groupedFiles.size+this.groupedImages.size+this.groupedLinks.size>0},e._getAttachments=function*(t,e){let s=0;let i={m:"images",d:"files",l:"urls"}[e];for(const{message:e,reverseIndex:n}of t){const t=e.attachments[i];for(const r of[...this._reverseArray(t)])yield new a({message:e,attachment:r,messageIndex:n,attachmentIndex:s++,ctx:this.ctx,attachmentType:i})}},e._reverseArray=function*(t){for(let e=t.length-1;e>=0;e--)yield t[e]},e._get=function*(t){if("m"!=t&&"d"!=t&&"l"!=t)throw new Error("wrong filter");const e={m:this.groupedImages,d:this.groupedFiles,l:this.groupedLinks};for(const[s,i]of e[t])yield{dt:s,attachments:[...this._getAttachments(i,t)]}},t}();function h(t){return h=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},h(t)}function c(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(c=function(){return!!t})()}function l(t){var e="function"==typeof Map?new Map:void 0;return l=function(t){if(null===t||!function(t){try{return-1!==Function.toString.call(t).indexOf("[native code]")}catch(e){return"function"==typeof t}}(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,s)}function s(){return function(t,e,s){if(c())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,e);var r=new(t.bind.apply(t,n));return s&&i(r,s.prototype),r}(t,arguments,h(this).constructor)}return s.prototype=Object.create(t.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),i(s,t)},l(t)}const d=function(t){function e(e){return t.call(this,e)||this}return n(e,t),e}(l(Error)),u=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,g=$.templates("Возврат одобрен. Принесите товар в пункт выдачи, в котором его получали. {{if refundPrice > 0}}<b>{{priceWithCurrencyV2:refundPrice iso=currency}}</b>{{else}}Денежные средства{{/if}} вернутся после того, как товар поступит на склад. О возврате денег проинформируем уведомлением в личном кабинете."),p=$.templates("Ваша заявка на возврат {{if refundPrice > 0}}<b>{{priceWithCurrencyV2:refundPrice iso=currency}}</b>{{else}}денежных средств{{/if}} одобрена{{if currency == 'RUB'}}, деньги поступят на баланс{{/if}}"),f={message:new Set(["create"]),refund:new Map([["sellerRejectRefund",()=>"Возврат товара отклонен"],["sellerRequestRefund",()=>'Чтобы вернуть товар, найдите его в Покупках, нажмите <span class="message__dots"></span> и выберите Вернуть товар по&nbsp;браку'],["sellerAcceptFullRefund",t=>p.render(t)],["sellerAcceptRefundInOffice",t=>g.render(t)]])},m=[{id:1,name:"Слишком долго"},{id:2,name:"Мне не помогли"},{id:3,name:"Не нравится решение"},{id:4,name:"Невежливо"},{id:5,name:"Смена оператора"},{id:6,name:"Пришлось повторять"}],v=[{id:7,name:"Медленно"},{id:8,name:"Мало информации"},{id:3,name:"Не нравится решение"},{id:4,name:"Невежливо"},{id:5,name:"Смена оператора"},{id:6,name:"Пришлось повторять"}],y=[{id:9,name:"Всё быстро"},{id:10,name:"Мне помогли"},{id:11,name:"Дружелюбно"}],b=[{id:"operator-rating-negative",text:"Плохо",value:1,class:"rate-operator__item--negative"},{id:"operator-rating-neutral",text:"Нормально",value:2,class:"rate-operator__item--neutral"},{id:"operator-rating-positive",text:"Хорошо",value:3,class:"rate-operator__item--positive"}];const w=function(){function t({id:t,chatId:e,text:s="",dt:i=new Date,inbox:n=!1,attachments:r,type:a="message",action:o,body:h,rating:c,translated:l,locale:d,uniqueId:u,isNew:g,to_operator:p,employee_id:m}){t&&(this.id=t),e&&(this.chatId=e),this.text=s,this.translated=l,this.locale=d,this.dt=new Date(i),this.inbox=n,this.toOperator=p,this.employeeId=m,r&&(this.attachments=r),this.type=a,this.action=o,this.ogLanguageExpanded=!1,"refund"==a&&h&&f[a].has(o)&&(this.custom=!0,this.text=f[a].get(o)({refundPrice:h.price/100,currency:h.priceCurrency})),c&&(this.rating=c)}var e=t.prototype;return e.setUniqueId=function({id:t,create:e}){return e?this.uniqueId=wb.helpers.generateGuid():t&&(this.uniqueId=t),this},e.hasFile=function(){var t,e;return(null===(e=null===(t=this.attachments)||void 0===t?void 0:t.files)||void 0===e?void 0:e.length)>0},e.hasImage=function(){var t,e;return(null===(e=null===(t=this.attachments)||void 0===t?void 0:t.images)||void 0===e?void 0:e.length)>0},e.hasUrl=function(){var t,e;return(null===(e=null===(t=this.attachments)||void 0===t?void 0:t.urls)||void 0===e?void 0:e.length)>0},e.files=function(){var t;return null===(t=this.attachments)||void 0===t?void 0:t.files.map((t=>new a({attachment:t})))},e.urls=function(){var t;return null===(t=this.attachments)||void 0===t?void 0:t.urls.map((t=>new a({attachment:t})))},e.setId=function(t){return this.id=t,this},e.setDt=function(t){return this.dt=t?new Date(t):new Date,this},e.setSender=function({id:t,name:e,bot:s}){return t||e?(this.sender={id:t,name:e,bot:s},this):this},e.addImage=function({url:t,name:e,size:s,type:i,date:n}){return t?(this.attachments||(this.attachments={}),this.attachments.images||(this.attachments.images=[]),this.attachments.images.push({url:t,name:e,size:s,type:i,date:n}),this):this},e.addFile=function({url:t,name:e,size:s,type:i,date:n}){return t?(this.attachments||(this.attachments={}),this.attachments.images||(this.attachments.files=[]),this.attachments.files.push({url:t,name:e,size:s,type:i,date:n}),this):this},e.tryLinkify=function(t){if(!this.text)return this;const e=new Set;if(t){const t=(new DOMParser).parseFromString(this.text,"text/html"),s=t.body.getElementsByTagName("a");s.length>0&&(s.forEach((t=>{t.target="_blank",e.add(t.href),t.href=encodeURI(t.href)})),t.body.querySelectorAll(":not(a)").forEach((t=>t.outerHTML=t.innerText)),this.text=t.body.innerHTML,this.custom=!0)}return this.text=this.text.replace(u,(t=>e.has(t)?t:(this.attachments||(this.attachments={}),this.attachments.urls||(this.attachments.urls=[]),this.attachments.urls.push({url:t}),""))),this},e.addPayload=function(t){var e;return this.payload=null===(e=null==t?void 0:t.interface_command)||void 0===e?void 0:e.reduce(((t,e)=>{var s,i,n,r,a;switch(e.type){case"TEXT":this.text=(null===(s=e.values[0])||void 0===s?void 0:s.text)||"";break;case"SHOW_PRODUCTS_LIST":t.showProducts=null!==(n=null===(i=e.values[0])||void 0===i?void 0:i.show)&&void 0!==n&&n;break;case"MENU":t.buttons=(null===(r=e.values)||void 0===r?void 0:r.map((t=>Object.assign(Object.assign({},t),{name:t.name.replace(/[<>]/g,"").trim()}))))||[];break;case"NAVIGATIONS":t.navigation=(null===(a=e.values)||void 0===a?void 0:a.map((t=>Object.assign(Object.assign({},t),{name:t.name.replace(/[<>]/g,"").trim()}))))||[]}return t}),{}),this},e.addSentActions=function(t){return this.inbox||((null==t?void 0:t.choose_product)?(this.text="Вопрос о товаре",t.choose_product.nmId>0&&(this.sentProduct=t.choose_product)):(null==t?void 0:t.choose_button)&&(this.text=t.choose_button.text)),this},e.addRateMessage=function(t,e){return t?(this.inbox=!this.rating,this.rateChat=!0,this.chatRated=this.rating>0,this.ratingButtonsSelected=[]):e&&(this.inbox=!this.rating,this.rateOperator=!0,this.operatorRating=this.rating,this.operatorRated=this.rating>0),this},e.getBy=function(t){return t?t<3?m:t>3?y:v:[]},e.getOperatorRatingButtons=function(){return b},e.expandOgLanguage=function(){$.observable(this).setProperty({ogLanguageExpanded:!this.ogLanguageExpanded})},t.createFromWbChat=function({message_id:t,msg_text:e,image_url:s,file_url:i,dt:n,is_inside:r,employee_id:a,employee_first_name:o,rate:h,to_operator:c,bot_payload:l,actions:d,rate_chat:u,rate_employee:g,idempotency_key:p}={}){return new this({id:t,text:e,dt:n,inbox:r,rating:h,rateChatAnswer:u,rateEmployee:g,to_operator:c}).setUniqueId({id:p}).addFile({url:i}).addImage({url:s}).setSender({id:a,name:o,bot:!!l||null}).tryLinkify(!0).addPayload(l).addSentActions(d).addRateMessage(u,g)},t.createFromEvent=function(t){var e,s,i;const n=t[t.eventType];if(!f[t.eventType]||!(null===(e=f[t.eventType])||void 0===e?void 0:e.has(null==n?void 0:n.actionType)))return null;const r=new this({chatId:t.chatID,type:t.eventType,action:n.actionType,body:n,text:null==n?void 0:n.text,translated:null==n?void 0:n.translated,locale:null==n?void 0:n.locale,attachments:Object.assign({},null==n?void 0:n.attachments),dt:new Date(t.addTime||t.clientCreatedAt),inbox:"seller"==(null===(s=t.sender)||void 0===s?void 0:s.type)||"wb"==(null===(i=t.sender)||void 0===i?void 0:i.type)}).tryLinkify();return"message"!=t.eventType&&r.setSender({name:"Бот Wildberries",bot:!0}),r},t.createBotMessage=function({chatID:t,dt:e}){const s=new this({chatId:t,text:"Ожидайте ответа продавца",dt:e,inbox:!0});return s.setSender({name:"Бот Wildberries",bot:!0}),s},t}();let x=function(t="",e,{isImage:s=!0}={}){this.mime=t,this.extensions=[].concat(e),this.isImage=s};const I=new x("image/jpg",["jpg","jpeg"]),P=Object.freeze({ffd8ffe0:I,ffd8ffe1:I,ffd8ffe2:I,ffd8ffe3:I,ffd8ffe8:I,"89504e47":new x("image/png","png"),25504446:new x("application/pdf","pdf",{isImage:!1})});let S=function(t){function e({chatId:e,sign:s,sellerId:i,sellerName:n,chatService:r,ctx:a,storageService:o}={}){var h;return(h=t.call(this)||this).chatService=r,h.storageService=o,h.ctx=a,h.chatId=e,h.sign=s,h.sellerId=i,h.name=`seller_${i}_${e}`,h.title=h.sellerName=n,h}n(e,t);var i,r,a,o=e.prototype;return o.sendMessage=async function(t){var e,s;if(!(null===(s=null===(e=wb.global.settings)||void 0===e?void 0:e.switches)||void 0===s?void 0:s.enableSellersChat))throw new d("Чат временно отключен, производятся технические работы");const i={chatId:this.chatId,sellerId:this.sellerId,sellerName:this.sellerName,sign:this.sign,text:t};try{const{userInfo:t}=await this.ctx.$services.userData.getUserDataAsync()||{};t.firstName&&(i.sender={name:t.firstName})}catch(t){console.error(t)}this.goodCard&&(i.attachments={goodCard:this.goodCard});const n=new w({chatId:this.chatId,text:t,attachments:i.attachments}).tryLinkify();try{const{addTime:e,chatID:s,sign:r,tryAsNew:a,invalidSignature:o,event:h}=await this.chatService.sendEvent(i)||{};if(a)return this.chatId=null,this.sendMessage(t);if(o&&this.local)return this.chatId=null,this.sendMessage(t);if(!e||!s)throw new d("Не удалось отправить сообщение");n.setDt(e),this.ctx.chat.dispatchEvent(new CustomEvent("sellerChat_sentMessage")),this.goodCard=null,this.chatId||(this.dirty=!0,this.chatId=s),h.chatID||(h.chatID=s),r&&!this.sign&&(this.dirty=!0,this.sign=r,h.sign=r),h.addTime=e,this.storageService.saveEvents(h)}catch(t){n.setDt(),n.unsent=i}return n},o.sendFile=async function(t,e){var s,i;if(!(null===(i=null===(s=wb.global.settings)||void 0===s?void 0:s.switches)||void 0===i?void 0:i.enableSellersChat))throw new d("Чат временно отключен, производятся технические работы");const n=await this.chatService.sendFile(t);if(!n.url)throw new d("Не удалось загрузить файл");const r={};e?r.images=[Object.assign({contentType:t.type},n)]:r.files=[Object.assign({contentType:t.type},n)];const a={chatId:this.chatId,sellerId:this.sellerId,sellerName:this.sellerName,sign:this.sign,attachments:r};try{const{userInfo:t}=await this.ctx.$services.userData.getUserDataAsync()||{};t.firstName&&(a.sender={name:t.firstName})}catch(t){console.error(t)}const o=new w({chatId:this.chatId});e?o.addImage(n):o.addFile(n);try{const{chatID:t,addTime:e,sign:s,event:i}=await this.chatService.sendEvent(a)||{};if(!e||!t)throw new d("Не удалось отправить сообщение");o.setDt(e),this.ctx.chat.dispatchEvent(new CustomEvent("sellerChat_sentMessage")),this.chatId||(this.dirty=!0,this.chatId=t),i.chatID||(i.chatID=t),s&&!this.sign&&(this.dirty=!0,this.sign=s,i.sign=s),i.addTime=e,this.storageService.saveEvents(i)}catch(t){o.setDt(),o.unsent=a}return o},o.resendMessage=async function(t){const e=$.view(t.target).data;$.observable(e).setProperty({sendingMessage:!0,errorMessage:!0,sending:!0});try{const{addTime:t,chatID:s,sign:i,tryAsNew:n,invalidSignature:r,event:a}=await this.chatService.sendEvent(e.unsent)||{};t&&(this.goodCard=null,this.chatId||(this.dirty=!0,this.chatId=s),a.chatID||(a.chatID=s),i&&!this.sign&&(this.dirty=!0,this.sign=i,a.sign=i),a.addTime=t,this.storageService.saveEvents(a),$.observable(e).removeProperty("unsent"),$.observable(e).removeProperty("sending"))}catch(t){$.observable(e).setProperty({sendingMessage:!1,errorMessage:!0,sending:!1}),console.log(t)}},i=e,(r=[{key:"template",get:function(){return $.templates.onlineChat}}])&&s(i.prototype,r),a&&s(i,a),Object.defineProperty(i,"prototype",{writable:!1}),i}(function(){function t(){this.unreadCount=0,this.uploading=!1,this.uploadingImg=!1,this.tooltipTag=!!$.views.tags.tooltip,this.history=[],this.timerForNotification=null,this.onSubmit=this.onSubmit.bind(this),this.onFileChange=this.onFileChange.bind(this),this.beginSearch=this.$helper.debounce(this.beginSearch.bind(this),500),this.lastMessage.depends="history.length",$.observe(this,"history.length","maxSeen",((t,e)=>{let s=0;if(this.maxSeen&&!Number.isNaN(this.maxSeen))for(const t of this.reverseHistory()){if(+t.dt<=this.maxSeen)break;t.inbox&&s++}$.observable(this).setProperty({unreadCount:s})})),this.foundPatterns=[],this.searchIndex=0,this.maxSeen=0;const t=()=>new o([...this.reverseHistory()],this.ctx,this);Object.defineProperty(this,"filteredWrapper",{get(){const e=t();return Object.defineProperty(this,"filteredWrapper",{value:e,writable:!0,configurable:!0}),e},configurable:!0,enumerable:!0}),$.observe(this,"history.length",((e,s)=>$.observable(this).setProperty({filteredWrapper:t()})))}var e=t.prototype;return e.reverseHistory=function*(){for(let t=this.history.length-1;t>=0;t--)yield this.history[t]},e.init=function(t,e){return this.chat=e,this},e.stopChat=function(){this.currentPoll&&this.currentPoll.abort(),clearTimeout(this.pollId),this.currentPoll=null},e.scrollToBottom=function(){var t;const e=null===(t=this.chat)||void 0===t?void 0:t.querySelector(".j-chat-body");e&&(e.scrollTop=e.scrollHeight-e.clientHeight)},e.visit=function({dt:t,observe:e}){e?$.observable(this).setProperty({maxSeen:+t}):this.maxSeen=+t,this.storageService.updateMaxSeen({chatID:this.chatId,ts:+t})},e.sendMessage=async function(t){return{}},e.sendFile=async function(){},e.lastMessage=function(){return this.history[this.history.length-1]},e.onInput=function(t){t.target.style.height="auto";const e=t.target.scrollHeight;t.target.style.height=e+"px"},e.onSubmit=function(){if(!this.text||0===this.text.trim().length)return!1;const t=$.views.helpers.stripHtml(this.text),e=document.querySelector(".j-chat-textarea");return this.chat.querySelector(".j-fake-for-focus").focus(),$.observable(this).setProperty({uploading:!0}),this.$helper.debounce(this.sendMessage(t).then((t=>{var s,i,n;t?(this._refreshHistory([t]),this.visit({dt:+t.dt}),(null===(i=null===(s=t.attachments)||void 0===s?void 0:s.goodCard)||void 0===i?void 0:i.needRefund)&&setTimeout((()=>{const t=w.createBotMessage({chatID:this.chatID});this._refreshHistory([t]),this.visit({dt:Date.now()})}),500),null===(n=this.afterSubmit)||void 0===n||n.call(this),this.afterSubmit=null):this.visit({dt:Date.now()}),$.observable(this).setProperty({text:""}),e.style.height="auto",$.observable(this).removeProperty("onTop")})).catch((t=>{console.error("[Online Chat]:",t)})).finally((()=>{$.observable(this).setProperty({uploading:!1}),e.focus()})),100),!1},e.onKeyPress=function(t,e){13!==t.which||t.shiftKey||(t.target.form.dispatchEvent(new Event("submit",{cancelable:!0})),t.preventDefault())},e.onFileChange=function(t){$.observable(this).setProperty({uploading:!0});const e=t.currentTarget,s=e.files[0];return e.value="",this._onFileChangeAsync(s).then((t=>$.observable(this).removeProperty("onTop"))).finally((t=>{$.observable(this).setProperty({uploading:!1,uploadingImg:!1})}))},e.highlight=function(){var t;const e=this.parentElem||(null===(t=this.tag)||void 0===t?void 0:t.parentElem);e&&e.scrollIntoView({behavior:"smooth"})},e.unhighlight=function(t){t.target.classList.remove("blinking")},e.setSearching=function(t,e){$.observable(this).setProperty("searching",!0),$.observable(this).setProperty("searchingComplete",!1)},e.onSearchEnter=function(t,e){var s;return"Enter"==t.key&&(!(!this.searchingComplete&&!(null===(s=this.foundPatterns)||void 0===s?void 0:s.length))&&void this.goNextSearch())},e.beginSearch=function(t,e){var s;const i=[];$.observable(this.foundPatterns,i).refresh([]),$.observable(this,i).setProperty("searchIndex",0);const n=null===(s=t.target.value)||void 0===s?void 0:s.trim().replace(/[/\-\\^$*+?.()|[\]{}]/g,"\\$&");if($.observable(this).setProperty("searchText",n),n&&/[\wА-Яа-я]/.test(n)){const t=new RegExp(n,"ig");let e=0;for(const s of this.history)s.text&&t.test(s.text)?($.observable(s,i).setProperty("foundText",$.views.helpers.stripHtml(s.text).replace(t,(t=>`<span class="message__text-highlited">${t}</span>`))),$.observable(this.foundPatterns,i).insert(e)):$.observable(s,i).removeProperty("foundText"),e++;$.observable(this).setProperty("searchingComplete",!0),this.ctx.sendAnalytics("Purchases_Chat_Search_Send")}else{for(const t of this.history)$.observable(t,i).removeProperty("foundText");t.target.value||$.observable(this).setProperty("searchingComplete",!1)}i.trigger(),$.observable(this).setProperty("searching",!1)},e.clearSearch=function(t,e){t.stopPropagation();const s=[];$.observable(e.view.root.data,s).setProperty("searchText",""),$.observable(this.foundPatterns,s).refresh([]),$.observable(this,s).setProperty("searchIndex",0);for(const t of this.history)$.observable(t,s).removeProperty("foundText");s.trigger(),$.observable(this).setProperty("searchingComplete",!1),$.observable(this).setProperty("searchText","")},e.goPrevSearch=function(t){const e=this.searchIndex<=1?this.foundPatterns.length:this.searchIndex-1;1==this.searchIndex&&1==e&&$.observable(this).removeProperty("searchIndex"),$.observable(this).setProperty("searchIndex",e)},e.goNextSearch=function(t){const e=this.searchIndex>=this.foundPatterns.length?1:this.searchIndex+1;1==this.searchIndex&&1==e&&$.observable(this).removeProperty("searchIndex"),$.observable(this).setProperty("searchIndex",e)},e.isEmpty=function(t){return!t||""===t.trim()},e.downloadAttachment=function(t,e){$.view(t.target).data.download(t,e)},e._refreshHistory=function(t){if(!Array.isArray(t)||0==t.length)return;const e=this.history.reduce(((t,e)=>(e.uniqueId&&t.add(e.uniqueId),t)),new Set);e.size>0&&(t=t.filter((t=>!e.has(t.uniqueId)))),$.observable(this.history).insert(t),this.scrollToBottom()},e._onFileChangeAsync=async function(t){try{const{supported:e,isImg:s}=await this._getFileInfo(t);if(!e)return void wb.popup.renderModalError("Файл не поддерживается");if(this.ctx.chat.dispatchEvent(new CustomEvent("sellerChat_upload",{detail:{type:s?"media":"file",quantity:1}})),t.size>=10485760)return void wb.popup.renderModalError("Слишком большой файл");s&&($.observable(this).setProperty({uploadingImg:!0}),this.scrollToBottom());const i=await this.sendFile(t,s);i&&(this._refreshHistory([i]),this.visit({dt:+i.dt}))}catch(t){console.error(t);const e=t instanceof d?t.message:"Ошибка при отправке сообщения";wb.popup.renderModalError(e)}},e._getFileInfo=async function(t){const e=await this.$moduleLoader.loadModuleAsync("promisifiedFileReader"),s=await(new e).readAsArrayBuffer(t.slice(0,4)),i=new Uint8Array(s).reduce(((t,e)=>t+e.toString(16)),""),n=wb.helpers.path.extension(t.name),r=P[i];return(null==r?void 0:r.extensions.includes(n))?{supported:!0,isImg:r.isImage}:{supported:!1}},t}());window.__spaModuleManager__.register("sellerOnlineChat",S)})();